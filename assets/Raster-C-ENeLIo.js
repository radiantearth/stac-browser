import{ct as C}from"./index-B3F0456b.js";import{aH as E,B as T,E as A,bS as L,g as O,p as w,a$ as I,u as q,aB as b,aC as y,Y as v,as as _}from"./GeoJSON-BoRJWQIG.js";import{I as j}from"./ImageCanvas-DbugbF_5.js";import F from"./Image-CpWXyIXb.js";import M from"./Tile-CCJT7fVT.js";import S from"./Image-ByRyF10d.js";import{T as D}from"./Tile-BqAKaOfQ.js";import"./utils-BXWzvTjY.js";import"./_commonjsHelpers-CE1G-McA.js";import"./I18N-DlIXJTel.js";import"./BFormRadioGroup.vue_vue_type_script_setup_true_lang-DaMHx4U3-DO3czC2y.js";import"./useStateClass-BGbSLWFN-eI-Q6wqs.js";import"./ConditionalWrapper.vue_vue_type_script_lang-IX_NpHH--5aly-L7g.js";import"./ImageLayer-CRL1mPb1.js";import"./BaseImage-XMOuZW-1.js";import"./TileLayer-CTdsxez3.js";import"./DataTile-B4Zfc0sf.js";import"./Tile-Dd8tR1PC.js";import"./Tile-Bg7ozswn.js";import"./common-CLWpeXJR.js";import"./TileRange-2Tc-Ry00.js";import"./LRUCache-Cy7VNIXe.js";import"./tilecoord-DBpIeO-O.js";import"./BaseTile-DfxohS-w.js";import"./TileProperty-BF4LcWSy.js";import"./resolution-CU8ppKQ3.js";import"./common-9rOs42pz.js";import"./TileGrid-r8UQ2tK6.js";function k(o){return function(e){const t=e.buffers,s=e.meta,i=e.imageOps,n=e.width,a=e.height,r=t.length,l=t[0].byteLength;if(i){const u=new Array(r);for(let c=0;c<r;++c)u[c]=new ImageData(new Uint8ClampedArray(t[c]),n,a);return o(u,s).data.buffer}const h=new Uint8ClampedArray(l),p=new Array(r),d=new Array(r);for(let u=0;u<r;++u)p[u]=new Uint8ClampedArray(t[u]),d[u]=[0,0,0,0];for(let u=0;u<l;u+=4){for(let c=0;c<r;++c){const g=p[c];d[c][0]=g[u],d[c][1]=g[u+1],d[c][2]=g[u+2],d[c][3]=g[u+3]}const m=o(d,s);h[u]=m[0],h[u+1]=m[1],h[u+2]=m[2],h[u+3]=m[3]}return h.buffer}}function U(o,e){const s=Object.keys(o.lib||{}).map(function(n){return"const "+n+" = "+o.lib[n].toString()+";"}).concat(["const __minion__ = ("+k.toString()+")(",o.operation.toString(),");",'self.addEventListener("message", function(event) {',"  const buffer = __minion__(event.data);","  self.postMessage({buffer: buffer, meta: event.data.meta}, [buffer]);","});"]),i=new Worker(typeof Blob>"u"?"data:text/javascript;base64,"+C.from(s.join(`
`),"binary").toString("base64"):URL.createObjectURL(new Blob(s,{type:"text/javascript"})));return i.addEventListener("message",e),i}function B(o,e){const t=k(o.operation);let s=!1;return{postMessage:function(i){setTimeout(function(){s||e({data:{buffer:t(i),meta:i.meta}})},0)},terminate:function(){s=!0}}}class z extends E{constructor(e){super(),this.imageOps_=!!e.imageOps;let t;e.threads===0?t=0:this.imageOps_?t=1:t=e.threads||1;const s=new Array(t);if(t)for(let i=0;i<t;++i)s[i]=U(e,this.onWorkerMessage_.bind(this,i));else s[0]=B(e,this.onWorkerMessage_.bind(this,0));this.workers_=s,this.queue_=[],this.maxQueueLength_=e.queue||1/0,this.running_=0,this.dataLookup_={},this.job_=null}process(e,t,s){this.enqueue_({inputs:e,meta:t,callback:s}),this.dispatch_()}enqueue_(e){for(this.queue_.push(e);this.queue_.length>this.maxQueueLength_;)this.queue_.shift().callback(null,null)}dispatch_(){if(this.running_||this.queue_.length===0)return;const e=this.queue_.shift();this.job_=e;const t=e.inputs[0].width,s=e.inputs[0].height,i=e.inputs.map(function(l){return l.data.buffer}),n=this.workers_.length;if(this.running_=n,n===1){this.workers_[0].postMessage({buffers:i,meta:e.meta,imageOps:this.imageOps_,width:t,height:s},i);return}const a=e.inputs[0].data.length,r=4*Math.ceil(a/4/n);for(let l=0;l<n;++l){const h=l*r,p=[];for(let d=0,u=i.length;d<u;++d)p.push(i[d].slice(h,h+r));this.workers_[l].postMessage({buffers:p,meta:e.meta,imageOps:this.imageOps_,width:t,height:s},p)}}onWorkerMessage_(e,t){this.disposed||(this.dataLookup_[e]=t.data,--this.running_,this.running_===0&&this.resolveJob_())}resolveJob_(){const e=this.job_,t=this.workers_.length;let s,i;if(t===1)s=new Uint8ClampedArray(this.dataLookup_[0].buffer),i=this.dataLookup_[0].meta;else{const n=e.inputs[0].data.length;s=new Uint8ClampedArray(n),i=new Array(t);const a=4*Math.ceil(n/4/t);for(let r=0;r<t;++r){const l=this.dataLookup_[r].buffer,h=r*a;s.set(new Uint8ClampedArray(l),h),i[r]=this.dataLookup_[r].meta}}this.job_=null,this.dataLookup_={},e.callback(null,new ImageData(s,e.inputs[0].width,e.inputs[0].height),i),this.dispatch_()}disposeInternal(){for(let e=0;e<this.workers_.length;++e)this.workers_[e].terminate();this.workers_.length=0}}const x={BEFOREOPERATIONS:"beforeoperations",AFTEROPERATIONS:"afteroperations"};class R extends T{constructor(e,t,s){super(e),this.extent=t.extent,this.resolution=t.viewState.resolution/t.pixelRatio,this.data=s}}class W extends S{constructor(e){super({projection:null}),this.on,this.once,this.un,this.processor_=null,this.operationType_=e.operationType!==void 0?e.operationType:"pixel",this.threads_=e.threads!==void 0?e.threads:1,this.layers_=N(e.sources);const t=this.changed.bind(this);for(let s=0,i=this.layers_.length;s<i;++s)this.layers_[s].addEventListener(A.CHANGE,t);this.useResolutions_=e.resolutions!==null,this.tileQueue_=new L(function(){return 1},this.processSources_.bind(this)),this.requestedFrameState_,this.renderedImageCanvas_=null,this.renderedRevision_,this.frameState_={animate:!1,coordinateToPixelTransform:w(),declutter:null,extent:null,index:0,layerIndex:0,layerStatesArray:H(this.layers_),pixelRatio:1,pixelToCoordinateTransform:w(),postRenderFunctions:[],size:[0,0],tileQueue:this.tileQueue_,time:Date.now(),usedTiles:{},viewState:{rotation:0},viewHints:[],wantedTiles:{},mapId:O(this),renderTargets:{}},this.setAttributions(function(s){const i=[];for(let n=0,a=e.sources.length;n<a;++n){const r=e.sources[n],l=r instanceof I?r:r.getSource();if(!l)continue;const h=l.getAttributions()?.(s);typeof h=="string"?i.push(h):h!==void 0&&i.push(...h)}return i}),e.operation!==void 0&&this.setOperation(e.operation,e.lib)}setOperation(e,t){this.processor_&&this.processor_.dispose(),this.processor_=new z({operation:e,imageOps:this.operationType_==="image",queue:1,lib:t,threads:this.threads_}),this.changed()}updateFrameState_(e,t,s){const i=Object.assign({},this.frameState_);i.viewState=Object.assign({},i.viewState);const n=q(e);i.size[0]=Math.ceil(b(e)/t),i.size[1]=Math.ceil(y(e)/t),i.extent=[n[0]-i.size[0]*t/2,n[1]-i.size[1]*t/2,n[0]+i.size[0]*t/2,n[1]+i.size[1]*t/2],i.time=Date.now();const a=i.viewState;return a.center=n,a.projection=s,a.resolution=t,i}allSourcesReady_(){let e=!0,t;for(let s=0,i=this.layers_.length;s<i;++s)if(t=this.layers_[s].getSource(),!t||t.getState()!=="ready"){e=!1;break}return e}getImage(e,t,s,i){if(!this.allSourcesReady_())return null;this.tileQueue_.loadMoreTiles(16,16),t=this.findNearestResolution(t);const n=this.updateFrameState_(e,t,i);if(this.requestedFrameState_=n,this.renderedImageCanvas_){const a=this.renderedImageCanvas_.getResolution(),r=this.renderedImageCanvas_.getExtent();(t!==a||!v(n.extent,r))&&(this.renderedImageCanvas_=null)}return(!this.renderedImageCanvas_||this.getRevision()!==this.renderedRevision_)&&this.processSources_(),n.animate&&requestAnimationFrame(this.changed.bind(this)),this.renderedImageCanvas_}processSources_(){const e=this.requestedFrameState_,t=this.layers_.length,s=new Array(t);for(let n=0;n<t;++n){e.layerIndex=n,e.renderTargets={};const a=Q(this.layers_[n],e);if(a)s[n]=a;else return}const i={};this.dispatchEvent(new R(x.BEFOREOPERATIONS,e,i)),this.processor_.process(s,i,this.onWorkerComplete_.bind(this,e))}onWorkerComplete_(e,t,s,i){if(t||!s)return;const n=e.extent,a=e.viewState.resolution;if(a!==this.requestedFrameState_.viewState.resolution||!v(n,this.requestedFrameState_.extent))return;let r;if(this.renderedImageCanvas_)r=this.renderedImageCanvas_.getImage().getContext("2d");else{const l=Math.round(b(n)/a),h=Math.round(y(n)/a);r=_(l,h),this.renderedImageCanvas_=new j(n,a,1,r.canvas)}r.putImageData(s,0,0),e.animate?requestAnimationFrame(this.changed.bind(this)):this.changed(),this.renderedRevision_=this.getRevision(),this.dispatchEvent(new R(x.AFTEROPERATIONS,e,i))}getResolutions(e){if(!this.useResolutions_)return null;let t=super.getResolutions();if(!t)for(let s=0,i=this.layers_.length;s<i&&(t=this.layers_[s].getSource().getResolutions(e),!t);++s);return t}disposeInternal(){this.processor_&&this.processor_.dispose(),super.disposeInternal()}}W.prototype.dispose;let f=null;function Q(o,e){const t=o.getRenderer();if(!t)throw new Error("Unsupported layer type: "+o);if(!t.prepareFrame(e))return null;const s=e.size[0],i=e.size[1];if(s===0||i===0)return null;const n=t.renderFrame(e,null);let a;if(n instanceof HTMLCanvasElement)a=n;else{if(n&&(a=n.firstElementChild),!(a instanceof HTMLCanvasElement))throw new Error("Unsupported rendered element: "+a);if(a.width===s&&a.height===i)return a.getContext("2d").getImageData(0,0,s,i)}if(!f)f=_(s,i,void 0,{willReadFrequently:!0});else{const r=f.canvas;r.width!==s||r.height!==i?f=_(s,i,void 0,{willReadFrequently:!0}):f.clearRect(0,0,s,i)}return f.drawImage(a,0,0,s,i),f.getImageData(0,0,s,i)}function H(o){return o.map(function(e){return e.getLayerState()})}function N(o){const e=o.length,t=new Array(e);for(let s=0;s<e;++s)t[s]=P(o[s]);return t}function P(o){let e;return o instanceof I?o instanceof D?e=new M({source:o}):o instanceof S&&(e=new F({source:o})):e=o,e}export{z as Processor,R as RasterSourceEvent,W as default};
//# sourceMappingURL=Raster-C-ENeLIo.js.map
