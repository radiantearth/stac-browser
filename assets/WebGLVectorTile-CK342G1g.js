import{ae as M,p as o,E as p,c5 as c,o as u,m as g,v as L}from"./GeoJSON-BlyzYhKz.js";import{W as O,S}from"./RenderTarget-Fi-4iEgp.js";import{M as V,c as I,V as A}from"./VectorStyleRenderer-DZuyQVTl.js";import{c as k,f as l}from"./mat4-CeypvY8Z.js";import{B as F,a as T,b as B,S as d,r as x,t as D,E as U,p as P}from"./compileUtil-l9W4qAYP.js";import N from"./BaseTile-UnyspG_X.js";import"./index-4V-ffF_e.js";import"./utils-BXWzvTjY.js";import"./_commonjsHelpers-CE1G-McA.js";import"./I18N-DlIXJTel.js";import"./BFormRadioGroup.vue_vue_type_script_setup_true_lang-DaMHx4U3-CVtNDUBO.js";import"./useStateClass-BGbSLWFN-lMazZNQ7.js";import"./ConditionalWrapper.vue_vue_type_script_lang-IX_NpHH--B1-KiooU.js";import"./DataTile-uej8eNh4.js";import"./Tile-lMrQctYw.js";import"./Tile-BrHfHitc.js";import"./common-0gNrjJbx.js";import"./TileRange-2Tc-Ry00.js";import"./LRUCache-CwUIRQIv.js";import"./tilecoord-DYaQ6NdW.js";import"./TileProperty-BF4LcWSy.js";class v extends F{constructor(e,t){super(e),this.batch_=new V,this.styleRenderer_=t,this.buffers=null,this.maskVertices=new T(B,d),this.setTile(e.tile)}generateMaskBuffer_(){const e=this.tile.getSourceTiles()[0].extent;this.maskVertices.fromArray([e[0],e[1],e[2],e[1],e[2],e[3],e[0],e[3]]),this.helper.flushBufferData(this.maskVertices)}uploadTile(){this.generateMaskBuffer_(),this.batch_.clear();const e=this.tile.getSourceTiles(),t=e.reduce((n,_)=>n.concat(_.getFeatures()),[]);this.batch_.addFeatures(t);const s=e[0].extent[0],i=e[0].extent[1],a=M(o(),-s,-i);this.styleRenderer_.generateBuffers(this.batch_,a).then(n=>{this.buffers=n,this.setReady()})}disposeInternal(){if(this.buffers){const e=t=>{for(const s of t)s&&this.helper.deleteBuffer(s)};this.buffers.pointBuffers&&e(this.buffers.pointBuffers),this.buffers.lineStringBuffers&&e(this.buffers.lineStringBuffers),this.buffers.polygonBuffers&&e(this.buffers.polygonBuffers)}super.disposeInternal()}}const r={...D,TILE_MASK_TEXTURE:"u_depthMask",TILE_ZOOM_LEVEL:"u_tileZoomLevel"},C={POSITION:"a_position"};class G extends x{constructor(e,t){super(e,{cacheSize:t.cacheSize,uniforms:{[r.PATTERN_ORIGIN]:[0,0],[r.TILE_MASK_TEXTURE]:()=>this.tileMaskTarget_.getTexture()}}),this.hitDetectionEnabled_=!t.disableHitDetection,this.style_=null,this.styleVariables_=t.variables||{},this.styleRenderer_=null,this.currentFrameStateTransform_=o(),this.tmpTransform_=o(),this.tmpMat4_=k(),this.tileMaskTarget_=null,this.tileMaskIndices_=new T(U,d),this.tileMaskIndices_.fromArray([0,1,3,1,2,3]),this.tileMaskAttributes_=[{name:C.POSITION,size:2,type:P.FLOAT}],this.tileMaskProgram_,this.applyOptions_(t)}reset(e){super.reset(e),this.applyOptions_(e),this.helper&&(this.createRenderers_(),this.initTileMask_())}applyOptions_(e){this.style_=e.style}createRenderers_(){function e(s){const i=s.getFragmentDiscardExpression(),a=`texture2D(${r.TILE_MASK_TEXTURE}, gl_FragCoord.xy / u_pixelRatio / u_viewportSizePx).r * 50. > ${r.TILE_ZOOM_LEVEL} + 0.5`;s.setFragmentDiscardExpression(i!=="false"?`(${i}) || (${a})`:a),s.addUniform(r.TILE_MASK_TEXTURE,"sampler2D"),s.addUniform(r.TILE_ZOOM_LEVEL,"float")}const t=I(this.style_,this.styleVariables_);for(const s of t)e(s.builder);this.styleRenderer_=new A(t,this.styleVariables_,this.helper,this.hitDetectionEnabled_)}initTileMask_(){this.tileMaskTarget_=new O(this.helper);const e=new S().setFillColorExpression(`vec4(${r.TILE_ZOOM_LEVEL} / 50., 0., 0., 1.)`).addUniform(r.TILE_ZOOM_LEVEL,"float");this.tileMaskProgram_=this.helper.getProgram(e.getFillFragmentShader(),e.getFillVertexShader()),this.helper.flushBufferData(this.tileMaskIndices_)}afterHelperCreated(){this.createRenderers_(),this.initTileMask_()}createTileRepresentation(e){const t=new v(e,this.styleRenderer_),s=()=>{t.ready&&(this.getLayer().changed(),t.removeEventListener(p.CHANGE,s))};return t.addEventListener(p.CHANGE,s),t}beforeTilesRender(e,t){super.beforeTilesRender(e,!0),this.helper.makeProjectionTransform(e,this.currentFrameStateTransform_)}beforeTilesMaskRender(e){this.helper.makeProjectionTransform(e,this.currentFrameStateTransform_);const t=e.pixelRatio,s=e.size;return this.tileMaskTarget_.setSize([s[0]*t,s[1]*t]),this.helper.prepareDrawToRenderTarget(e,this.tileMaskTarget_,!0,!0),this.helper.useProgram(this.tileMaskProgram_,e),c(this.tmpTransform_,this.currentFrameStateTransform_),this.helper.setUniformMatrixValue(r.PROJECTION_MATRIX,l(this.tmpMat4_,this.tmpTransform_)),u(this.tmpTransform_,this.currentFrameStateTransform_),this.helper.setUniformMatrixValue(r.SCREEN_TO_WORLD_MATRIX,l(this.tmpMat4_,this.tmpTransform_)),!0}renderTileMask(e,t,s,i){if(!e.ready)return;this.helper.setUniformFloatValue(r.DEPTH,i),this.helper.setUniformFloatValue(r.TILE_ZOOM_LEVEL,t),this.helper.setUniformFloatVec4(r.RENDER_EXTENT,s),this.helper.setUniformFloatValue(r.GLOBAL_ALPHA,1),this.helper.bindBuffer(e.maskVertices),this.helper.bindBuffer(this.tileMaskIndices_),this.helper.enableAttributes(this.tileMaskAttributes_);const a=this.tileMaskIndices_.getSize();this.helper.drawElements(0,a)}applyUniforms_(e,t,s,i,a){c(this.tmpTransform_,this.currentFrameStateTransform_),g(this.tmpTransform_,s),this.helper.setUniformMatrixValue(r.PROJECTION_MATRIX,l(this.tmpMat4_,this.tmpTransform_)),u(this.tmpTransform_,this.currentFrameStateTransform_),this.helper.setUniformMatrixValue(r.SCREEN_TO_WORLD_MATRIX,l(this.tmpMat4_,this.tmpTransform_)),this.helper.setUniformFloatValue(r.GLOBAL_ALPHA,e),this.helper.setUniformFloatValue(r.DEPTH,a),this.helper.setUniformFloatValue(r.TILE_ZOOM_LEVEL,i),this.helper.setUniformFloatVec4(r.RENDER_EXTENT,t)}renderTile(e,t,s,i,a,n,_,m,E,w,y){const b=L(m,i,m),R=e.tile.getTileCoord()[0],h=e.buffers;h&&this.styleRenderer_.render(h,s,()=>{this.applyUniforms_(y,b,h.invertVerticesTransform,R,E)})}renderDeclutter(e){}disposeInternal(){super.disposeInternal()}}class oe extends N{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.style_=e.style,this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){return new G(this,{style:this.style_,variables:this.styleVariables_,disableHitDetection:this.hitDetectionDisabled_,cacheSize:this.getCacheSize()})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}setStyle(e){this.style_=e,this.clearRenderer(),this.changed()}}export{oe as default};
//# sourceMappingURL=WebGLVectorTile-CK342G1g.js.map
