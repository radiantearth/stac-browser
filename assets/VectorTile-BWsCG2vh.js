import{p as Y,U as D,g as F,f as M,W as H,G as $,v as J,X as k,Y as Q,Z as ee,_ as P,$ as te,a0 as re,R as oe,A as ne,a1 as ie,a2 as se,a3 as le,a4 as ce,a5 as z,a6 as ae,a7 as de,a8 as V,a9 as ue,m as ge,aa as U,ab as he,ac as B,ad as X,ae as pe,af as Te,ag as fe,ah as Re}from"./GeoJSON-BoRJWQIG.js";import{C as xe}from"./TileLayer-CTdsxez3.js";import j from"./TileProperty-BF4LcWSy.js";import"./index-B3F0456b.js";import"./utils-BXWzvTjY.js";import"./_commonjsHelpers-CE1G-McA.js";import"./I18N-DlIXJTel.js";import"./BFormRadioGroup.vue_vue_type_script_setup_true_lang-DaMHx4U3-DO3czC2y.js";import"./useStateClass-BGbSLWFN-eI-Q6wqs.js";import"./ConditionalWrapper.vue_vue_type_script_lang-IX_NpHH--5aly-L7g.js";import"./DataTile-B4Zfc0sf.js";import"./Tile-Dd8tR1PC.js";import"./Tile-Bg7ozswn.js";import"./common-CLWpeXJR.js";import"./TileRange-2Tc-Ry00.js";import"./LRUCache-Cy7VNIXe.js";import"./tilecoord-DBpIeO-O.js";const ye={image:["Polygon","Circle","LineString","Image","Text"],hybrid:["Polygon","LineString"],vector:[]},q={hybrid:["Image","Text","Default"],vector:["Polygon","Circle","LineString","Image","Text","Default"]};class Ce extends xe{constructor(e,t){super(e,t),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.renderedLayerRevision_,this.renderedPixelToCoordinateTransform_=null,this.renderedRotation_,this.renderedOpacity_=1,this.tmpTransform_=Y(),this.tileClipContexts_=null}enqueueTilesForNextExtent(){return this.getLayer().getRenderMode()!=="vector"}drawTile(e,t,o,n,i,l,d,r){this.updateExecutorGroup_(e,t.pixelRatio,t.viewState.projection),this.tileImageNeedsRender_(e)&&this.renderTileImage_(e,t),super.drawTile(e,t,o,n,i,l,d,r)}getTile(e,t,o,n){const i=this.getOrCreateTile(e,t,o,n);if(!i)return null;const l=n.viewState,d=l.resolution,r=n.viewHints,s=this.getLayer().getSource(),a=s.getTileGridForProjection(l.projection),T=!(r[D.ANIMATING]||r[D.INTERACTING]),c=a.getZForResolution(d,s.zDirection)===e;return T&&c?i.wantedResolution=d:i.wantedResolution||(i.wantedResolution=a.getResolution(e)),i}prepareFrame(e){const t=this.getLayer().getRevision();return this.renderedLayerRevision_!==t&&(this.renderedLayerRevision_=t,this.renderedTiles.length=0),super.prepareFrame(e)}updateExecutorGroup_(e,t,o){const n=this.getLayer(),i=n.getRevision(),l=n.getRenderOrder()||null,d=e.wantedResolution,r=e.getReplayState(n);if(!r.dirty&&r.renderedResolution===d&&r.renderedRevision==i&&r.renderedRenderOrder==l)return;const s=n.getSource(),a=!!n.getDeclutter(),T=s.getTileGrid(),E=s.getTileGridForProjection(o).getTileCoordExtent(e.wrappedTileCoord),p=s.getSourceTiles(t,o,e),g=F(n);delete e.hitDetectionImageData[g],e.executorGroups[g]=[],r.dirty=!1;for(let h=0,v=p.length;h<v;++h){const R=p[h];if(R.getState()!=M.LOADED)continue;const u=s.getProjection(),m=R.tileCoord;let f=T.getTileCoordExtent(m);o&&u&&!H(o,u)&&(f=$(f,u,o,32));const y=J(E,f),x=k(y,n.getRenderBuffer()*d,this.tempExtent),w=Q(f,y)?null:x,_=new te(0,y,d,t),A=Te(d,t),G=function(C,N){let L;const Z=C.getStyleFunction()||n.getStyleFunction();if(Z&&(L=Z(C,d)),L){const W=this.renderFeature(C,A,L,_,a,N);r.dirty=r.dirty||W}},I=R.getFeatures();l&&l!==r.renderedRenderOrder&&I.sort(l);for(let C=0,N=I.length;C<N;++C){let L=I[C];o&&R.projection&&!H(o,R.projection)&&(L=L.clone(),L.getGeometry().applyTransform(ee(R.projection,o))),(!w||P(w,L.getGeometry().getExtent()))&&G.call(this,L,C)}const O=_.finish(),S=n.getRenderMode()!=="vector"&&a&&p.length===1?null:y,b=new re(S,d,t,s.getOverlaps(),O,n.getRenderBuffer(),!0);e.executorGroups[g].push(b)}r.renderedRevision=i,r.renderedRenderOrder=l,r.renderedResolution=d}forEachFeatureAtCoordinate(e,t,o,n,i){const l=t.viewState.resolution,d=t.viewState.rotation;o=o??0;const r=this.getLayer(),a=r.getSource().getTileGridForProjection(t.viewState.projection),T=oe([e]);k(T,l*o,T);const c={},E=function(u,m,f){let y=u.getId();y===void 0&&(y=F(u));const x=c[y];if(x){if(x!==!0&&f<x.distanceSq){if(f===0)return c[y]=!0,i.splice(i.lastIndexOf(x),1),n(u,r,m);x.geometry=m,x.distanceSq=f}}else{if(f===0)return c[y]=!0,n(u,r,m);i.push(c[y]={feature:u,layer:r,geometry:m,distanceSq:f,callback:n})}},p=this.renderedTiles,g=F(r),h=r.getDeclutter(),v=h?t.declutter?.[h]?.all().map(u=>u.value):null;let R;e:for(let u=0,m=p.length;u<m;++u){const f=p[u],y=a.getTileCoordExtent(f.wrappedTileCoord);if(!P(y,T))continue;const x=f.executorGroups[g];for(let w=0,_=x.length;w<_;++w)if(R=x[w].forEachFeatureAtCoordinate(e,l,d,o,E,v),R)break e}return R}getFeatures(e){return this.renderedTiles.length===0?Promise.resolve([]):new Promise((t,o)=>{const n=this.getLayer(),i=n.getSource(),l=this.renderedProjection,d=l.getExtent(),r=this.renderedResolution,s=i.getTileGridForProjection(l),a=ne(this.renderedPixelToCoordinateTransform_,e.slice()),T=s.getTileCoordForCoordAndResolution(a,r).toString(),c=this.renderedTiles.find(u=>u.tileCoord.toString()===T&&u.getState()===M.LOADED);if(!c||c.loadingSourceTiles>0){t([]);return}i.getWrapX()&&l.canWrapX()&&!ie(d,s.getTileCoordExtent(c.tileCoord))&&se(a,l);const E=F(n),p=s.getTileCoordExtent(c.wrappedTileCoord),g=le(p),h=[(a[0]-g[0])/r,(g[1]-a[1])/r],v=c.getSourceTiles().reduce((u,m)=>u.concat(m.getFeatures()),[]);let R=c.hitDetectionImageData[E];if(!R){const u=ce(s.getTileSize(s.getZForResolution(r,i.zDirection))),m=this.renderedRotation_,f=[this.getRenderTransform(s.getTileCoordCenter(c.wrappedTileCoord),r,0,z,u[0]*z,u[1]*z,0)];R=ae(u,f,v,n.getStyleFunction(),s.getTileCoordExtent(c.wrappedTileCoord),c.getReplayState(n).renderedResolution,m),c.hitDetectionImageData[E]=R}t(de(h,v,R))})}getFeaturesInExtent(e){const t=[],o=this.getTileCache();if(o.getCount()===0)return t;const i=this.getLayer().getSource().getTileGridForProjection(this.frameState.viewState.projection),l=i.getZForResolution(this.renderedResolution),d={};return o.forEach(r=>{if(r.tileCoord[0]!==l||r.getState()!==M.LOADED)return;const s=r.getSourceTiles();for(let a=0,T=s.length;a<T;++a){const c=s[a],E=c.getKey();if(E in d)continue;d[E]=!0;const p=c.tileCoord;if(P(e,i.getTileCoordExtent(p))){const g=c.getFeatures();if(g)for(let h=0,v=g.length;h<v;++h){const R=g[h],u=R.getGeometry();P(e,u.getExtent())&&t.push(R)}}}}),t}handleFontsChanged(){const e=this.getLayer();e.getVisible()&&this.renderedLayerRevision_!==void 0&&e.changed()}handleStyleImageChange_(e){this.renderIfReadyAndVisible()}renderDeclutter(e,t){const o=this.context,n=o.globalAlpha;o.globalAlpha=t.opacity;const i=e.viewHints,l=!(i[D.ANIMATING]||i[D.INTERACTING]),d=[this.context.canvas.width,this.context.canvas.height],r=this.getLayer().getDeclutter(),s=r?e.declutter?.[r]:void 0,a=F(this.getLayer()),T=this.renderedTiles;for(let c=0,E=T.length;c<E;++c){const p=T[c],g=p.executorGroups[a];if(g)for(let h=g.length-1;h>=0;--h)g[h].execute(this.context,d,this.getTileRenderTransform(p,e),e.viewState.rotation,l,V,s)}o.globalAlpha=n}renderDeferredInternal(e){const t=this.renderedTiles,o=F(this.getLayer()),n=t.reduce((r,s,a)=>(s.executorGroups[o].forEach(T=>r.push({executorGroup:T,index:a})),r),[]),i=n.map(({executorGroup:r})=>r.getDeferredZIndexContexts()),l={};for(let r=0,s=n.length;r<s;++r){const a=n[r].executorGroup.getDeferredZIndexContexts();for(const T in a)l[T]=!0}Object.keys(l).map(Number).sort(ue).forEach(r=>{i.forEach((s,a)=>{s[r]&&(s[r].forEach(T=>{const{executorGroup:c,index:E}=n[a],p=c.getRenderedContext(),g=p.globalAlpha;p.globalAlpha=this.renderedOpacity_;const h=this.tileClipContexts_[E];h&&h.draw(p),T.draw(p),h&&p.restore(),p.globalAlpha=g,T.clear()}),s[r].length=0)})})}getTileRenderTransform(e,t){const o=t.pixelRatio,n=t.viewState,i=n.center,l=n.resolution,d=n.rotation,r=t.size,s=Math.round(r[0]*o),a=Math.round(r[1]*o),c=this.getLayer().getSource().getTileGridForProjection(t.viewState.projection),E=e.tileCoord,p=c.getTileCoordExtent(e.wrappedTileCoord),g=c.getTileCoordExtent(E,this.tempExtent)[0]-p[0];return ge(U(this.inversePixelTransform.slice(),1/o,1/o),this.getRenderTransform(i,l,d,o,s,a,g))}postRender(e,t){const o=t.viewHints,n=!(o[D.ANIMATING]||o[D.INTERACTING]);this.renderedPixelToCoordinateTransform_=t.pixelToCoordinateTransform.slice(),this.renderedRotation_=t.viewState.rotation,this.renderedOpacity_=t.layerStatesArray[t.layerIndex].opacity;const i=this.getLayer(),l=i.getRenderMode(),d=e.globalAlpha;e.globalAlpha=this.renderedOpacity_;const r=i.getDeclutter(),s=r?q[l].filter(f=>!V.includes(f)):q[l],a=t.viewState,T=a.rotation,c=i.getSource(),p=c.getTileGridForProjection(a.projection).getZForResolution(a.resolution,c.zDirection),g=this.renderedTiles,h=[],v=[],R=[],u=F(i);let m=!0;for(let f=g.length-1;f>=0;--f){const y=g[f];m=m&&!y.getReplayState(i).dirty;const x=y.executorGroups[u].filter(S=>S.hasExecutors(s));if(x.length===0)continue;const w=this.getTileRenderTransform(y,t),_=y.tileCoord[0];let A=!1;const G=x[0].getClipCoords(w);let I=e,O;if(G){O=new he,I=O.getContext();for(let S=0,b=h.length;S<b;++S)if(p!==_&&_<v[S]){const C=h[S];P([G[0],G[3],G[4],G[7]],[C[0],C[3],C[4],C[7]])&&(A||(I.save(),A=!0),I.beginPath(),I.moveTo(G[0],G[1]),I.lineTo(G[2],G[3]),I.lineTo(G[4],G[5]),I.lineTo(G[6],G[7]),I.moveTo(C[6],C[7]),I.lineTo(C[4],C[5]),I.lineTo(C[2],C[3]),I.lineTo(C[0],C[1]),I.clip())}h.push(G),v.push(_)}for(let S=0,b=x.length;S<b;++S)x[S].execute(e,[e.canvas.width,e.canvas.height],w,T,n,s,t.declutter?.[r]);A&&(I===e?I.restore():R[f]=O)}e.globalAlpha=d,this.ready=m,this.tileClipContexts_=R,t.declutter||this.renderDeferredInternal(t),super.postRender(e,t)}renderFeature(e,t,o,n,i,l){if(!o)return!1;let d=!1;if(Array.isArray(o))for(let r=0,s=o.length;r<s;++r)d=B(n,e,o[r],t,this.boundHandleStyleImageChange_,void 0,i,l)||d;else d=B(n,e,o,t,this.boundHandleStyleImageChange_,void 0,i,l);return d}tileImageNeedsRender_(e){const t=this.getLayer();if(t.getRenderMode()==="vector")return!1;const o=e.getReplayState(t),n=t.getRevision(),i=e.wantedResolution;return o.renderedTileResolution!==i||o.renderedTileRevision!==n}renderTileImage_(e,t){const o=this.getLayer(),n=e.getReplayState(o),i=o.getRevision(),l=e.executorGroups[F(o)];n.renderedTileRevision=i;const d=e.wrappedTileCoord,r=d[0],s=o.getSource();let a=t.pixelRatio;const c=t.viewState.projection,E=s.getTileGridForProjection(c),p=E.getResolution(e.tileCoord[0]),g=t.pixelRatio/e.wantedResolution*p,h=E.getResolution(r),v=e.getContext();a=Math.round(Math.max(a,g/a));const R=s.getTilePixelSize(r,a,c);v.canvas.width=R[0],v.canvas.height=R[1];const u=a/g;if(u!==1){const x=X(this.tmpTransform_);U(x,u,u),v.setTransform.apply(v,x)}const m=E.getTileCoordExtent(d,this.tempExtent),f=g/h,y=X(this.tmpTransform_);U(y,f,-f),pe(y,-m[0],-m[3]);for(let x=0,w=l.length;x<w;++x)l[x].execute(v,[v.canvas.width*u,v.canvas.height*u],y,0,!0,ye[o.getRenderMode()],null);n.renderedTileResolution=e.wantedResolution}}class Me extends fe{constructor(e){e=e||{};const t=Object.assign({},e);delete t.preload;const o=e.cacheSize===void 0?0:e.cacheSize;delete e.cacheSize,delete t.useInterimTilesOnError,super(t),this.on,this.once,this.un,this.cacheSize_=o;const n=e.renderMode||"hybrid";Re(n=="hybrid"||n=="vector","`renderMode` must be `'hybrid'` or `'vector'`"),this.renderMode_=n,this.setPreload(e.preload?e.preload:0),this.setUseInterimTilesOnError(e.useInterimTilesOnError!==void 0?e.useInterimTilesOnError:!0),this.getBackground,this.setBackground}createRenderer(){return new Ce(this,{cacheSize:this.cacheSize_})}getFeatures(e){return super.getFeatures(e)}getFeaturesInExtent(e){return this.getRenderer().getFeaturesInExtent(e)}getRenderMode(){return this.renderMode_}getPreload(){return this.get(j.PRELOAD)}getUseInterimTilesOnError(){return this.get(j.USE_INTERIM_TILES_ON_ERROR)}setPreload(e){this.set(j.PRELOAD,e)}setUseInterimTilesOnError(e){this.set(j.USE_INTERIM_TILES_ON_ERROR,e)}}export{Me as default};
//# sourceMappingURL=VectorTile-BWsCG2vh.js.map
