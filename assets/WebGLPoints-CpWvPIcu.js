import{d as v,b as A,W as F,a as D,c as I,p as L}from"./RenderTarget-BqfCXHc-.js";import{ao as P,p,o as w,aZ as _,c4 as g,g as m,U as C,Y as x,ag as S,X as U,A as T,ah as W,ae as G,m as j,a_ as z,aE as N}from"./GeoJSON-BoRJWQIG.js";import{m as O,D as M,a as b,b as E,q as y,E as k,p as l}from"./compileUtil-Qcsrcrcg.js";import{g as V}from"./worldUtil-toAxFTf9.js";import"./index-B3F0456b.js";import"./utils-BXWzvTjY.js";import"./_commonjsHelpers-CE1G-McA.js";import"./I18N-DlIXJTel.js";import"./BFormRadioGroup.vue_vue_type_script_setup_true_lang-DaMHx4U3-DO3czC2y.js";import"./useStateClass-BGbSLWFN-eI-Q6wqs.js";import"./ConditionalWrapper.vue_vue_type_script_lang-IX_NpHH--5aly-L7g.js";import"./mat4-CeypvY8Z.js";import"./DataTile-B4Zfc0sf.js";import"./Tile-Dd8tR1PC.js";import"./Tile-Bg7ozswn.js";import"./common-CLWpeXJR.js";import"./TileRange-2Tc-Ry00.js";import"./LRUCache-Cy7VNIXe.js";import"./tilecoord-DBpIeO-O.js";class H extends O{constructor(e,t){const s=t.uniforms||{},n=p();s[M.PROJECTION_MATRIX]=n,super(e,{uniforms:s,postProcesses:t.postProcesses}),this.sourceRevision_=-1,this.verticesBuffer_=new b(E,y),this.instanceAttributesBuffer_=new b(E,y),this.indicesBuffer_=new b(k,y),this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.program_,this.hitDetectionEnabled_=t.hitDetectionEnabled??!0;const a=t.attributes?t.attributes.map(function(r){return{name:"a_"+r.name,size:1,type:l.FLOAT}}):[];this.attributes=[{name:"a_localPosition",size:2,type:l.FLOAT}],this.instanceAttributes=[{name:"a_position",size:2,type:l.FLOAT}],this.hitDetectionEnabled_&&(this.instanceAttributes.push({name:"a_hitColor",size:2,type:l.FLOAT}),this.instanceAttributes.push({name:"a_featureUid",size:1,type:l.FLOAT})),this.instanceAttributes.push(...a),this.customAttributes=t.attributes?t.attributes:[],this.previousExtent_=P(),this.currentTransform_=n,this.renderTransform_=p(),this.invertRenderTransform_=p(),this.renderInstructions_=new Float32Array(0),this.hitRenderTarget_,this.lastSentId=0,this.worker_=v(),this.worker_.addEventListener("message",r=>{const o=r.data;if(o.type===A.GENERATE_POINT_BUFFERS){const h=o.projectionTransform;this.verticesBuffer_.fromArrayBuffer(o.vertexAttributesBuffer),this.instanceAttributesBuffer_.fromArrayBuffer(o.instanceAttributesBuffer),this.helper.flushBufferData(this.verticesBuffer_),this.helper.flushBufferData(this.instanceAttributesBuffer_),this.indicesBuffer_.fromArrayBuffer(o.indicesBuffer),this.helper.flushBufferData(this.indicesBuffer_),this.renderTransform_=h,w(this.invertRenderTransform_,this.renderTransform_),this.renderInstructions_=new Float32Array(r.data.renderInstructions),o.id===this.lastSentId&&(this.ready=!0),this.getLayer().changed()}}),this.featureCache_={},this.featureCount_=0;const i=this.getLayer().getSource();this.sourceListenKeys_=[_(i,g.ADDFEATURE,this.handleSourceFeatureAdded_,this),_(i,g.CHANGEFEATURE,this.handleSourceFeatureChanged_,this),_(i,g.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),_(i,g.CLEAR,this.handleSourceFeatureClear_,this)],i.forEachFeature(r=>{const o=r.getGeometry();o&&o.getType()==="Point"&&(this.featureCache_[m(r)]={feature:r,properties:r.getProperties(),flatCoordinates:o.getFlatCoordinates()},this.featureCount_++)})}afterHelperCreated(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new F(this.helper)),this.verticesBuffer_.getArray()&&this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.getArray()&&this.helper.flushBufferData(this.indicesBuffer_)}handleSourceFeatureAdded_(e){const t=e.feature,s=t.getGeometry();s&&s.getType()==="Point"&&(this.featureCache_[m(t)]={feature:t,properties:t.getProperties(),flatCoordinates:s.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureChanged_(e){const t=e.feature,s=m(t),n=this.featureCache_[s],a=t.getGeometry();n?a&&a.getType()==="Point"?(n.properties=t.getProperties(),n.flatCoordinates=a.getFlatCoordinates()):(delete this.featureCache_[s],this.featureCount_--):a&&a.getType()==="Point"&&(this.featureCache_[s]={feature:t,properties:t.getProperties(),flatCoordinates:a.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureDelete_(e){const t=e.feature,s=m(t);s in this.featureCache_&&(delete this.featureCache_[s],this.featureCount_--)}handleSourceFeatureClear_(){this.featureCache_={},this.featureCount_=0}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[s,n,a]=V(e,this.getLayer());return this.renderWorlds(e,!1,s,n,a),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent),this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,s,n,a),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),this.helper.getCanvas()}prepareFrameInternal(e){const t=this.getLayer(),s=t.getSource(),n=e.viewState,a=!e.viewHints[C.ANIMATING]&&!e.viewHints[C.INTERACTING],i=!x(this.previousExtent_,e.extent),r=this.sourceRevision_<s.getRevision();if(r&&(this.sourceRevision_=s.getRevision()),a&&(i||r)){const o=n.projection,h=n.resolution,c=t instanceof S?t.getRenderBuffer():0,f=U(e.extent,c*h);s.loadFeatures(f,h,o),this.rebuildBuffers_(e),this.previousExtent_=e.extent.slice()}return this.helper.useProgram(this.program_,e),this.helper.prepareDraw(e),!0}rebuildBuffers_(e){const t=p();this.helper.makeProjectionTransform(e,t);const n=(this.hitDetectionEnabled_?5:2)+this.customAttributes.length,a=n*this.featureCount_,i=this.renderInstructions_&&this.renderInstructions_.length===a?this.renderInstructions_:new Float32Array(a);this.renderInstructions_=null;let r=[];const o=[];let h=-1;e.viewState.projection;for(const f in this.featureCache_){const d=this.featureCache_[f];if(r[0]=d.flatCoordinates[0],r[1]=d.flatCoordinates[1],T(t,r),i[++h]=r[0],i[++h]=r[1],this.hitDetectionEnabled_){const u=D(h+3,o);i[++h]=u[0],i[++h]=u[1],i[++h]=Number(f)}for(let u=0;u<this.customAttributes.length;u++){const B=this.customAttributes[u].callback(d.feature,d.properties);i[++h]=B}}const c={id:++this.lastSentId,type:A.GENERATE_POINT_BUFFERS,renderInstructions:i.buffer,customAttributesSize:n-2};c.projectionTransform=t,this.ready=!1,this.worker_.postMessage(c,[i.buffer])}forEachFeatureAtCoordinate(e,t,s,n,a){if(W(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.renderInstructions_||!this.hitDetectionEnabled_)return;const i=T(t.coordinateToPixelTransform,e.slice()),r=this.hitRenderTarget_.readPixel(i[0]/2,i[1]/2),o=[r[0]/255,r[1]/255,r[2]/255,r[3]/255],h=I(o),c=this.renderInstructions_[h],f=Math.floor(c).toString(),u=this.getLayer().getSource().getFeatureByUid(f);if(u)return n(u,this.getLayer(),null)}renderWorlds(e,t,s,n,a){let i=s;this.helper.useProgram(this.program_,e),t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0));const r=this.instanceAttributes.reduce((h,c)=>h+(c.size||1),0),o=this.instanceAttributesBuffer_.getSize()/r;do{this.helper.bindBuffer(this.indicesBuffer_),this.helper.bindBuffer(this.verticesBuffer_),this.helper.enableAttributes(this.attributes),this.helper.bindBuffer(this.instanceAttributesBuffer_),this.helper.enableAttributesInstanced(this.instanceAttributes),this.helper.makeProjectionTransform(e,this.currentTransform_),G(this.currentTransform_,i*a,0),j(this.currentTransform_,this.invertRenderTransform_),this.helper.applyUniforms(e),this.helper.applyHitDetectionUniform(t);const h=this.indicesBuffer_.getSize();this.helper.drawElementsInstanced(0,h,o)}while(++i<n)}disposeInternal(){this.worker_.terminate(),this.sourceListenKeys_.forEach(function(e){z(e)}),this.sourceListenKeys_=null,super.disposeInternal()}renderDeclutter(){}}class fe extends N{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.parseResult_=L(e.style,this.styleVariables_,e.filter),this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){const e=Object.keys(this.parseResult_.attributes).map(t=>({name:t,...this.parseResult_.attributes[t]}));return new H(this,{vertexShader:this.parseResult_.builder.getSymbolVertexShader(),fragmentShader:this.parseResult_.builder.getSymbolFragmentShader(),hitDetectionEnabled:!this.hitDetectionDisabled_,uniforms:this.parseResult_.uniforms,attributes:e})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}export{fe as default};
//# sourceMappingURL=WebGLPoints-CpWvPIcu.js.map
