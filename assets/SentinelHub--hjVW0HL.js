import{W as m,y as f}from"./GeoJSON-BlyzYhKz.js";import _ from"./DataTile-Dra_RFvC.js";import"./index-4V-ffF_e.js";import"./utils-BXWzvTjY.js";import"./_commonjsHelpers-CE1G-McA.js";import"./I18N-DlIXJTel.js";import"./BFormRadioGroup.vue_vue_type_script_setup_true_lang-DaMHx4U3-CVtNDUBO.js";import"./useStateClass-BGbSLWFN-lMazZNQ7.js";import"./ConditionalWrapper.vue_vue_type_script_lang-IX_NpHH--B1-KiooU.js";import"./DataTile-uej8eNh4.js";import"./Tile-lMrQctYw.js";import"./common-0gNrjJbx.js";import"./mat4-CeypvY8Z.js";import"./tilecoord-DYaQ6NdW.js";import"./Tile-8IayXPne.js";import"./TileGrid-D2Qra4XP.js";import"./TileRange-2Tc-Ry00.js";import"./TileEventType-CTN_nmJ7.js";const w="https://services.sentinel-hub.com/api/v1/process",g="https://services.sentinel-hub.com/auth/realms/main/protocol/openid-connect/token",y="3",b=[512,512],S=10,R=500;function k(i){return`//VERSION=${i.version||y}
    ${c("setup",i.setup)}
    ${c("evaluatePixel",i.evaluatePixel)}
    ${c("updateOutput",i.updateOutput)}
  `}async function T(i){const e=await i.blob();return new Promise((t,o)=>{const r=new Image,n=URL.createObjectURL(e);r.onload=()=>{URL.revokeObjectURL(n),t(r)},r.onerror=()=>{URL.revokeObjectURL(n),o(new Error("Failed to load image"))},r.src=n})}function v(i){return new Promise(e=>setTimeout(e,i))}async function E(i){const e=i.tokenUrl||g,t=new URLSearchParams;t.append("grant_type","client_credentials"),t.append("client_id",i.clientId),t.append("client_secret",i.clientSecret);const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t});if(!r.ok)throw r.status===401?new Error("Bad client id or secret"):new Error("Failed to get token");return(await r.json()).access_token}function x(i){const e=i.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),t=atob(e).split(""),o=t.length,r=new Array(o);for(let n=0;n<o;++n){const s=t[n];r[n]="%"+("00"+s.charCodeAt(0).toString(16)).slice(-2)}return JSON.parse(decodeURIComponent(r.join("")))}function P(i){const e="http://www.opengis.net/def/crs/",t=i.getCode();return t.startsWith(e)?t:t.startsWith("EPSG:")?`${e}EPSG/0/${t.slice(5)}`:m(i,f("EPSG:4326"))?`${e}EPSG/0/4326`:t}function c(i,e){if(!e)return"";let t=e.toString();return e.name&&e.name!=="function"&&t.match(new RegExp("^"+e.name.replace("$","\\$")+"\\b"))&&(t="function "+t),`var ${i} = ${t};`}class J extends _{constructor(e){const t=e||{};super({state:"loading",projection:t.projection,attributionsCollapsible:t.attributionsCollapsible,interpolate:t.interpolate,tileSize:t.tileSize||b,wrapX:t.wrapX!==void 0?t.wrapX:!0,transition:t.transition}),this.setLoader((o,r,n)=>this.loadTile_(o,r,n,1)),this.error_=null,this.evalscript_="",this.inputData_=null,this.processUrl_=t.url||w,this.token_="",this.tokenRenewalId_,t.auth&&this.setAuth(t.auth),t.data&&this.setData(t.data),t.evalscript&&this.setEvalscript(t.evalscript)}async setAuth(e){if(clearTimeout(this.tokenRenewalId_),typeof e=="string"){this.token_=e,this.fireWhenReady_();return}let t,o;try{t=await E(e),o=x(t)}catch(s){this.error_=s,this.setState("error");return}this.token_=t;const r=o.exp*1e3,n=Math.max(r-Date.now()-60*1e3,1);this.tokenRenewalId_=setTimeout(()=>this.setAuth(e),n),this.fireWhenReady_()}setData(e){this.inputData_=e,this.fireWhenReady_()}setEvalscript(e){let t;if(typeof e=="string")t=e;else try{t=k(e)}catch(o){this.error_=o,this.setState("error");return}this.evalscript_=t,this.fireWhenReady_()}fireWhenReady_(){if(!this.token_||!this.evalscript_||!this.inputData_)return;if(this.getState()==="ready"){this.changed();return}this.setState("ready")}async loadTile_(e,t,o,r){const s=this.getTileGrid().getTileCoordExtent([e,t,o]),l=this.getTileSize(e),p=this.getProjection(),d={input:{bounds:{bbox:s,properties:{crs:P(p)}},data:this.inputData_},output:{width:l[0],height:l[1]},evalscript:this.evalscript_},u={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token_}`,"Access-Control-Request-Headers":"Retry-After"},body:JSON.stringify(d),credentials:"include"},a=await fetch(this.processUrl_,u);if(!a.ok){if(a.status===429&&r<S-1){const h=R*2**r;return await v(h),this.loadTile_(t,o,e,r+1)}throw new Error(`Failed to get tile: ${a.statusText}`)}return T(a)}getError(){return this.error_}disposeInternal(){clearTimeout(this.tokenRenewalId_),super.disposeInternal()}}export{J as default,P as getProjectionIdentifier,x as parseTokenClaims,c as serializeFunction};
//# sourceMappingURL=SentinelHub--hjVW0HL.js.map
