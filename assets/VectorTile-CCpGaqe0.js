import{as as O,g as P,at as K,f as l,X as G,W as x,G as F,v as z,E as C,_ as b,a4 as A,au as Z,av as w,aw as M}from"./GeoJSON-BoRJWQIG.js";import{T as L}from"./Tile-Dd8tR1PC.js";import{T as p}from"./TileGrid-r8UQ2tK6.js";import{e as I,c as B,g as N}from"./Tile-BqAKaOfQ.js";import X from"./UrlTile-CjdLFnBY.js";const D=[];class V extends L{constructor(e,i,t,o,s){super(e,i,{transition:0}),this.context_=null,this.executorGroups={},this.loadingSourceTiles=0,this.hitDetectionImageData={},this.replayState_={},this.sourceTiles=[],this.errorTileKeys={},this.wantedResolution,this.getSourceTiles=o.bind(void 0,this),this.removeSourceTiles_=s,this.wrappedTileCoord=t}getContext(){return this.context_||(this.context_=O(1,1,D)),this.context_}hasContext(){return!!this.context_}getImage(){return this.hasContext()?this.getContext().canvas:null}getReplayState(e){const i=P(e);return i in this.replayState_||(this.replayState_[i]={dirty:!1,renderedRenderOrder:null,renderedResolution:NaN,renderedRevision:-1,renderedTileResolution:NaN,renderedTileRevision:-1,renderedTileZ:-1}),this.replayState_[i]}load(){this.getSourceTiles()}release(){this.context_&&(K(this.context_),D.push(this.context_.canvas),this.context_=null),this.removeSourceTiles_(this),this.sourceTiles.length=0,super.release()}}let j=class extends L{constructor(e,i,t,o,s,r){super(e,i,r),this.extent=null,this.format_=o,this.features_=null,this.loader_,this.projection=null,this.resolution,this.tileLoadFunction_=s,this.url_=t,this.key=t}getTileUrl(){return this.url_}getFormat(){return this.format_}getFeatures(){return this.features_}load(){this.state==l.IDLE&&(this.setState(l.LOADING),this.tileLoadFunction_(this,this.url_),this.loader_&&this.loader_(this.extent,this.resolution,this.projection))}onLoad(e,i){this.setFeatures(e)}onError(){this.setState(l.ERROR)}setFeatures(e){this.features_=e,this.setState(l.LOADED)}setLoader(e){this.loader_=e}};class k extends X{constructor(e){const i=e.projection||"EPSG:3857",t=e.extent||I(i),o=e.tileGrid||B({extent:t,maxResolution:e.maxResolution,maxZoom:e.maxZoom!==void 0?e.maxZoom:22,minZoom:e.minZoom,tileSize:e.tileSize||512});super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,interpolate:!0,projection:i,state:e.state,tileGrid:o,tileLoadFunction:e.tileLoadFunction?e.tileLoadFunction:v,tileUrlFunction:e.tileUrlFunction,url:e.url,urls:e.urls,wrapX:e.wrapX===void 0?!0:e.wrapX,transition:e.transition,zDirection:e.zDirection===void 0?1:e.zDirection}),this.format_=e.format?e.format:null,this.tileKeysBySourceTileUrl_={},this.sourceTiles_={},this.overlaps_=e.overlaps==null?!0:e.overlaps,this.tileClass=e.tileClass?e.tileClass:j,this.tileGrids_={}}getOverlaps(){return this.overlaps_}getSourceTiles(e,i,t){if(t.getState()===l.IDLE){t.setState(l.LOADING);const o=t.wrappedTileCoord,s=this.getTileGridForProjection(i);let r=s.getTileCoordExtent(o);const u=o[0],d=s.getResolution(u);G(r,-d,r);const n=this.projection;i&&this.projection&&!x(i,n)&&(r=F(r,i,n));const a=this.tileGrid,T=a.getExtent();T&&z(r,T,r);let m=d;i&&n&&!x(i,n)&&(m=d/n.getMetersPerUnit()/i.getMetersPerUnit());const _=a.getZForResolution(m,this.zDirection);a.forEachTileCoord(r,_,g=>{const h=this.tileUrlFunction(g,e,i);this.sourceTiles_[h]||(this.sourceTiles_[h]=new this.tileClass(g,h?l.IDLE:l.EMPTY,h,this.format_,this.tileLoadFunction));const c=this.sourceTiles_[h];t.sourceTiles.push(c),this.tileKeysBySourceTileUrl_[h]||(this.tileKeysBySourceTileUrl_[h]=[]),this.tileKeysBySourceTileUrl_[h].push(t.getKey());const S=c.getState();if(S<l.LOADED){const y=U=>{this.handleTileChange(U);const E=c.getState();if(E===l.LOADED||E===l.ERROR){const R=c.getKey();R in t.errorTileKeys?c.getState()===l.LOADED&&delete t.errorTileKeys[R]:t.loadingSourceTiles--,E===l.ERROR?t.errorTileKeys[R]=!0:c.removeEventListener(C.CHANGE,y),t.loadingSourceTiles===0&&t.setState(w(t.errorTileKeys)?l.LOADED:l.ERROR)}};c.addEventListener(C.CHANGE,y),t.loadingSourceTiles++}S===l.IDLE&&(c.extent=a.getTileCoordExtent(g),c.projection=this.projection,c.resolution=a.getResolution(g[0]),c.load())}),t.loadingSourceTiles||t.setState(t.sourceTiles.some(g=>g.getState()===l.ERROR)?l.ERROR:l.LOADED)}return t.sourceTiles}removeSourceTiles(e){const i=e.getKey(),t=e.sourceTiles;for(let o=0,s=t.length;o<s;++o){const r=t[o].getTileUrl();if(!this.tileKeysBySourceTileUrl_[r])return;const u=this.tileKeysBySourceTileUrl_[r].indexOf(i);u!==-1&&(this.tileKeysBySourceTileUrl_[r].splice(u,1),this.tileKeysBySourceTileUrl_[r].length===0&&(delete this.tileKeysBySourceTileUrl_[r],delete this.sourceTiles_[r]))}}getTile(e,i,t,o,s){const r=[e,i,t];let u=this.getTileCoordForTileUrlFunction(r,s);const d=this.getTileGrid().getExtent(),n=this.projection,a=this.getTileGridForProjection(s);if(u&&d){const _=a.getTileCoordExtent(u);G(_,-a.getResolution(e),_),b(d,!s||!n||x(s,n)?_:F(_,s,n))||(u=null)}let T=!0;if(u!==null){const _=this.tileGrid,g=a.getResolution(e);let h=g;s&&n&&!x(s,n)&&(h=g/n.getMetersPerUnit()/s.getMetersPerUnit());const c=_.getZForResolution(h,1),S=a.getTileCoordExtent(u);G(S,-g,S),_.forEachTileCoord(!s||!n||x(s,n)?S:F(S,s,n),c,y=>{T=T&&!this.tileUrlFunction(y,o,n)})}const m=new V(r,T?l.EMPTY:l.IDLE,u,this.getSourceTiles.bind(this,o,s),this.removeSourceTiles.bind(this));return m.key=this.getKey(),m}getTileGridForProjection(e){const i=e.getCode();let t=this.tileGrids_[i];if(!t){const o=this.projection;if(o!==null&&!x(o,e))return N(e);const s=this.tileGrid,r=s.getResolutions().slice(),u=r.map(function(a,T){return s.getOrigin(T)}),d=r.map(function(a,T){return s.getTileSize(T)}),n=M+1;for(let a=r.length;a<n;++a)r.push(r[a-1]/2),u.push(u[a-1]),d.push(d[a-1]);t=new p({extent:s.getExtent(),origins:u,resolutions:r,tileSizes:d}),this.tileGrids_[i]=t}return t}getTilePixelRatio(e){return e}getTilePixelSize(e,i,t){const o=this.getTileGridForProjection(t),s=A(o.getTileSize(e),this.tmpSize);return[Math.round(s[0]*i),Math.round(s[1]*i)]}setOverlaps(e){this.overlaps_=e,this.changed()}}function v(f,e){f.setLoader(function(i,t,o){Z(e,f.getFormat(),i,t,o,f.onLoad.bind(f),f.onError.bind(f))})}const Q=Object.freeze(Object.defineProperty({__proto__:null,default:k,defaultLoadFunction:v},Symbol.toStringTag,{value:"Module"}));export{k as V,j as a,Q as b,v as d};
//# sourceMappingURL=VectorTile-CCpGaqe0.js.map
