import{ao as E,p as d,aZ as c,c4 as u,c5 as b,m as F,o as f,A as p,U as m,Y as A,ag as L,X as v,ae as C,ah as D,a_ as B}from"./GeoJSON-BoRJWQIG.js";import{M as I,V as N}from"./VectorStyleRenderer-DkZimUQB.js";import{W as x,c as w}from"./RenderTarget-BqfCXHc-.js";import{c as O,f as T}from"./mat4-CeypvY8Z.js";import{m as P,D as G}from"./compileUtil-Qcsrcrcg.js";import{g as M}from"./worldUtil-toAxFTf9.js";const o={...G,RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",GLOBAL_ALPHA:"u_globalAlpha"};class X extends P{constructor(e,t){const s={[o.RENDER_EXTENT]:[0,0,0,0],[o.PATTERN_ORIGIN]:[0,0],[o.GLOBAL_ALPHA]:1};super(e,{uniforms:s,postProcesses:t.postProcesses}),this.hitDetectionEnabled_=!t.disableHitDetection,this.hitRenderTarget_,this.sourceRevision_=-1,this.previousExtent_=E(),this.currentTransform_=d(),this.tmpCoords_=[0,0],this.tmpTransform_=d(),this.tmpMat4_=O(),this.currentFrameStateTransform_=d(),this.styleVariables_={},this.style_=[],this.styleRenderer_=null,this.buffers_=null,this.applyOptions_(t),this.batch_=new I,this.initialFeaturesAdded_=!1,this.sourceListenKeys_=null}addInitialFeatures_(e){const t=this.getLayer().getSource();let s;this.batch_.addFeatures(t.getFeatures(),s),this.sourceListenKeys_=[c(t,u.ADDFEATURE,this.handleSourceFeatureAdded_.bind(this,s)),c(t,u.CHANGEFEATURE,this.handleSourceFeatureChanged_.bind(this,s),this),c(t,u.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),c(t,u.CLEAR,this.handleSourceFeatureClear_,this)]}applyOptions_(e){this.styleVariables_=e.variables,this.style_=e.style}createRenderers_(){this.buffers_=null,this.styleRenderer_=new N(this.style_,this.styleVariables_,this.helper,this.hitDetectionEnabled_)}reset(e){this.applyOptions_(e),this.helper&&this.createRenderers_(),super.reset(e)}afterHelperCreated(){this.styleRenderer_?this.styleRenderer_.setHelper(this.helper,this.buffers_):this.createRenderers_(),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new x(this.helper))}handleSourceFeatureAdded_(e,t){const s=t.feature;this.batch_.addFeature(s,e)}handleSourceFeatureChanged_(e,t){const s=t.feature;this.batch_.changeFeature(s,e)}handleSourceFeatureDelete_(e){const t=e.feature;this.batch_.removeFeature(t)}handleSourceFeatureClear_(){this.batch_.clear()}applyUniforms_(e){b(this.tmpTransform_,this.currentFrameStateTransform_),F(this.tmpTransform_,e),this.helper.setUniformMatrixValue(o.PROJECTION_MATRIX,T(this.tmpMat4_,this.tmpTransform_)),f(this.tmpTransform_,this.tmpTransform_),this.helper.setUniformMatrixValue(o.SCREEN_TO_WORLD_MATRIX,T(this.tmpMat4_,this.tmpTransform_)),this.tmpCoords_[0]=0,this.tmpCoords_[1]=0,f(this.tmpTransform_,e),p(this.tmpTransform_,this.tmpCoords_),this.helper.setUniformFloatVec2(o.PATTERN_ORIGIN,this.tmpCoords_)}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[s,r,n]=M(e,this.getLayer());this.helper.prepareDraw(e),this.renderWorlds(e,!1,s,r,n),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const i=this.helper.getCanvas();return this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,s,r,n),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),i}prepareFrameInternal(e){this.initialFeaturesAdded_||(this.addInitialFeatures_(e),this.initialFeaturesAdded_=!0);const t=this.getLayer(),s=t.getSource(),r=e.viewState,n=!e.viewHints[m.ANIMATING]&&!e.viewHints[m.INTERACTING],i=!A(this.previousExtent_,e.extent),a=this.sourceRevision_<s.getRevision();if(a&&(this.sourceRevision_=s.getRevision()),n&&(i||a)){const _=r.projection,h=r.resolution,l=t instanceof L?t.getRenderBuffer():0,R=v(e.extent,l*h);s.loadFeatures(R,h,_),this.ready=!1;const y=this.helper.makeProjectionTransform(e,d());this.styleRenderer_.generateBuffers(this.batch_,y).then(g=>{this.buffers_&&this.disposeBuffers(this.buffers_),this.buffers_=g,this.ready=!0,this.getLayer().changed()}),this.previousExtent_=e.extent.slice()}return!0}renderWorlds(e,t,s,r,n){let i=s;t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0));do this.helper.makeProjectionTransform(e,this.currentFrameStateTransform_),C(this.currentFrameStateTransform_,i*n,0),this.buffers_&&this.styleRenderer_.render(this.buffers_,e,()=>{this.applyUniforms_(this.buffers_.invertVerticesTransform),this.helper.applyHitDetectionUniform(t)});while(++i<r)}forEachFeatureAtCoordinate(e,t,s,r,n){if(D(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.styleRenderer_||!this.hitDetectionEnabled_)return;const i=p(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(i[0]/2,i[1]/2),_=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],h=w(_),l=this.batch_.getFeatureFromRef(h);if(l)return r(l,this.getLayer(),null)}disposeBuffers(e){const t=s=>{for(const r of s)r&&this.helper.deleteBuffer(r)};e.pointBuffers&&t(e.pointBuffers),e.lineStringBuffers&&t(e.lineStringBuffers),e.polygonBuffers&&t(e.polygonBuffers)}disposeInternal(){this.buffers_&&this.disposeBuffers(this.buffers_),this.sourceListenKeys_&&(this.sourceListenKeys_.forEach(function(e){B(e)}),this.sourceListenKeys_=null),super.disposeInternal()}renderDeclutter(){}}export{X as W};
//# sourceMappingURL=VectorLayer-DfJtgZsG.js.map
