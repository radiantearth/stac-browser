import{al as S,v as T,u as D,D as G,az as a,aB as w,aC as O,aZ as N,E as v,a_ as b,B as C,a$ as H,b0 as M,W as A,Y as P,a1 as L,b1 as d,b2 as W}from"./GeoJSON-BoRJWQIG.js";import{c as q,T as K,r as k,E as B}from"./common-CLWpeXJR.js";import{f as E}from"./resolution-CU8ppKQ3.js";import{DECIMALS as m}from"./common-9rOs42pz.js";import"./index-B3F0456b.js";import"./utils-BXWzvTjY.js";import"./_commonjsHelpers-CE1G-McA.js";import"./I18N-DlIXJTel.js";import"./BFormRadioGroup.vue_vue_type_script_setup_true_lang-DaMHx4U3-DO3czC2y.js";import"./useStateClass-BGbSLWFN-eI-Q6wqs.js";import"./ConditionalWrapper.vue_vue_type_script_lang-IX_NpHH--5aly-L7g.js";class F extends S{constructor(t,e,s,i,n,r,u){let o=t.getExtent();o&&t.canWrapX()&&(o=o.slice(),o[0]=-1/0,o[2]=1/0);let h=e.getExtent();h&&e.canWrapX()&&(h=h.slice(),h[0]=-1/0,h[2]=1/0);const g=h?T(s,h):s,_=D(g),R=q(t,e,_,i),j=B,f=new K(t,e,g,o,R*j,i),p=f.calculateSourceExtent(),l=G(p)?null:r(p,R,n),y=l?a.IDLE:a.EMPTY,x=l?l.getPixelRatio():1;super(s,i,x,y),this.targetProj_=e,this.maxSourceExtent_=o,this.triangulation_=f,this.targetResolution_=i,this.targetExtent_=s,this.sourceImage_=l,this.sourcePixelRatio_=x,this.interpolate_=u,this.canvas_=null,this.sourceListenerKey_=null}disposeInternal(){this.state==a.LOADING&&this.unlistenSource_(),super.disposeInternal()}getImage(){return this.canvas_}getProjection(){return this.targetProj_}reproject_(){const t=this.sourceImage_.getState();if(t==a.LOADED){const e=w(this.targetExtent_)/this.targetResolution_,s=O(this.targetExtent_)/this.targetResolution_;this.canvas_=k(e,s,this.sourcePixelRatio_,E(this.sourceImage_.getResolution()),this.maxSourceExtent_,this.targetResolution_,this.targetExtent_,this.triangulation_,[{extent:this.sourceImage_.getExtent(),image:this.sourceImage_.getImage()}],0,void 0,this.interpolate_,!0)}this.state=t,this.changed()}load(){if(this.state==a.IDLE){this.state=a.LOADING,this.changed();const t=this.sourceImage_.getState();t==a.LOADED||t==a.ERROR?this.reproject_():(this.sourceListenerKey_=N(this.sourceImage_,v.CHANGE,e=>{const s=this.sourceImage_.getState();(s==a.LOADED||s==a.ERROR)&&(this.unlistenSource_(),this.reproject_())}),this.sourceImage_.load())}}unlistenSource_(){b(this.sourceListenerKey_),this.sourceListenerKey_=null}}const I={IMAGELOADSTART:"imageloadstart",IMAGELOADEND:"imageloadend",IMAGELOADERROR:"imageloaderror"};class z extends C{constructor(t,e){super(t),this.image=e}}class nt extends H{constructor(t){super({attributions:t.attributions,projection:t.projection,state:t.state,interpolate:t.interpolate!==void 0?t.interpolate:!0}),this.on,this.once,this.un,this.loader=t.loader||null,this.resolutions_=t.resolutions!==void 0?t.resolutions:null,this.reprojectedImage_=null,this.reprojectedRevision_=0,this.image=null,this.wantedExtent_,this.wantedResolution_,this.static_=t.loader?t.loader.length===0:!1,this.wantedProjection_=null}getResolutions(){return this.resolutions_}setResolutions(t){this.resolutions_=t}findNearestResolution(t){const e=this.getResolutions();if(e){const s=M(e,t,0);t=e[s]}return t}getImage(t,e,s,i){const n=this.getProjection();if(!n||!i||A(n,i))return n&&(i=n),this.getImageInternal(t,e,s,i);if(this.reprojectedImage_){if(this.reprojectedRevision_==this.getRevision()&&A(this.reprojectedImage_.getProjection(),i)&&this.reprojectedImage_.getResolution()==e&&P(this.reprojectedImage_.getExtent(),t))return this.reprojectedImage_;this.reprojectedImage_.dispose(),this.reprojectedImage_=null}return this.reprojectedImage_=new F(n,i,t,e,s,(r,u,o)=>this.getImageInternal(r,u,o,n),this.getInterpolate()),this.reprojectedRevision_=this.getRevision(),this.reprojectedImage_}getImageInternal(t,e,s,i){if(this.loader){const n=X(t,e,s,1),r=this.findNearestResolution(e);if(this.image&&(this.static_||this.wantedProjection_===i&&(this.wantedExtent_&&L(this.wantedExtent_,n)||L(this.image.getExtent(),n))&&(this.wantedResolution_&&E(this.wantedResolution_)===r||E(this.image.getResolution())===r)))return this.image;this.wantedProjection_=i,this.wantedExtent_=n,this.wantedResolution_=r,this.image=new S(n,r,s,this.loader),this.image.addEventListener(v.CHANGE,this.handleImageChange.bind(this))}return this.image}handleImageChange(t){const e=t.target;let s;switch(e.getState()){case a.LOADING:this.loading=!0,s=I.IMAGELOADSTART;break;case a.LOADED:this.loading=!1,s=I.IMAGELOADEND;break;case a.ERROR:this.loading=!1,s=I.IMAGELOADERROR;break;default:return}this.hasListener(s)&&this.dispatchEvent(new z(s,e))}}function at(c,t){c.getImage().src=t}function X(c,t,e,s){const i=t/e,n=D(c),r=d(w(c)/i,m),u=d(O(c)/i,m),o=d((s-1)*r/2,m),h=r+2*o,g=d((s-1)*u/2,m),_=u+2*g;return W(n,i,0,[h,_])}export{z as ImageSourceEvent,I as ImageSourceEventType,nt as default,at as defaultImageLoadFunction,X as getRequestExtent};
//# sourceMappingURL=Image-ByRyF10d.js.map
