{"version":3,"file":"arcgisRest-CShpgHQf.js","sources":["../../node_modules/ol/source/arcgisRest.js"],"sourcesContent":["/**\n * @module ol/source/arcgisRest\n */\n\nimport {decode} from '../Image.js';\nimport {getHeight, getWidth} from '../extent.js';\nimport {round} from '../math.js';\nimport {get as getProjection} from '../proj.js';\nimport {appendParams} from '../uri.js';\nimport {getRequestExtent} from './Image.js';\nimport {DECIMALS} from './common.js';\n\n/**\n * @param {string} baseUrl Base URL for the ArcGIS Rest service.\n * @param {import(\"../extent.js\").Extent} extent Extent.\n * @param {number} resolution Resolution.\n * @param {number} pixelRatio Pixel ratio.\n * @param {import(\"../proj/Projection.js\").default} projection Projection.\n * @param {Object} params Params.\n * @return {string} Request URL.\n */\nexport function getRequestUrl(\n  baseUrl,\n  extent,\n  resolution,\n  pixelRatio,\n  projection,\n  params,\n) {\n  // ArcGIS Server only wants the numeric portion of the projection ID.\n  // (if there is no numeric portion the entire projection code must\n  // form a valid ArcGIS SpatialReference definition).\n  const srid = projection\n    .getCode()\n    .split(/:(?=\\d+$)/)\n    .pop();\n\n  const imageResolution = resolution / pixelRatio;\n\n  const imageSize = [\n    round(getWidth(extent) / imageResolution, DECIMALS),\n    round(getHeight(extent) / imageResolution, DECIMALS),\n  ];\n\n  params['SIZE'] = imageSize[0] + ',' + imageSize[1];\n  params['BBOX'] = extent.join(',');\n  params['BBOXSR'] = srid;\n  params['IMAGESR'] = srid;\n  params['DPI'] = Math.round(\n    params['DPI'] ? params['DPI'] * pixelRatio : 90 * pixelRatio,\n  );\n\n  const modifiedUrl = baseUrl\n    .replace(/MapServer\\/?$/, 'MapServer/export')\n    .replace(/ImageServer\\/?$/, 'ImageServer/exportImage');\n  return appendParams(modifiedUrl, params);\n}\n\n/**\n * @typedef {Object} LoaderOptions\n * @property {null|string} [crossOrigin] The `crossOrigin` attribute for loaded images.  Note that\n * you must provide a `crossOrigin` value if you want to access pixel data with the Canvas renderer.\n * See https://developer.mozilla.org/en-US/docs/Web/HTML/CORS_enabled_image for more detail.\n * @property {boolean} [hidpi=true] Use the `ol/Map#pixelRatio` value when requesting the image from\n * the remote server.\n * @property {Object<string,*>} [params] ArcGIS Rest parameters. This field is optional. Service\n * defaults will be used for any fields not specified. `FORMAT` is `PNG32` by default. `F` is\n * `IMAGE` by default. `TRANSPARENT` is `true` by default.  `BBOX`, `SIZE`, `BBOXSR`, and `IMAGESR`\n * will be set dynamically. Set `LAYERS` to override the default service layer visibility. See\n * https://developers.arcgis.com/rest/services-reference/export-map.htm\n * for further reference.\n * @property {import(\"../proj.js\").ProjectionLike} [projection] Projection. Default is 'EPSG:3857'.\n * The projection code must contain a numeric end portion separated by :\n * or the entire code must form a valid ArcGIS SpatialReference definition.\n * @property {number} [ratio=1.5] Ratio. `1` means image requests are the size of the map viewport,\n * `2` means twice the size of the map viewport, and so on.\n * @property {string} url ArcGIS Rest service URL for a Map Service or Image Service. The url\n * should include /MapServer or /ImageServer.\n * @property {function(HTMLImageElement, string): Promise<import('../DataTile.js').ImageLike>} [load] Function\n * to perform loading of the image. Receives the created `HTMLImageElement` and the desired `src` as argument and\n * returns a promise resolving to the loaded or decoded image. Default is {@link module:ol/Image.decode}.\n */\n\n/**\n * Creates a loader for ArcGIS Rest images.\n * @param {LoaderOptions} options Image ArcGIS Rest Options.\n * @return {import('../Image.js').ImageObjectPromiseLoader} ArcGIS Rest image.\n * @api\n */\nexport function createLoader(options) {\n  const load = options.load ? options.load : decode;\n  const projection = getProjection(options.projection || 'EPSG:3857');\n  const ratio = options.ratio ?? 1.5;\n  const crossOrigin = options.crossOrigin ?? null;\n\n  return function (extent, resolution, pixelRatio) {\n    pixelRatio = options.hidpi ? pixelRatio : 1;\n\n    const params = {\n      'F': 'image',\n      'FORMAT': 'PNG32',\n      'TRANSPARENT': true,\n    };\n    Object.assign(params, options.params);\n\n    extent = getRequestExtent(extent, resolution, pixelRatio, ratio);\n\n    const src = getRequestUrl(\n      options.url,\n      extent,\n      resolution,\n      pixelRatio,\n      projection,\n      params,\n    );\n\n    const image = new Image();\n    image.crossOrigin = crossOrigin;\n\n    return load(image, src).then((image) => {\n      // Update resolution, because the server may return a smaller size than requested\n      const resolution = (getWidth(extent) / image.width) * pixelRatio;\n      return {image, extent, resolution, pixelRatio};\n    });\n  };\n}\n"],"names":["getRequestUrl","baseUrl","extent","resolution","pixelRatio","projection","params","srid","imageResolution","imageSize","round","getWidth","DECIMALS","getHeight","modifiedUrl","appendParams","createLoader","options","load","decode","getProjection","ratio","crossOrigin","getRequestExtent","src","image"],"mappings":"0nBAqBO,SAASA,EACdC,EACAC,EACAC,EACAC,EACAC,EACAC,EACA,CAIA,MAAMC,EAAOF,EACV,QAAO,EACP,MAAM,WAAW,EACjB,IAAG,EAEAG,EAAkBL,EAAaC,EAE/BK,EAAY,CAChBC,EAAMC,EAAST,CAAM,EAAIM,EAAiBI,CAAQ,EAClDF,EAAMG,EAAUX,CAAM,EAAIM,EAAiBI,CAAQ,CACvD,EAEEN,EAAO,KAAUG,EAAU,CAAC,EAAI,IAAMA,EAAU,CAAC,EACjDH,EAAO,KAAUJ,EAAO,KAAK,GAAG,EAChCI,EAAO,OAAYC,EACnBD,EAAO,QAAaC,EACpBD,EAAO,IAAS,KAAK,MACnBA,EAAO,IAASA,EAAO,IAASF,EAAa,GAAKA,CACtD,EAEE,MAAMU,EAAcb,EACjB,QAAQ,gBAAiB,kBAAkB,EAC3C,QAAQ,kBAAmB,yBAAyB,EACvD,OAAOc,EAAaD,EAAaR,CAAM,CACzC,CAiCO,SAASU,EAAaC,EAAS,CACpC,MAAMC,EAAOD,EAAQ,KAAOA,EAAQ,KAAOE,EACrCd,EAAae,EAAcH,EAAQ,YAAc,WAAW,EAC5DI,EAAQJ,EAAQ,OAAS,IACzBK,EAAcL,EAAQ,aAAe,KAE3C,OAAO,SAAUf,EAAQC,EAAYC,EAAY,CAC/CA,EAAaa,EAAQ,MAAQb,EAAa,EAE1C,MAAME,EAAS,CACb,EAAK,QACL,OAAU,QACV,YAAe,EACrB,EACI,OAAO,OAAOA,EAAQW,EAAQ,MAAM,EAEpCf,EAASqB,EAAiBrB,EAAQC,EAAYC,EAAYiB,CAAK,EAE/D,MAAMG,EAAMxB,EACViB,EAAQ,IACRf,EACAC,EACAC,EACAC,EACAC,CACN,EAEUmB,EAAQ,IAAI,MAClB,OAAAA,EAAM,YAAcH,EAEbJ,EAAKO,EAAOD,CAAG,EAAE,KAAMC,GAAU,CAEtC,MAAMtB,EAAcQ,EAAST,CAAM,EAAIuB,EAAM,MAASrB,EACtD,MAAO,CAAC,MAAAqB,EAAO,OAAAvB,EAAQ,WAAAC,EAAY,WAAAC,CAAU,CAC/C,CAAC,CACH,CACF","x_google_ignoreList":[0]}