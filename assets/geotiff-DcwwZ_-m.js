const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/raw-in9isEBO.js","assets/basedecoder-B2c5_Eok.js","assets/lzw-_aCqfs4w.js","assets/jpeg-vtRboCKw.js","assets/deflate-B9JhHpvg.js","assets/pako.esm-Cram60i4.js","assets/packbits-DDWKfGV_.js","assets/lerc-kyYYvnXL.js","assets/_commonjsHelpers-CE1G-McA.js","assets/index-B3F0456b.js","assets/utils-BXWzvTjY.js","assets/I18N-DlIXJTel.js","assets/index-BchvTk2E.css","assets/__vite-browser-external-B1O5LaIO.js","assets/webimage-DBgUwIbt.js","assets/decoder-DMxg__z_.js"])))=>i.map(i=>d[i]);
import{bu as C,ct}from"./index-B3F0456b.js";import{g as ve}from"./_commonjsHelpers-CE1G-McA.js";import le from"./__vite-browser-external-B1O5LaIO.js";function T(i){return(e,...t)=>ht(i,e,t)}function G(i,e){return T(Ge(i,e).get)}const{apply:ht,getOwnPropertyDescriptor:Ge,getPrototypeOf:ye,ownKeys:ft}=Reflect,{iterator:Y,toStringTag:ut}=Symbol,dt=Object,{create:pe,defineProperty:gt}=dt,yt=Array,pt=yt.prototype,Ue=pt[Y],mt=T(Ue),Le=ArrayBuffer,xt=Le.prototype;G(xt,"byteLength");const _e=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:null;_e&&G(_e.prototype,"byteLength");const Ne=ye(Uint8Array);Ne.from;const A=Ne.prototype;A[Y];T(A.keys);T(A.values);T(A.entries);T(A.set);T(A.reverse);T(A.fill);T(A.copyWithin);T(A.sort);T(A.slice);T(A.subarray);G(A,"buffer");G(A,"byteOffset");G(A,"length");G(A,ut);const wt=Uint8Array,Ve=Uint16Array,me=Uint32Array,bt=Float32Array,j=ye([][Y]()),ze=T(j.next),It=T((function*(){})().next),St=ye(j),Tt=DataView.prototype,Dt=T(Tt.getUint16),xe=WeakMap,qe=xe.prototype,Ke=T(qe.get),At=T(qe.set),je=new xe,Et=pe(null,{next:{value:function(){const e=Ke(je,this);return ze(e)}},[Y]:{value:function(){return this}}});function _t(i){if(i[Y]===Ue&&j.next===ze)return i;const e=pe(Et);return At(je,e,mt(i)),e}const Pt=new xe,Ft=pe(St,{next:{value:function(){const e=Ke(Pt,this);return It(e)},writable:!0,configurable:!0}});for(const i of ft(j))i!=="next"&&gt(Ft,i,Ge(j,i));const Ye=new Le(4),kt=new bt(Ye),Ct=new me(Ye),P=new Ve(512),F=new wt(512);for(let i=0;i<256;++i){const e=i-127;e<-24?(P[i]=0,P[i|256]=32768,F[i]=24,F[i|256]=24):e<-14?(P[i]=1024>>-e-14,P[i|256]=1024>>-e-14|32768,F[i]=-e-1,F[i|256]=-e-1):e<=15?(P[i]=e+15<<10,P[i|256]=e+15<<10|32768,F[i]=13,F[i|256]=13):e<128?(P[i]=31744,P[i|256]=64512,F[i]=24,F[i|256]=24):(P[i]=31744,P[i|256]=64512,F[i]=13,F[i|256]=13)}const we=new me(2048);for(let i=1;i<1024;++i){let e=i<<13,t=0;for(;(e&8388608)===0;)e<<=1,t-=8388608;e&=-8388609,t+=947912704,we[i]=e|t}for(let i=1024;i<2048;++i)we[i]=939524096+(i-1024<<13);const U=new me(64);for(let i=1;i<31;++i)U[i]=i<<23;U[31]=1199570944;U[32]=2147483648;for(let i=33;i<63;++i)U[i]=2147483648+(i-32<<23);U[63]=3347054592;const He=new Ve(64);for(let i=1;i<64;++i)i!==32&&(He[i]=1024);function Ot(i){const e=i>>10;return Ct[0]=we[He[e]+(i&1023)]+U[e],kt[0]}function Xe(i,e,...t){return Ot(Dt(i,e,..._t(t)))}var Q={exports:{}},Pe;function Mt(){if(Pe)return Q.exports;Pe=1;function i(e,t,r){const s=r&&r.debug||!1;s&&console.log("[xml-utils] getting "+t+" in "+e);const n=typeof e=="object"?e.outer:e,o=n.slice(0,n.indexOf(">")+1),a=['"',"'"];for(let l=0;l<a.length;l++){const c=a[l],h=t+"\\="+c+"([^"+c+"]*)"+c;s&&console.log("[xml-utils] pattern:",h);const u=new RegExp(h).exec(o);if(s&&console.log("[xml-utils] match:",u),u)return u[1]}}return Q.exports=i,Q.exports.default=i,Q.exports}var Rt=Mt();const ce=ve(Rt);var W={exports:{}},ee={exports:{}},te={exports:{}},Fe;function Bt(){if(Fe)return te.exports;Fe=1;function i(e,t,r){const n=new RegExp(t).exec(e.slice(r));return n?r+n.index:-1}return te.exports=i,te.exports.default=i,te.exports}var re={exports:{}},ke;function vt(){if(ke)return re.exports;ke=1;function i(e,t,r){const n=new RegExp(t).exec(e.slice(r));return n?r+n.index+n[0].length-1:-1}return re.exports=i,re.exports.default=i,re.exports}var se={exports:{}},Ce;function Gt(){if(Ce)return se.exports;Ce=1;function i(e,t){const r=new RegExp(t,"g"),s=e.match(r);return s?s.length:0}return se.exports=i,se.exports.default=i,se.exports}var Oe;function Ut(){if(Oe)return ee.exports;Oe=1;const i=Bt(),e=vt(),t=Gt();function r(s,n,o){const a=o&&o.debug||!1,l=!(o&&typeof o.nested===!1),c=o&&o.startIndex||0;a&&console.log("[xml-utils] starting findTagByName with",n," and ",o);const h=i(s,`<${n}[ 
>/]`,c);if(a&&console.log("[xml-utils] start:",h),h===-1)return;const f=s.slice(h+n.length);let u=e(f,"^[^<]*[ /]>",0);const g=u!==-1&&f[u-1]==="/";if(a&&console.log("[xml-utils] selfClosing:",g),g===!1)if(l){let w=0,m=1,b=0;for(;(u=e(f,"[ /]"+n+">",w))!==-1;){const I=f.substring(w,u+1);if(m+=t(I,"<"+n+`[ 
	>]`),b+=t(I,"</"+n+">"),b>=m)break;w=u}}else u=e(f,"[ /]"+n+">",0);const d=h+n.length+u+1;if(a&&console.log("[xml-utils] end:",d),d===-1)return;const p=s.slice(h,d);let y;return g?y=null:y=p.slice(p.indexOf(">")+1,p.lastIndexOf("<")),{inner:y,outer:p,start:h,end:d}}return ee.exports=r,ee.exports.default=r,ee.exports}var Me;function Lt(){if(Me)return W.exports;Me=1;const i=Ut();function e(t,r,s){const n=[],o=s&&s.debug||!1,a=s&&typeof s.nested=="boolean"?s.nested:!0;let l=s&&s.startIndex||0,c;for(;c=i(t,r,{debug:o,startIndex:l});)a?l=c.start+1+r.length:l=c.end,n.push(c);return o&&console.log("findTagsByName found",n.length,"tags"),n}return W.exports=e,W.exports.default=e,W.exports}var Nt=Lt();const Vt=ve(Nt),K={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop",33550:"ModelPixelScale",33922:"ModelTiepoint",34264:"ModelTransformation",34735:"GeoKeyDirectory",34736:"GeoDoubleParams",34737:"GeoAsciiParams",50674:"LercParameters"},k={};for(const i in K)K.hasOwnProperty(i)&&(k[K[i]]=parseInt(i,10));const zt=[k.BitsPerSample,k.ExtraSamples,k.SampleFormat,k.StripByteCounts,k.StripOffsets,k.StripRowCounts,k.TileByteCounts,k.TileOffsets,k.SubIFDs],he={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE",13:"IFD",16:"LONG8",17:"SLONG8",18:"IFD8"},x={};for(const i in he)he.hasOwnProperty(i)&&(x[he[i]]=parseInt(i,10));const _={WhiteIsZero:0,BlackIsZero:1,RGB:2,Palette:3,CMYK:5,YCbCr:6,CIELab:8,ICCLab:9},qt={Unspecified:0},Lr={AddCompression:1},Nr={None:0,Deflate:1,Zstandard:2},Kt={1024:"GTModelTypeGeoKey",1025:"GTRasterTypeGeoKey",1026:"GTCitationGeoKey",2048:"GeographicTypeGeoKey",2049:"GeogCitationGeoKey",2050:"GeogGeodeticDatumGeoKey",2051:"GeogPrimeMeridianGeoKey",2052:"GeogLinearUnitsGeoKey",2053:"GeogLinearUnitSizeGeoKey",2054:"GeogAngularUnitsGeoKey",2055:"GeogAngularUnitSizeGeoKey",2056:"GeogEllipsoidGeoKey",2057:"GeogSemiMajorAxisGeoKey",2058:"GeogSemiMinorAxisGeoKey",2059:"GeogInvFlatteningGeoKey",2060:"GeogAzimuthUnitsGeoKey",2061:"GeogPrimeMeridianLongGeoKey",2062:"GeogTOWGS84GeoKey",3072:"ProjectedCSTypeGeoKey",3073:"PCSCitationGeoKey",3074:"ProjectionGeoKey",3075:"ProjCoordTransGeoKey",3076:"ProjLinearUnitsGeoKey",3077:"ProjLinearUnitSizeGeoKey",3078:"ProjStdParallel1GeoKey",3079:"ProjStdParallel2GeoKey",3080:"ProjNatOriginLongGeoKey",3081:"ProjNatOriginLatGeoKey",3082:"ProjFalseEastingGeoKey",3083:"ProjFalseNorthingGeoKey",3084:"ProjFalseOriginLongGeoKey",3085:"ProjFalseOriginLatGeoKey",3086:"ProjFalseOriginEastingGeoKey",3087:"ProjFalseOriginNorthingGeoKey",3088:"ProjCenterLongGeoKey",3089:"ProjCenterLatGeoKey",3090:"ProjCenterEastingGeoKey",3091:"ProjCenterNorthingGeoKey",3092:"ProjScaleAtNatOriginGeoKey",3093:"ProjScaleAtCenterGeoKey",3094:"ProjAzimuthAngleGeoKey",3095:"ProjStraightVertPoleLongGeoKey",3096:"ProjRectifiedGridAngleGeoKey",4096:"VerticalCSTypeGeoKey",4097:"VerticalCitationGeoKey",4098:"VerticalDatumGeoKey",4099:"VerticalUnitsGeoKey"};function jt(i,e){const{width:t,height:r}=i,s=new Uint8Array(t*r*3);let n;for(let o=0,a=0;o<i.length;++o,a+=3)n=256-i[o]/e*256,s[a]=n,s[a+1]=n,s[a+2]=n;return s}function Yt(i,e){const{width:t,height:r}=i,s=new Uint8Array(t*r*3);let n;for(let o=0,a=0;o<i.length;++o,a+=3)n=i[o]/e*256,s[a]=n,s[a+1]=n,s[a+2]=n;return s}function Ht(i,e){const{width:t,height:r}=i,s=new Uint8Array(t*r*3),n=e.length/3,o=e.length/3*2;for(let a=0,l=0;a<i.length;++a,l+=3){const c=i[a];s[l]=e[c]/65536*256,s[l+1]=e[c+n]/65536*256,s[l+2]=e[c+o]/65536*256}return s}function Xt(i){const{width:e,height:t}=i,r=new Uint8Array(e*t*3);for(let s=0,n=0;s<i.length;s+=4,n+=3){const o=i[s],a=i[s+1],l=i[s+2],c=i[s+3];r[n]=255*((255-o)/256)*((255-c)/256),r[n+1]=255*((255-a)/256)*((255-c)/256),r[n+2]=255*((255-l)/256)*((255-c)/256)}return r}function $t(i){const{width:e,height:t}=i,r=new Uint8ClampedArray(e*t*3);for(let s=0,n=0;s<i.length;s+=3,n+=3){const o=i[s],a=i[s+1],l=i[s+2];r[n]=o+1.402*(l-128),r[n+1]=o-.34414*(a-128)-.71414*(l-128),r[n+2]=o+1.772*(a-128)}return r}const Zt=.95047,Jt=1,Qt=1.08883;function Wt(i){const{width:e,height:t}=i,r=new Uint8Array(e*t*3);for(let s=0,n=0;s<i.length;s+=3,n+=3){const o=i[s+0],a=i[s+1]<<24>>24,l=i[s+2]<<24>>24;let c=(o+16)/116,h=a/500+c,f=c-l/200,u,g,d;h=Zt*(h*h*h>.008856?h*h*h:(h-16/116)/7.787),c=Jt*(c*c*c>.008856?c*c*c:(c-16/116)/7.787),f=Qt*(f*f*f>.008856?f*f*f:(f-16/116)/7.787),u=h*3.2406+c*-1.5372+f*-.4986,g=h*-.9689+c*1.8758+f*.0415,d=h*.0557+c*-.204+f*1.057,u=u>.0031308?1.055*u**(1/2.4)-.055:12.92*u,g=g>.0031308?1.055*g**(1/2.4)-.055:12.92*g,d=d>.0031308?1.055*d**(1/2.4)-.055:12.92*d,r[n]=Math.max(0,Math.min(1,u))*255,r[n+1]=Math.max(0,Math.min(1,g))*255,r[n+2]=Math.max(0,Math.min(1,d))*255}return r}const $e=new Map;function O(i,e){Array.isArray(i)||(i=[i]),i.forEach(t=>$e.set(t,e))}async function Ze(i){const e=$e.get(i.Compression);if(!e)throw new Error(`Unknown compression method identifier: ${i.Compression}`);const t=await e();return new t(i)}O([void 0,1],()=>C(()=>import("./raw-in9isEBO.js"),__vite__mapDeps([0,1])).then(i=>i.default));O(5,()=>C(()=>import("./lzw-_aCqfs4w.js"),__vite__mapDeps([2,1])).then(i=>i.default));O(6,()=>{throw new Error("old style JPEG compression is not supported.")});O(7,()=>C(()=>import("./jpeg-vtRboCKw.js"),__vite__mapDeps([3,1])).then(i=>i.default));O([8,32946],()=>C(()=>import("./deflate-B9JhHpvg.js"),__vite__mapDeps([4,5,1])).then(i=>i.default));O(32773,()=>C(()=>import("./packbits-DDWKfGV_.js"),__vite__mapDeps([6,1])).then(i=>i.default));O(34887,()=>C(()=>import("./lerc-kyYYvnXL.js"),__vite__mapDeps([7,5,8,9,10,11,12,1,13])).then(async i=>(await i.zstd.init(),i)).then(i=>i.default));O(50001,()=>C(()=>import("./webimage-DBgUwIbt.js"),__vite__mapDeps([14,1])).then(i=>i.default));function ne(i,e,t,r=1){return new(Object.getPrototypeOf(i)).constructor(e*t*r)}function er(i,e,t,r,s){const n=e/r,o=t/s;return i.map(a=>{const l=ne(a,r,s);for(let c=0;c<s;++c){const h=Math.min(Math.round(o*c),t-1);for(let f=0;f<r;++f){const u=Math.min(Math.round(n*f),e-1),g=a[h*e+u];l[c*r+f]=g}}return l})}function R(i,e,t){return(1-t)*i+t*e}function tr(i,e,t,r,s){const n=e/r,o=t/s;return i.map(a=>{const l=ne(a,r,s);for(let c=0;c<s;++c){const h=o*c,f=Math.floor(h),u=Math.min(Math.ceil(h),t-1);for(let g=0;g<r;++g){const d=n*g,p=d%1,y=Math.floor(d),w=Math.min(Math.ceil(d),e-1),m=a[f*e+y],b=a[f*e+w],I=a[u*e+y],S=a[u*e+w],E=R(R(m,b,p),R(I,S,p),h%1);l[c*r+g]=E}}return l})}function rr(i,e,t,r,s,n="nearest"){switch(n.toLowerCase()){case"nearest":return er(i,e,t,r,s);case"bilinear":case"linear":return tr(i,e,t,r,s);default:throw new Error(`Unsupported resampling method: '${n}'`)}}function sr(i,e,t,r,s,n){const o=e/r,a=t/s,l=ne(i,r,s,n);for(let c=0;c<s;++c){const h=Math.min(Math.round(a*c),t-1);for(let f=0;f<r;++f){const u=Math.min(Math.round(o*f),e-1);for(let g=0;g<n;++g){const d=i[h*e*n+u*n+g];l[c*r*n+f*n+g]=d}}}return l}function ir(i,e,t,r,s,n){const o=e/r,a=t/s,l=ne(i,r,s,n);for(let c=0;c<s;++c){const h=a*c,f=Math.floor(h),u=Math.min(Math.ceil(h),t-1);for(let g=0;g<r;++g){const d=o*g,p=d%1,y=Math.floor(d),w=Math.min(Math.ceil(d),e-1);for(let m=0;m<n;++m){const b=i[f*e*n+y*n+m],I=i[f*e*n+w*n+m],S=i[u*e*n+y*n+m],E=i[u*e*n+w*n+m],L=R(R(b,I,p),R(S,E,p),h%1);l[c*r*n+g*n+m]=L}}}return l}function nr(i,e,t,r,s,n,o="nearest"){switch(o.toLowerCase()){case"nearest":return sr(i,e,t,r,s,n);case"bilinear":case"linear":return ir(i,e,t,r,s,n);default:throw new Error(`Unsupported resampling method: '${o}'`)}}function or(i,e,t){let r=0;for(let s=e;s<t;++s)r+=i[s];return r}function fe(i,e,t){switch(i){case 1:if(e<=8)return new Uint8Array(t);if(e<=16)return new Uint16Array(t);if(e<=32)return new Uint32Array(t);break;case 2:if(e===8)return new Int8Array(t);if(e===16)return new Int16Array(t);if(e===32)return new Int32Array(t);break;case 3:switch(e){case 16:case 32:return new Float32Array(t);case 64:return new Float64Array(t)}break}throw Error("Unsupported data format/bitsPerSample")}function ar(i,e){return(i===1||i===2)&&e<=32&&e%8===0?!1:!(i===3&&(e===16||e===32||e===64))}function lr(i,e,t,r,s,n,o){const a=new DataView(i),l=t===2?o*n:o*n*r,c=t===2?1:r,h=fe(e,s,l),f=parseInt("1".repeat(s),2);if(e===1){let u;t===1?u=r*s:u=s;let g=n*u;(g&7)!==0&&(g=g+7&-8);for(let d=0;d<o;++d){const p=d*g;for(let y=0;y<n;++y){const w=p+y*c*s;for(let m=0;m<c;++m){const b=w+m*s,I=(d*n+y)*c+m,S=Math.floor(b/8),E=b%8;if(E+s<=8)h[I]=a.getUint8(S)>>8-s-E&f;else if(E+s<=16)h[I]=a.getUint16(S)>>16-s-E&f;else if(E+s<=24){const L=a.getUint16(S)<<8|a.getUint8(S+2);h[I]=L>>24-s-E&f}else h[I]=a.getUint32(S)>>32-s-E&f}}}}return h.buffer}class Je{constructor(e,t,r,s,n,o){this.fileDirectory=e,this.geoKeys=t,this.dataView=r,this.littleEndian=s,this.tiles=n?{}:null,this.isTiled=!e.StripOffsets;const a=e.PlanarConfiguration;if(this.planarConfiguration=typeof a>"u"?1:a,this.planarConfiguration!==1&&this.planarConfiguration!==2)throw new Error("Invalid planar configuration.");this.source=o}getFileDirectory(){return this.fileDirectory}getGeoKeys(){return this.geoKeys}getWidth(){return this.fileDirectory.ImageWidth}getHeight(){return this.fileDirectory.ImageLength}getSamplesPerPixel(){return typeof this.fileDirectory.SamplesPerPixel<"u"?this.fileDirectory.SamplesPerPixel:1}getTileWidth(){return this.isTiled?this.fileDirectory.TileWidth:this.getWidth()}getTileHeight(){return this.isTiled?this.fileDirectory.TileLength:typeof this.fileDirectory.RowsPerStrip<"u"?Math.min(this.fileDirectory.RowsPerStrip,this.getHeight()):this.getHeight()}getBlockWidth(){return this.getTileWidth()}getBlockHeight(e){return this.isTiled||(e+1)*this.getTileHeight()<=this.getHeight()?this.getTileHeight():this.getHeight()-e*this.getTileHeight()}getBytesPerPixel(){let e=0;for(let t=0;t<this.fileDirectory.BitsPerSample.length;++t)e+=this.getSampleByteSize(t);return e}getSampleByteSize(e){if(e>=this.fileDirectory.BitsPerSample.length)throw new RangeError(`Sample index ${e} is out of range.`);return Math.ceil(this.fileDirectory.BitsPerSample[e]/8)}getReaderForSample(e){const t=this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1,r=this.fileDirectory.BitsPerSample[e];switch(t){case 1:if(r<=8)return DataView.prototype.getUint8;if(r<=16)return DataView.prototype.getUint16;if(r<=32)return DataView.prototype.getUint32;break;case 2:if(r<=8)return DataView.prototype.getInt8;if(r<=16)return DataView.prototype.getInt16;if(r<=32)return DataView.prototype.getInt32;break;case 3:switch(r){case 16:return function(s,n){return Xe(this,s,n)};case 32:return DataView.prototype.getFloat32;case 64:return DataView.prototype.getFloat64}break}throw Error("Unsupported data format/bitsPerSample")}getSampleFormat(e=0){return this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1}getBitsPerSample(e=0){return this.fileDirectory.BitsPerSample[e]}getArrayForSample(e,t){const r=this.getSampleFormat(e),s=this.getBitsPerSample(e);return fe(r,s,t)}async getTileOrStrip(e,t,r,s,n){const o=Math.ceil(this.getWidth()/this.getTileWidth()),a=Math.ceil(this.getHeight()/this.getTileHeight());let l;const{tiles:c}=this;this.planarConfiguration===1?l=t*o+e:this.planarConfiguration===2&&(l=r*o*a+t*o+e);let h,f;this.isTiled?(h=this.fileDirectory.TileOffsets[l],f=this.fileDirectory.TileByteCounts[l]):(h=this.fileDirectory.StripOffsets[l],f=this.fileDirectory.StripByteCounts[l]);const u=(await this.source.fetch([{offset:h,length:f}],n))[0];let g;return c===null||!c[l]?(g=(async()=>{let d=await s.decode(this.fileDirectory,u);const p=this.getSampleFormat(),y=this.getBitsPerSample();return ar(p,y)&&(d=lr(d,p,this.planarConfiguration,this.getSamplesPerPixel(),y,this.getTileWidth(),this.getBlockHeight(t))),d})(),c!==null&&(c[l]=g)):g=c[l],{x:e,y:t,sample:r,data:await g}}async _readRaster(e,t,r,s,n,o,a,l,c){const h=this.getTileWidth(),f=this.getTileHeight(),u=this.getWidth(),g=this.getHeight(),d=Math.max(Math.floor(e[0]/h),0),p=Math.min(Math.ceil(e[2]/h),Math.ceil(u/h)),y=Math.max(Math.floor(e[1]/f),0),w=Math.min(Math.ceil(e[3]/f),Math.ceil(g/f)),m=e[2]-e[0];let b=this.getBytesPerPixel();const I=[],S=[];for(let D=0;D<t.length;++D)this.planarConfiguration===1?I.push(or(this.fileDirectory.BitsPerSample,0,t[D])/8):I.push(0),S.push(this.getReaderForSample(t[D]));const E=[],{littleEndian:L}=this;for(let D=y;D<w;++D)for(let H=d;H<p;++H){let oe;this.planarConfiguration===1&&(oe=this.getTileOrStrip(H,D,0,n,c));for(let X=0;X<t.length;++X){const $=X,Ae=t[X];this.planarConfiguration===2&&(b=this.getSampleByteSize(Ae),oe=this.getTileOrStrip(H,D,Ae,n,c));const et=oe.then(N=>{const tt=N.data,rt=new DataView(tt),ae=this.getBlockHeight(N.y),V=N.y*f,Z=N.x*h,st=V+ae,it=(N.x+1)*h,nt=S[$],ot=Math.min(ae,ae-(st-e[3]),g-V),at=Math.min(h,h-(it-e[2]),u-Z);for(let z=Math.max(0,e[1]-V);z<ot;++z)for(let q=Math.max(0,e[0]-Z);q<at;++q){const lt=(z*h+q)*b,Ee=nt.call(rt,lt+I[$],L);let J;s?(J=(z+V-e[1])*m*t.length+(q+Z-e[0])*t.length+$,r[J]=Ee):(J=(z+V-e[1])*m+q+Z-e[0],r[$][J]=Ee)}});E.push(et)}}if(await Promise.all(E),o&&e[2]-e[0]!==o||a&&e[3]-e[1]!==a){let D;return s?D=nr(r,e[2]-e[0],e[3]-e[1],o,a,t.length,l):D=rr(r,e[2]-e[0],e[3]-e[1],o,a,l),D.width=o,D.height=a,D}return r.width=o||e[2]-e[0],r.height=a||e[3]-e[1],r}async readRasters({window:e,samples:t=[],interleave:r,pool:s=null,width:n,height:o,resampleMethod:a,fillValue:l,signal:c}={}){const h=e||[0,0,this.getWidth(),this.getHeight()];if(h[0]>h[2]||h[1]>h[3])throw new Error("Invalid subsets");const f=h[2]-h[0],u=h[3]-h[1],g=f*u,d=this.getSamplesPerPixel();if(!t||!t.length)for(let m=0;m<d;++m)t.push(m);else for(let m=0;m<t.length;++m)if(t[m]>=d)return Promise.reject(new RangeError(`Invalid sample index '${t[m]}'.`));let p;if(r){const m=this.fileDirectory.SampleFormat?Math.max.apply(null,this.fileDirectory.SampleFormat):1,b=Math.max.apply(null,this.fileDirectory.BitsPerSample);p=fe(m,b,g*t.length),l&&p.fill(l)}else{p=[];for(let m=0;m<t.length;++m){const b=this.getArrayForSample(t[m],g);Array.isArray(l)&&m<l.length?b.fill(l[m]):l&&!Array.isArray(l)&&b.fill(l),p.push(b)}}const y=s||await Ze(this.fileDirectory);return await this._readRaster(h,t,p,r,y,n,o,a,c)}async readRGB({window:e,interleave:t=!0,pool:r=null,width:s,height:n,resampleMethod:o,enableAlpha:a=!1,signal:l}={}){const c=e||[0,0,this.getWidth(),this.getHeight()];if(c[0]>c[2]||c[1]>c[3])throw new Error("Invalid subsets");const h=this.fileDirectory.PhotometricInterpretation;if(h===_.RGB){let w=[0,1,2];if(this.fileDirectory.ExtraSamples!==qt.Unspecified&&a){w=[];for(let m=0;m<this.fileDirectory.BitsPerSample.length;m+=1)w.push(m)}return this.readRasters({window:e,interleave:t,samples:w,pool:r,width:s,height:n,resampleMethod:o,signal:l})}let f;switch(h){case _.WhiteIsZero:case _.BlackIsZero:case _.Palette:f=[0];break;case _.CMYK:f=[0,1,2,3];break;case _.YCbCr:case _.CIELab:f=[0,1,2];break;default:throw new Error("Invalid or unsupported photometric interpretation.")}const u={window:c,interleave:!0,samples:f,pool:r,width:s,height:n,resampleMethod:o,signal:l},{fileDirectory:g}=this,d=await this.readRasters(u),p=2**this.fileDirectory.BitsPerSample[0];let y;switch(h){case _.WhiteIsZero:y=jt(d,p);break;case _.BlackIsZero:y=Yt(d,p);break;case _.Palette:y=Ht(d,g.ColorMap);break;case _.CMYK:y=Xt(d);break;case _.YCbCr:y=$t(d);break;case _.CIELab:y=Wt(d);break;default:throw new Error("Unsupported photometric interpretation.")}if(!t){const w=new Uint8Array(y.length/3),m=new Uint8Array(y.length/3),b=new Uint8Array(y.length/3);for(let I=0,S=0;I<y.length;I+=3,++S)w[S]=y[I],m[S]=y[I+1],b[S]=y[I+2];y=[w,m,b]}return y.width=d.width,y.height=d.height,y}getTiePoints(){if(!this.fileDirectory.ModelTiepoint)return[];const e=[];for(let t=0;t<this.fileDirectory.ModelTiepoint.length;t+=6)e.push({i:this.fileDirectory.ModelTiepoint[t],j:this.fileDirectory.ModelTiepoint[t+1],k:this.fileDirectory.ModelTiepoint[t+2],x:this.fileDirectory.ModelTiepoint[t+3],y:this.fileDirectory.ModelTiepoint[t+4],z:this.fileDirectory.ModelTiepoint[t+5]});return e}getGDALMetadata(e=null){const t={};if(!this.fileDirectory.GDAL_METADATA)return null;const r=this.fileDirectory.GDAL_METADATA;let s=Vt(r,"Item");e===null?s=s.filter(n=>ce(n,"sample")===void 0):s=s.filter(n=>Number(ce(n,"sample"))===e);for(let n=0;n<s.length;++n){const o=s[n];t[ce(o,"name")]=o.inner}return t}getGDALNoData(){if(!this.fileDirectory.GDAL_NODATA)return null;const e=this.fileDirectory.GDAL_NODATA;return Number(e.substring(0,e.length-1))}getOrigin(){const e=this.fileDirectory.ModelTiepoint,t=this.fileDirectory.ModelTransformation;if(e&&e.length===6)return[e[3],e[4],e[5]];if(t)return[t[3],t[7],t[11]];throw new Error("The image does not have an affine transformation.")}getResolution(e=null){const t=this.fileDirectory.ModelPixelScale,r=this.fileDirectory.ModelTransformation;if(t)return[t[0],-t[1],t[2]];if(r)return r[1]===0&&r[4]===0?[r[0],-r[5],r[10]]:[Math.sqrt(r[0]*r[0]+r[4]*r[4]),-Math.sqrt(r[1]*r[1]+r[5]*r[5]),r[10]];if(e){const[s,n,o]=e.getResolution();return[s*e.getWidth()/this.getWidth(),n*e.getHeight()/this.getHeight(),o*e.getWidth()/this.getWidth()]}throw new Error("The image does not have an affine transformation.")}pixelIsArea(){return this.geoKeys.GTRasterTypeGeoKey===1}getBoundingBox(e=!1){const t=this.getHeight(),r=this.getWidth();if(this.fileDirectory.ModelTransformation&&!e){const[s,n,o,a,l,c,h,f]=this.fileDirectory.ModelTransformation,g=[[0,0],[0,t],[r,0],[r,t]].map(([y,w])=>[a+s*y+n*w,f+l*y+c*w]),d=g.map(y=>y[0]),p=g.map(y=>y[1]);return[Math.min(...d),Math.min(...p),Math.max(...d),Math.max(...p)]}else{const s=this.getOrigin(),n=this.getResolution(),o=s[0],a=s[1],l=o+n[0]*r,c=a+n[1]*t;return[Math.min(o,l),Math.min(a,c),Math.max(o,l),Math.max(a,c)]}}}class cr{constructor(e){this._dataView=new DataView(e)}get buffer(){return this._dataView.buffer}getUint64(e,t){const r=this.getUint32(e,t),s=this.getUint32(e+4,t);let n;if(t){if(n=r+2**32*s,!Number.isSafeInteger(n))throw new Error(`${n} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return n}if(n=2**32*r+s,!Number.isSafeInteger(n))throw new Error(`${n} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return n}getInt64(e,t){let r=0;const s=(this._dataView.getUint8(e+(t?7:0))&128)>0;let n=!0;for(let o=0;o<8;o++){let a=this._dataView.getUint8(e+(t?o:7-o));s&&(n?a!==0&&(a=~(a-1)&255,n=!1):a=~a&255),r+=a*256**o}return s&&(r=-r),r}getUint8(e,t){return this._dataView.getUint8(e,t)}getInt8(e,t){return this._dataView.getInt8(e,t)}getUint16(e,t){return this._dataView.getUint16(e,t)}getInt16(e,t){return this._dataView.getInt16(e,t)}getUint32(e,t){return this._dataView.getUint32(e,t)}getInt32(e,t){return this._dataView.getInt32(e,t)}getFloat16(e,t){return Xe(this._dataView,e,t)}getFloat32(e,t){return this._dataView.getFloat32(e,t)}getFloat64(e,t){return this._dataView.getFloat64(e,t)}}class hr{constructor(e,t,r,s){this._dataView=new DataView(e),this._sliceOffset=t,this._littleEndian=r,this._bigTiff=s}get sliceOffset(){return this._sliceOffset}get sliceTop(){return this._sliceOffset+this.buffer.byteLength}get littleEndian(){return this._littleEndian}get bigTiff(){return this._bigTiff}get buffer(){return this._dataView.buffer}covers(e,t){return this.sliceOffset<=e&&this.sliceTop>=e+t}readUint8(e){return this._dataView.getUint8(e-this._sliceOffset,this._littleEndian)}readInt8(e){return this._dataView.getInt8(e-this._sliceOffset,this._littleEndian)}readUint16(e){return this._dataView.getUint16(e-this._sliceOffset,this._littleEndian)}readInt16(e){return this._dataView.getInt16(e-this._sliceOffset,this._littleEndian)}readUint32(e){return this._dataView.getUint32(e-this._sliceOffset,this._littleEndian)}readInt32(e){return this._dataView.getInt32(e-this._sliceOffset,this._littleEndian)}readFloat32(e){return this._dataView.getFloat32(e-this._sliceOffset,this._littleEndian)}readFloat64(e){return this._dataView.getFloat64(e-this._sliceOffset,this._littleEndian)}readUint64(e){const t=this.readUint32(e),r=this.readUint32(e+4);let s;if(this._littleEndian){if(s=t+2**32*r,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}if(s=2**32*t+r,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}readInt64(e){let t=0;const r=(this._dataView.getUint8(e+(this._littleEndian?7:0))&128)>0;let s=!0;for(let n=0;n<8;n++){let o=this._dataView.getUint8(e+(this._littleEndian?n:7-n));r&&(s?o!==0&&(o=~(o-1)&255,s=!1):o=~o&255),t+=o*256**n}return r&&(t=-t),t}readOffset(e){return this._bigTiff?this.readUint64(e):this.readUint32(e)}}const fr=typeof navigator<"u"&&navigator.hardwareConcurrency||2;class Vr{constructor(e=fr,t){this.workers=null,this._awaitingDecoder=null,this.size=e,this.messageId=0,e&&(this._awaitingDecoder=t?Promise.resolve(t):new Promise(r=>{C(()=>import("./decoder-DMxg__z_.js"),__vite__mapDeps([15,9,10,8,11,12])).then(s=>{r(s.create)})}),this._awaitingDecoder.then(r=>{this._awaitingDecoder=null,this.workers=[];for(let s=0;s<e;s++)this.workers.push({worker:r(),idle:!0})}))}async decode(e,t){return this._awaitingDecoder&&await this._awaitingDecoder,this.size===0?Ze(e).then(r=>r.decode(e,t)):new Promise(r=>{const s=this.workers.find(a=>a.idle)||this.workers[Math.floor(Math.random()*this.size)];s.idle=!1;const n=this.messageId++,o=a=>{a.data.id===n&&(s.idle=!0,r(a.data.decoded),s.worker.removeEventListener("message",o))};s.worker.addEventListener("message",o),s.worker.postMessage({fileDirectory:e,buffer:t,id:n},[t])})}destroy(){this.workers&&(this.workers.forEach(e=>{e.worker.terminate()}),this.workers=null)}}const Re=`\r
\r
`;function Qe(i){if(typeof Object.fromEntries<"u")return Object.fromEntries(i);const e={};for(const[t,r]of i)e[t.toLowerCase()]=r;return e}function ur(i){const e=i.split(`\r
`).map(t=>{const r=t.split(":").map(s=>s.trim());return r[0]=r[0].toLowerCase(),r});return Qe(e)}function dr(i){const[e,...t]=i.split(";").map(s=>s.trim()),r=t.map(s=>s.split("="));return{type:e,params:Qe(r)}}function ue(i){let e,t,r;return i&&([,e,t,r]=i.match(/bytes (\d+)-(\d+)\/(\d+)/),e=parseInt(e,10),t=parseInt(t,10),r=parseInt(r,10)),{start:e,end:t,total:r}}function gr(i,e){let t=null;const r=new TextDecoder("ascii"),s=[],n=`--${e}`,o=`${n}--`;for(let a=0;a<10;++a)r.decode(new Uint8Array(i,a,n.length))===n&&(t=a);if(t===null)throw new Error("Could not find initial boundary");for(;t<i.byteLength;){const a=r.decode(new Uint8Array(i,t,Math.min(n.length+1024,i.byteLength-t)));if(a.length===0||a.startsWith(o))break;if(!a.startsWith(n))throw new Error("Part does not start with boundary");const l=a.substr(n.length+2);if(l.length===0)break;const c=l.indexOf(Re),h=ur(l.substr(0,c)),{start:f,end:u,total:g}=ue(h["content-range"]),d=t+n.length+c+Re.length,p=parseInt(u,10)+1-parseInt(f,10);s.push({headers:h,data:i.slice(d,d+p),offset:f,length:p,fileSize:g}),t=d+p+4}return s}class be{async fetch(e,t=void 0){return Promise.all(e.map(r=>this.fetchSlice(r,t)))}async fetchSlice(e){throw new Error(`fetching of slice ${e} not possible, not implemented`)}get fileSize(){return null}async close(){}}class yr extends Map{constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof e.maxAge=="number"&&e.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=e.maxSize,this.maxAge=e.maxAge||Number.POSITIVE_INFINITY,this.onEviction=e.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(e){if(typeof this.onEviction=="function")for(const[t,r]of e)this.onEviction(t,r.value)}_deleteIfExpired(e,t){return typeof t.expiry=="number"&&t.expiry<=Date.now()?(typeof this.onEviction=="function"&&this.onEviction(e,t.value),this.delete(e)):!1}_getOrDeleteIfExpired(e,t){if(this._deleteIfExpired(e,t)===!1)return t.value}_getItemValue(e,t){return t.expiry?this._getOrDeleteIfExpired(e,t):t.value}_peek(e,t){const r=t.get(e);return this._getItemValue(e,r)}_set(e,t){this.cache.set(e,t),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(e,t){this.oldCache.delete(e),this._set(e,t)}*_entriesAscending(){for(const e of this.oldCache){const[t,r]=e;this.cache.has(t)||this._deleteIfExpired(t,r)===!1&&(yield e)}for(const e of this.cache){const[t,r]=e;this._deleteIfExpired(t,r)===!1&&(yield e)}}get(e){if(this.cache.has(e)){const t=this.cache.get(e);return this._getItemValue(e,t)}if(this.oldCache.has(e)){const t=this.oldCache.get(e);if(this._deleteIfExpired(e,t)===!1)return this._moveToRecent(e,t),t.value}}set(e,t,{maxAge:r=this.maxAge}={}){const s=typeof r=="number"&&r!==Number.POSITIVE_INFINITY?Date.now()+r:void 0;return this.cache.has(e)?this.cache.set(e,{value:t,expiry:s}):this._set(e,{value:t,expiry:s}),this}has(e){return this.cache.has(e)?!this._deleteIfExpired(e,this.cache.get(e)):this.oldCache.has(e)?!this._deleteIfExpired(e,this.oldCache.get(e)):!1}peek(e){if(this.cache.has(e))return this._peek(e,this.cache);if(this.oldCache.has(e))return this._peek(e,this.oldCache)}delete(e){const t=this.cache.delete(e);return t&&this._size--,this.oldCache.delete(e)||t}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");const t=[...this._entriesAscending()],r=t.length-e;r<0?(this.cache=new Map(t),this.oldCache=new Map,this._size=t.length):(r>0&&this._emitEvictions(t.slice(0,r)),this.oldCache=new Map(t.slice(r)),this.cache=new Map,this._size=0),this.maxSize=e}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*[Symbol.iterator](){for(const e of this.cache){const[t,r]=e;this._deleteIfExpired(t,r)===!1&&(yield[t,r.value])}for(const e of this.oldCache){const[t,r]=e;this.cache.has(t)||this._deleteIfExpired(t,r)===!1&&(yield[t,r.value])}}*entriesDescending(){let e=[...this.cache];for(let t=e.length-1;t>=0;--t){const r=e[t],[s,n]=r;this._deleteIfExpired(s,n)===!1&&(yield[s,n.value])}e=[...this.oldCache];for(let t=e.length-1;t>=0;--t){const r=e[t],[s,n]=r;this.cache.has(s)||this._deleteIfExpired(s,n)===!1&&(yield[s,n.value])}}*entriesAscending(){for(const[e,t]of this._entriesAscending())yield[e,t.value]}get size(){if(!this._size)return this.oldCache.size;let e=0;for(const t of this.oldCache.keys())this.cache.has(t)||e++;return Math.min(this._size+e,this.maxSize)}entries(){return this.entriesAscending()}forEach(e,t=this){for(const[r,s]of this.entriesAscending())e.call(t,s,r,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}async function pr(i){return new Promise(e=>setTimeout(e,i))}function mr(i,e){const t=Array.isArray(i)?i:Array.from(i),r=Array.isArray(e)?e:Array.from(e);return t.map((s,n)=>[s,r[n]])}class B extends Error{constructor(e){super(e),Error.captureStackTrace&&Error.captureStackTrace(this,B),this.name="AbortError"}}class xr extends Error{constructor(e,t){super(t),this.errors=e,this.message=t,this.name="AggregateError"}}const wr=xr;class br{constructor(e,t,r=null){this.offset=e,this.length=t,this.data=r}get top(){return this.offset+this.length}}class Be{constructor(e,t,r){this.offset=e,this.length=t,this.blockIds=r}}class Ir extends be{constructor(e,{blockSize:t=65536,cacheSize:r=100}={}){super(),this.source=e,this.blockSize=t,this.blockCache=new yr({maxSize:r,onEviction:(s,n)=>{this.evictedBlocks.set(s,n)}}),this.evictedBlocks=new Map,this.blockRequests=new Map,this.blockIdsToFetch=new Set,this.abortedBlockIds=new Set}get fileSize(){return this.source.fileSize}async fetch(e,t){const r=[],s=[],n=[];this.evictedBlocks.clear();for(const{offset:u,length:g}of e){let d=u+g;const{fileSize:p}=this;p!==null&&(d=Math.min(d,p));const y=Math.floor(u/this.blockSize)*this.blockSize;for(let w=y;w<d;w+=this.blockSize){const m=Math.floor(w/this.blockSize);!this.blockCache.has(m)&&!this.blockRequests.has(m)&&(this.blockIdsToFetch.add(m),s.push(m)),this.blockRequests.has(m)&&r.push(this.blockRequests.get(m)),n.push(m)}}await pr(),this.fetchBlocks(t);const o=[];for(const u of s)this.blockRequests.has(u)&&o.push(this.blockRequests.get(u));await Promise.allSettled(r),await Promise.allSettled(o);const a=[],l=n.filter(u=>this.abortedBlockIds.has(u)||!this.blockCache.has(u));if(l.forEach(u=>this.blockIdsToFetch.add(u)),l.length>0&&t&&!t.aborted){this.fetchBlocks(null);for(const u of l){const g=this.blockRequests.get(u);if(!g)throw new Error(`Block ${u} is not in the block requests`);a.push(g)}await Promise.allSettled(a)}if(t&&t.aborted)throw new B("Request was aborted");const c=n.map(u=>this.blockCache.get(u)||this.evictedBlocks.get(u)),h=c.filter(u=>!u);if(h.length)throw new wr(h,"Request failed");const f=new Map(mr(n,c));return this.readSliceData(e,f)}fetchBlocks(e){if(this.blockIdsToFetch.size>0){const t=this.groupBlocks(this.blockIdsToFetch),r=this.source.fetch(t,e);for(let s=0;s<t.length;++s){const n=t[s];for(const o of n.blockIds)this.blockRequests.set(o,(async()=>{try{const a=(await r)[s],l=o*this.blockSize,c=l-a.offset,h=Math.min(c+this.blockSize,a.data.byteLength),f=a.data.slice(c,h),u=new br(l,f.byteLength,f,o);this.blockCache.set(o,u),this.abortedBlockIds.delete(o)}catch(a){if(a.name==="AbortError")a.signal=e,this.blockCache.delete(o),this.abortedBlockIds.add(o);else throw a}finally{this.blockRequests.delete(o)}})())}this.blockIdsToFetch.clear()}}groupBlocks(e){const t=Array.from(e).sort((o,a)=>o-a);if(t.length===0)return[];let r=[],s=null;const n=[];for(const o of t)s===null||s+1===o?(r.push(o),s=o):(n.push(new Be(r[0]*this.blockSize,r.length*this.blockSize,r)),r=[o],s=o);return n.push(new Be(r[0]*this.blockSize,r.length*this.blockSize,r)),n}readSliceData(e,t){return e.map(r=>{let s=r.offset+r.length;this.fileSize!==null&&(s=Math.min(this.fileSize,s));const n=Math.floor(r.offset/this.blockSize),o=Math.floor(s/this.blockSize),a=new ArrayBuffer(r.length),l=new Uint8Array(a);for(let c=n;c<=o;++c){const h=t.get(c),f=h.offset-r.offset,u=h.top-s;let g=0,d=0,p;f<0?g=-f:f>0&&(d=f),u<0?p=h.length-g:p=s-h.offset-g;const y=new Uint8Array(h.data,g,p);l.set(y,d)}return a})}}class Ie{get ok(){return this.status>=200&&this.status<=299}get status(){throw new Error("not implemented")}getHeader(e){throw new Error("not implemented")}async getData(){throw new Error("not implemented")}}class Se{constructor(e){this.url=e}async request({headers:e,signal:t}={}){throw new Error("request is not implemented")}}class Sr extends Ie{constructor(e){super(),this.response=e}get status(){return this.response.status}getHeader(e){return this.response.headers.get(e)}async getData(){return this.response.arrayBuffer?await this.response.arrayBuffer():(await this.response.buffer()).buffer}}class Tr extends Se{constructor(e,t){super(e),this.credentials=t}async request({headers:e,signal:t}={}){const r=await fetch(this.url,{headers:e,credentials:this.credentials,signal:t});return new Sr(r)}}class Dr extends Ie{constructor(e,t){super(),this.xhr=e,this.data=t}get status(){return this.xhr.status}getHeader(e){return this.xhr.getResponseHeader(e)}async getData(){return this.data}}class Ar extends Se{constructRequest(e,t){return new Promise((r,s)=>{const n=new XMLHttpRequest;n.open("GET",this.url),n.responseType="arraybuffer";for(const[o,a]of Object.entries(e))n.setRequestHeader(o,a);n.onload=()=>{const o=n.response;r(new Dr(n,o))},n.onerror=s,n.onabort=()=>s(new B("Request aborted")),n.send(),t&&(t.aborted&&n.abort(),t.addEventListener("abort",()=>n.abort()))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}class Er extends Ie{constructor(e,t){super(),this.response=e,this.dataPromise=t}get status(){return this.response.statusCode}getHeader(e){return this.response.headers[e]}async getData(){return await this.dataPromise}}class _r extends Se{constructor(e){super(e),this.parsedUrl=le.parse(this.url),this.httpApi=this.parsedUrl.protocol==="http:"?le:le}constructRequest(e,t){return new Promise((r,s)=>{const n=this.httpApi.get({...this.parsedUrl,headers:e},o=>{const a=new Promise(l=>{const c=[];o.on("data",h=>{c.push(h)}),o.on("end",()=>{const h=ct.concat(c).buffer;l(h)}),o.on("error",s)});r(new Er(o,a))});n.on("error",s),t&&(t.aborted&&n.destroy(new B("Request aborted")),t.addEventListener("abort",()=>n.destroy(new B("Request aborted"))))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}class Te extends be{constructor(e,t,r,s){super(),this.client=e,this.headers=t,this.maxRanges=r,this.allowFullFile=s,this._fileSize=null}async fetch(e,t){return this.maxRanges>=e.length?this.fetchSlices(e,t):(this.maxRanges>0&&e.length>1,Promise.all(e.map(r=>this.fetchSlice(r,t))))}async fetchSlices(e,t){const r=await this.client.request({headers:{...this.headers,Range:`bytes=${e.map(({offset:s,length:n})=>`${s}-${s+n}`).join(",")}`},signal:t});if(r.ok)if(r.status===206){const{type:s,params:n}=dr(r.getHeader("content-type"));if(s==="multipart/byteranges"){const f=gr(await r.getData(),n.boundary);return this._fileSize=f[0].fileSize||null,f}const o=await r.getData(),{start:a,end:l,total:c}=ue(r.getHeader("content-range"));this._fileSize=c||null;const h=[{data:o,offset:a,length:l-a}];if(e.length>1){const f=await Promise.all(e.slice(1).map(u=>this.fetchSlice(u,t)));return h.concat(f)}return h}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const s=await r.getData();return this._fileSize=s.byteLength,[{data:s,offset:0,length:s.byteLength}]}else throw new Error("Error fetching data.")}async fetchSlice(e,t){const{offset:r,length:s}=e,n=await this.client.request({headers:{...this.headers,Range:`bytes=${r}-${r+s}`},signal:t});if(n.ok)if(n.status===206){const o=await n.getData(),{total:a}=ue(n.getHeader("content-range"));return this._fileSize=a||null,{data:o,offset:r,length:s}}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const o=await n.getData();return this._fileSize=o.byteLength,{data:o,offset:0,length:o.byteLength}}else throw new Error("Error fetching data.")}get fileSize(){return this._fileSize}}function De(i,{blockSize:e,cacheSize:t}){return e===null?i:new Ir(i,{blockSize:e,cacheSize:t})}function Pr(i,{headers:e={},credentials:t,maxRanges:r=0,allowFullFile:s=!1,...n}={}){const o=new Tr(i,t),a=new Te(o,e,r,s);return De(a,n)}function Fr(i,{headers:e={},maxRanges:t=0,allowFullFile:r=!1,...s}={}){const n=new Ar(i),o=new Te(n,e,t,r);return De(o,s)}function kr(i,{headers:e={},maxRanges:t=0,allowFullFile:r=!1,...s}={}){const n=new _r(i),o=new Te(n,e,t,r);return De(o,s)}function de(i,{forceXHR:e=!1,...t}={}){return typeof fetch=="function"&&!e?Pr(i,t):typeof XMLHttpRequest<"u"?Fr(i,t):kr(i,t)}class Cr extends be{constructor(e){super(),this.file=e}async fetchSlice(e,t){return new Promise((r,s)=>{const n=this.file.slice(e.offset,e.offset+e.length),o=new FileReader;o.onload=a=>r(a.target.result),o.onerror=s,o.onabort=s,o.readAsArrayBuffer(n),t&&t.addEventListener("abort",()=>o.abort())})}}function Or(i){return new Cr(i)}function ge(i){switch(i){case x.BYTE:case x.ASCII:case x.SBYTE:case x.UNDEFINED:return 1;case x.SHORT:case x.SSHORT:return 2;case x.LONG:case x.SLONG:case x.FLOAT:case x.IFD:return 4;case x.RATIONAL:case x.SRATIONAL:case x.DOUBLE:case x.LONG8:case x.SLONG8:case x.IFD8:return 8;default:throw new RangeError(`Invalid field type: ${i}`)}}function Mr(i){const e=i.GeoKeyDirectory;if(!e)return null;const t={};for(let r=4;r<=e[3]*4;r+=4){const s=Kt[e[r]],n=e[r+1]?K[e[r+1]]:null,o=e[r+2],a=e[r+3];let l=null;if(!n)l=a;else{if(l=i[n],typeof l>"u"||l===null)throw new Error(`Could not get value of geoKey '${s}'.`);typeof l=="string"?l=l.substring(a,a+o-1):l.subarray&&(l=l.subarray(a,a+o),o===1&&(l=l[0]))}t[s]=l}return t}function M(i,e,t,r){let s=null,n=null;const o=ge(e);switch(e){case x.BYTE:case x.ASCII:case x.UNDEFINED:s=new Uint8Array(t),n=i.readUint8;break;case x.SBYTE:s=new Int8Array(t),n=i.readInt8;break;case x.SHORT:s=new Uint16Array(t),n=i.readUint16;break;case x.SSHORT:s=new Int16Array(t),n=i.readInt16;break;case x.LONG:case x.IFD:s=new Uint32Array(t),n=i.readUint32;break;case x.SLONG:s=new Int32Array(t),n=i.readInt32;break;case x.LONG8:case x.IFD8:s=new Array(t),n=i.readUint64;break;case x.SLONG8:s=new Array(t),n=i.readInt64;break;case x.RATIONAL:s=new Uint32Array(t*2),n=i.readUint32;break;case x.SRATIONAL:s=new Int32Array(t*2),n=i.readInt32;break;case x.FLOAT:s=new Float32Array(t),n=i.readFloat32;break;case x.DOUBLE:s=new Float64Array(t),n=i.readFloat64;break;default:throw new RangeError(`Invalid field type: ${e}`)}if(e===x.RATIONAL||e===x.SRATIONAL)for(let a=0;a<t;a+=2)s[a]=n.call(i,r+a*o),s[a+1]=n.call(i,r+(a*o+4));else for(let a=0;a<t;++a)s[a]=n.call(i,r+a*o);return e===x.ASCII?new TextDecoder("utf-8").decode(s):s}class Rr{constructor(e,t,r){this.fileDirectory=e,this.geoKeyDirectory=t,this.nextIFDByteOffset=r}}class ie extends Error{constructor(e){super(`No image at index ${e}`),this.index=e}}class We{async readRasters(e={}){const{window:t,width:r,height:s}=e;let{resX:n,resY:o,bbox:a}=e;const l=await this.getImage();let c=l;const h=await this.getImageCount(),f=l.getBoundingBox();if(t&&a)throw new Error('Both "bbox" and "window" passed.');if(r||s){if(t){const[d,p]=l.getOrigin(),[y,w]=l.getResolution();a=[d+t[0]*y,p+t[1]*w,d+t[2]*y,p+t[3]*w]}const g=a||f;if(r){if(n)throw new Error("Both width and resX passed");n=(g[2]-g[0])/r}if(s){if(o)throw new Error("Both width and resY passed");o=(g[3]-g[1])/s}}if(n||o){const g=[];for(let d=0;d<h;++d){const p=await this.getImage(d),{SubfileType:y,NewSubfileType:w}=p.fileDirectory;(d===0||y===2||w&1)&&g.push(p)}g.sort((d,p)=>d.getWidth()-p.getWidth());for(let d=0;d<g.length;++d){const p=g[d],y=(f[2]-f[0])/p.getWidth(),w=(f[3]-f[1])/p.getHeight();if(c=p,n&&n>y||o&&o>w)break}}let u=t;if(a){const[g,d]=l.getOrigin(),[p,y]=c.getResolution(l);u=[Math.round((a[0]-g)/p),Math.round((a[1]-d)/y),Math.round((a[2]-g)/p),Math.round((a[3]-d)/y)],u=[Math.min(u[0],u[2]),Math.min(u[1],u[3]),Math.max(u[0],u[2]),Math.max(u[1],u[3])]}return c.readRasters({...e,window:u})}}class v extends We{constructor(e,t,r,s,n={}){super(),this.source=e,this.littleEndian=t,this.bigTiff=r,this.firstIFDOffset=s,this.cache=n.cache||!1,this.ifdRequests=[],this.ghostValues=null}async getSlice(e,t){const r=this.bigTiff?4048:1024;return new hr((await this.source.fetch([{offset:e,length:typeof t<"u"?t:r}]))[0],e,this.littleEndian,this.bigTiff)}async parseFileDirectoryAt(e){const t=this.bigTiff?20:12,r=this.bigTiff?8:2;let s=await this.getSlice(e);const n=this.bigTiff?s.readUint64(e):s.readUint16(e),o=n*t+(this.bigTiff?16:6);s.covers(e,o)||(s=await this.getSlice(e,o));const a={};let l=e+(this.bigTiff?8:2);for(let f=0;f<n;l+=t,++f){const u=s.readUint16(l),g=s.readUint16(l+2),d=this.bigTiff?s.readUint64(l+4):s.readUint32(l+4);let p,y;const w=ge(g),m=l+(this.bigTiff?12:8);if(w*d<=(this.bigTiff?8:4))p=M(s,g,d,m);else{const b=s.readOffset(m),I=ge(g)*d;if(s.covers(b,I))p=M(s,g,d,b);else{const S=await this.getSlice(b,I);p=M(S,g,d,b)}}d===1&&zt.indexOf(u)===-1&&!(g===x.RATIONAL||g===x.SRATIONAL)?y=p[0]:y=p,a[K[u]]=y}const c=Mr(a),h=s.readOffset(e+r+t*n);return new Rr(a,c,h)}async requestIFD(e){if(this.ifdRequests[e])return this.ifdRequests[e];if(e===0)return this.ifdRequests[e]=this.parseFileDirectoryAt(this.firstIFDOffset),this.ifdRequests[e];if(!this.ifdRequests[e-1])try{this.ifdRequests[e-1]=this.requestIFD(e-1)}catch(t){throw t instanceof ie?new ie(e):t}return this.ifdRequests[e]=(async()=>{const t=await this.ifdRequests[e-1];if(t.nextIFDByteOffset===0)throw new ie(e);return this.parseFileDirectoryAt(t.nextIFDByteOffset)})(),this.ifdRequests[e]}async getImage(e=0){const t=await this.requestIFD(e);return new Je(t.fileDirectory,t.geoKeyDirectory,this.dataView,this.littleEndian,this.cache,this.source)}async getImageCount(){let e=0,t=!0;for(;t;)try{await this.requestIFD(e),++e}catch(r){if(r instanceof ie)t=!1;else throw r}return e}async getGhostValues(){const e=this.bigTiff?16:8;if(this.ghostValues)return this.ghostValues;const t="GDAL_STRUCTURAL_METADATA_SIZE=",r=t.length+100;let s=await this.getSlice(e,r);if(t===M(s,x.ASCII,t.length,e)){const o=M(s,x.ASCII,r,e).split(`
`)[0],a=Number(o.split("=")[1].split(" ")[0])+o.length;a>r&&(s=await this.getSlice(e,a));const l=M(s,x.ASCII,a,e);this.ghostValues={},l.split(`
`).filter(c=>c.length>0).map(c=>c.split("=")).forEach(([c,h])=>{this.ghostValues[c]=h})}return this.ghostValues}static async fromSource(e,t,r){const s=(await e.fetch([{offset:0,length:1024}],r))[0],n=new cr(s),o=n.getUint16(0,0);let a;if(o===18761)a=!0;else if(o===19789)a=!1;else throw new TypeError("Invalid byte order value.");const l=n.getUint16(2,a);let c;if(l===42)c=!1;else if(l===43){if(c=!0,n.getUint16(4,a)!==8)throw new Error("Unsupported offset byte-size.")}else throw new TypeError("Invalid magic number.");const h=c?n.getUint64(8,a):n.getUint32(4,a);return new v(e,a,c,h,t)}close(){return typeof this.source.close=="function"?this.source.close():!1}}class Br extends We{constructor(e,t){super(),this.mainFile=e,this.overviewFiles=t,this.imageFiles=[e].concat(t),this.fileDirectoriesPerFile=null,this.fileDirectoriesPerFileParsing=null,this.imageCount=null}async parseFileDirectoriesPerFile(){const e=[this.mainFile.parseFileDirectoryAt(this.mainFile.firstIFDOffset)].concat(this.overviewFiles.map(t=>t.parseFileDirectoryAt(t.firstIFDOffset)));return this.fileDirectoriesPerFile=await Promise.all(e),this.fileDirectoriesPerFile}async getImage(e=0){await this.getImageCount(),await this.parseFileDirectoriesPerFile();let t=0,r=0;for(let s=0;s<this.imageFiles.length;s++){const n=this.imageFiles[s];for(let o=0;o<this.imageCounts[s];o++){if(e===t){const a=await n.requestIFD(r);return new Je(a.fileDirectory,a.geoKeyDirectory,n.dataView,n.littleEndian,n.cache,n.source)}t++,r++}r=0}throw new RangeError("Invalid image index")}async getImageCount(){if(this.imageCount!==null)return this.imageCount;const e=[this.mainFile.getImageCount()].concat(this.overviewFiles.map(t=>t.getImageCount()));return this.imageCounts=await Promise.all(e),this.imageCount=this.imageCounts.reduce((t,r)=>t+r,0),this.imageCount}}async function zr(i,e={},t){return v.fromSource(de(i,e),t)}async function qr(i,e){return v.fromSource(Or(i),e)}async function Kr(i,e=[],t={},r){const s=await v.fromSource(de(i,t),r),n=await Promise.all(e.map(o=>v.fromSource(de(o,t))));return new Br(s,n)}export{Lr as L,Vr as P,Kr as a,zr as b,Nr as c,qr as f,_ as p};
//# sourceMappingURL=geotiff-DcwwZ_-m.js.map
