import{b8 as C,f as t,by as Z,as as F,v as x,bg as S,aZ as W,a_ as y,E as X,at as N,w as v,aB as H,bm as z}from"./GeoJSON-BoRJWQIG.js";import{T as w}from"./Tile-Dd8tR1PC.js";import{r as B,b as k,a as P,T as V,E as q}from"./common-CLWpeXJR.js";class tt extends w{constructor(e,s,i,n,a,h){super(e,s,h),this.crossOrigin_=n,this.src_=i,this.key=i,this.image_,C?this.image_=new OffscreenCanvas(1,1):(this.image_=new Image,n!==null&&(this.image_.crossOrigin=n)),this.unlisten_=null,this.tileLoadFunction_=a}getImage(){return this.image_}setImage(e){this.image_=e,this.state=t.LOADED,this.unlistenImage_(),this.changed()}getCrossOrigin(){return this.crossOrigin_}handleImageError_(){this.state=t.ERROR,this.unlistenImage_(),this.image_=J(),this.changed()}handleImageLoad_(){if(C)this.state=t.LOADED;else{const e=this.image_;e.naturalWidth&&e.naturalHeight?this.state=t.LOADED:this.state=t.EMPTY}this.unlistenImage_(),this.changed()}load(){this.state==t.ERROR&&(this.state=t.IDLE,this.image_=new Image,this.crossOrigin_!==null&&(this.image_.crossOrigin=this.crossOrigin_)),this.state==t.IDLE&&(this.state=t.LOADING,this.changed(),this.tileLoadFunction_(this,this.src_),this.unlisten_=Z(this.image_,this.handleImageLoad_.bind(this),this.handleImageError_.bind(this)))}unlistenImage_(){this.unlisten_&&(this.unlisten_(),this.unlisten_=null)}disposeInternal(){this.unlistenImage_(),this.image_=null,super.disposeInternal()}}function J(){const l=F(1,1);return l.fillStyle="rgba(0,0,0,0)",l.fillRect(0,0,1,1),l.canvas}class et extends w{constructor(e,s,i,n,a,h,g,f,b,R,I,G){super(a,t.IDLE,G),this.renderEdges_=I!==void 0?I:!1,this.pixelRatio_=g,this.gutter_=f,this.canvas_=null,this.sourceTileGrid_=s,this.targetTileGrid_=n,this.wrappedTileCoord_=h||a,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0,this.clipExtent_=e.canWrapX()?e.getExtent():void 0;const L=n.getTileCoordExtent(this.wrappedTileCoord_),D=this.targetTileGrid_.getExtent();let r=this.sourceTileGrid_.getExtent();const E=D?x(L,D):L;if(S(E)===0){this.state=t.EMPTY;return}const c=e.getExtent();c&&(r?r=x(r,c):r=c);const O=n.getResolution(this.wrappedTileCoord_[0]),_=P(e,i,E,O);if(!isFinite(_)||_<=0){this.state=t.EMPTY;return}const Y=R!==void 0?R:q;if(this.triangulation_=new V(e,i,E,r,_*Y,O),this.triangulation_.getTriangles().length===0){this.state=t.EMPTY;return}this.sourceZ_=s.getZForResolution(_);let o=this.triangulation_.calculateSourceExtent();if(r&&(e.canWrapX()?(o[1]=v(o[1],r[1],r[3]),o[3]=v(o[3],r[1],r[3])):o=x(o,r)),!S(o))this.state=t.EMPTY;else{let d=0,m=0;e.canWrapX()&&(d=H(c),m=Math.floor((o[0]-c[0])/d)),z(o.slice(),e,!0).forEach(K=>{const u=s.getTileRangeForExtentAndZ(K,this.sourceZ_);for(let T=u.minX;T<=u.maxX;T++)for(let p=u.minY;p<=u.maxY;p++){const A=b(this.sourceZ_,T,p,g);if(A){const M=m*d;this.sourceTiles_.push({tile:A,offset:M})}}++m}),this.sourceTiles_.length===0&&(this.state=t.EMPTY)}}getImage(){return this.canvas_}reproject_(){const e=[];if(this.sourceTiles_.forEach(s=>{const i=s.tile;if(i&&i.getState()==t.LOADED){const n=this.sourceTileGrid_.getTileCoordExtent(i.tileCoord);n[0]+=s.offset,n[2]+=s.offset;const a=this.clipExtent_?.slice();a&&(a[0]+=s.offset,a[2]+=s.offset),e.push({extent:n,clipExtent:a,image:i.getImage()})}}),this.sourceTiles_.length=0,e.length===0)this.state=t.ERROR;else{const s=this.wrappedTileCoord_[0],i=this.targetTileGrid_.getTileSize(s),n=typeof i=="number"?i:i[0],a=typeof i=="number"?i:i[1],h=this.targetTileGrid_.getResolution(s),g=this.sourceTileGrid_.getResolution(this.sourceZ_),f=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_);this.canvas_=B(n,a,this.pixelRatio_,g,this.sourceTileGrid_.getExtent(),h,f,this.triangulation_,e,this.gutter_,this.renderEdges_,this.interpolate),this.state=t.LOADED}this.changed()}load(){if(this.state==t.IDLE){this.state=t.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(({tile:s})=>{const i=s.getState();if(i==t.IDLE||i==t.LOADING){e++;const n=W(s,X.CHANGE,a=>{const h=s.getState();(h==t.LOADED||h==t.ERROR||h==t.EMPTY)&&(y(n),e--,e===0&&(this.unlistenSources_(),this.reproject_()))});this.sourcesListenerKeys_.push(n)}}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function({tile:s},i,n){s.getState()==t.IDLE&&s.load()})}}unlistenSources_(){this.sourcesListenerKeys_.forEach(y),this.sourcesListenerKeys_=null}release(){this.canvas_&&(N(this.canvas_.getContext("2d")),k.push(this.canvas_),this.canvas_=null),super.release()}}export{tt as I,et as R};
//# sourceMappingURL=Tile-Bg7ozswn.js.map
