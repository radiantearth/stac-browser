{"version":3,"file":"Heatmap-CQiflBFl.js","sources":["../../node_modules/ol/layer/Heatmap.js"],"sourcesContent":["/**\n * @module ol/layer/Heatmap\n */\nimport {createCanvasContext2D} from '../dom.js';\nimport {BooleanType, NumberType} from '../expr/expression.js';\nimport {newCompilationContext} from '../expr/gpu.js';\nimport {clamp} from '../math.js';\nimport {ShaderBuilder} from '../render/webgl/ShaderBuilder.js';\nimport {\n  applyContextToBuilder,\n  expressionToGlsl,\n  generateAttributesFromContext,\n  generateUniformsFromContext,\n} from '../render/webgl/compileUtil.js';\nimport WebGLVectorLayerRenderer from '../renderer/webgl/VectorLayer.js';\nimport BaseVector from './BaseVector.js';\n\n/**\n * @typedef {import(\"../style/flat.js\").NumberExpression|string|function(import(\"../Feature.js\").default):number} WeightExpression\n */\n\n/**\n * @template {import(\"../Feature.js\").FeatureLike} [FeatureType=import(\"../Feature.js\").default]\n * @template {import(\"../source/Vector.js\").default<FeatureType>} [VectorSourceType=import(\"../source/Vector.js\").default<FeatureType>]\n * @typedef {Object} Options\n * @property {string} [className='ol-layer'] A CSS class name to set to the layer element.\n * @property {number} [opacity=1] Opacity (0, 1).\n * @property {boolean} [visible=true] Visibility.\n * @property {import(\"../extent.js\").Extent} [extent] The bounding extent for layer rendering.  The layer will not be\n * rendered outside of this extent.\n * @property {number} [zIndex] The z-index for layer rendering.  At rendering time, the layers\n * will be ordered, first by Z-index and then by position. When `undefined`, a `zIndex` of 0 is assumed\n * for layers that are added to the map's `layers` collection, or `Infinity` when the layer's `setMap()`\n * method was used.\n * @property {number} [minResolution] The minimum resolution (inclusive) at which this layer will be\n * visible.\n * @property {number} [maxResolution] The maximum resolution (exclusive) below which this layer will\n * be visible.\n * @property {number} [minZoom] The minimum view zoom level (exclusive) above which this layer will be\n * visible.\n * @property {number} [maxZoom] The maximum view zoom level (inclusive) at which this layer will\n * be visible.\n * @property {Array<string>} [gradient=['#00f', '#0ff', '#0f0', '#ff0', '#f00']] The color gradient\n * of the heatmap, specified as an array of CSS color strings.\n * @property {import(\"../style/flat.js\").NumberExpression} [radius=8] Radius size in pixels. Note that for LineStrings,\n * the width of the line will be double the radius.\n * @property {import(\"../style/flat.js\").NumberExpression} [blur=15] Blur size in pixels. This is added to the `radius`\n * parameter above to create the final size of the blur effect.\n * @property {WeightExpression} [weight='weight'] The feature\n * attribute to use for the weight. This also supports expressions returning a number or a function that returns a weight from a feature. Weight values\n * should range from 0 to 1 (and values outside will be clamped to that range).\n * @property {import(\"../style/flat.js\").BooleanExpression} [filter] Optional filter expression.\n * @property {Object<string, number|Array<number>|string|boolean>} [variables] Variables used in expressions (optional)\n * @property {VectorSourceType} [source] Point source.\n * @property {Object<string, *>} [properties] Arbitrary observable properties. Can be accessed with `#get()` and `#set()`.\n */\n\n/**\n * @enum {string}\n * @private\n */\nconst Property = {\n  BLUR: 'blur',\n  GRADIENT: 'gradient',\n  RADIUS: 'radius',\n};\n\n/**\n * @const\n * @type {Array<string>}\n */\nconst DEFAULT_GRADIENT = ['#00f', '#0ff', '#0f0', '#ff0', '#f00'];\n\n/**\n * @classdesc\n * Layer for rendering vector data as a heatmap.\n * Note that any property set in the options is set as a {@link module:ol/Object~BaseObject}\n * property on the layer object; for example, setting `title: 'My Title'` in the\n * options means that `title` is observable, and has get/set accessors.\n *\n * @fires import(\"../render/Event.js\").RenderEvent#prerender\n * @fires import(\"../render/Event.js\").RenderEvent#postrender\n * @template {import(\"../Feature.js\").FeatureLike} [FeatureType=import(\"../Feature.js\").default]\n * @template {import(\"../source/Vector.js\").default<FeatureType>} [VectorSourceType=import(\"../source/Vector.js\").default<FeatureType>]\n * @extends {BaseVector<FeatureType, VectorSourceType, WebGLVectorLayerRenderer>}\n * @api\n */\nclass Heatmap extends BaseVector {\n  /**\n   * @param {Options<FeatureType, VectorSourceType>} [options] Options.\n   */\n  constructor(options) {\n    options = options ? options : {};\n\n    const baseOptions = Object.assign({}, options);\n\n    delete baseOptions.gradient;\n    delete baseOptions.radius;\n    delete baseOptions.blur;\n    delete baseOptions.weight;\n    super(baseOptions);\n\n    this.filter_ = options.filter ?? true;\n\n    /**\n     * @type {import('../style/flat.js').StyleVariables}\n     * @private\n     */\n    this.styleVariables_ = options.variables || {};\n\n    /**\n     * @private\n     * @type {HTMLCanvasElement|OffscreenCanvas}\n     */\n    this.gradient_ = null;\n\n    this.addChangeListener(Property.GRADIENT, this.handleGradientChanged_);\n\n    this.setGradient(options.gradient ? options.gradient : DEFAULT_GRADIENT);\n\n    this.setBlur(options.blur !== undefined ? options.blur : 15);\n\n    this.setRadius(options.radius !== undefined ? options.radius : 8);\n\n    const weight = options.weight ? options.weight : 'weight';\n\n    /**\n     * @private\n     */\n    this.weight_ = weight;\n\n    // For performance reasons, don't sort the features before rendering.\n    // The render order is not relevant for a heatmap representation.\n    this.setRenderOrder(null);\n  }\n\n  /**\n   * Return the blur size in pixels.\n   * @return {import(\"../style/flat.js\").NumberExpression} Blur size in pixels.\n   * @api\n   * @observable\n   */\n  getBlur() {\n    return /** @type {import(\"../style/flat.js\").NumberExpression} */ (\n      this.get(Property.BLUR)\n    );\n  }\n\n  /**\n   * Return the gradient colors as array of strings.\n   * @return {Array<string>} Colors.\n   * @api\n   * @observable\n   */\n  getGradient() {\n    return /** @type {Array<string>} */ (this.get(Property.GRADIENT));\n  }\n\n  /**\n   * Return the size of the radius in pixels.\n   * @return {import(\"../style/flat.js\").NumberExpression} Radius size in pixel.\n   * @api\n   * @observable\n   */\n  getRadius() {\n    return /** @type {import(\"../style/flat.js\").NumberExpression} */ (\n      this.get(Property.RADIUS)\n    );\n  }\n\n  /**\n   * @private\n   */\n  handleGradientChanged_() {\n    this.gradient_ = createGradient(this.getGradient());\n  }\n\n  /**\n   * Set the blur size in pixels.\n   * @param {import(\"../style/flat.js\").NumberExpression} blur Blur size in pixels (supports expressions).\n   * @api\n   * @observable\n   */\n  setBlur(blur) {\n    const previousValue = this.get(Property.BLUR);\n    this.set(Property.BLUR, blur);\n    // if the value stays numerical, simply refresh the layer\n    if (typeof blur === 'number' && typeof previousValue === 'number') {\n      this.changed();\n      return;\n    }\n    this.clearRenderer();\n  }\n\n  /**\n   * Set the gradient colors as array of strings.\n   * @param {Array<string>} colors Gradient.\n   * @api\n   * @observable\n   */\n  setGradient(colors) {\n    this.set(Property.GRADIENT, colors);\n  }\n\n  /**\n   * Set the size of the radius in pixels.\n   * @param {import(\"../style/flat.js\").NumberExpression} radius Radius size in pixel (supports expressions).\n   * @api\n   * @observable\n   */\n  setRadius(radius) {\n    const previousValue = this.get(Property.RADIUS);\n    this.set(Property.RADIUS, radius);\n    // if the value stays numerical, simply refresh the layer\n    if (typeof radius === 'number' && typeof previousValue === 'number') {\n      this.changed();\n      return;\n    }\n    this.clearRenderer();\n  }\n\n  /**\n   * Set the filter expression\n   * @param {import(\"../style/flat.js\").BooleanExpression} filter Filter expression\n   * @api\n   */\n  setFilter(filter) {\n    this.filter_ = filter;\n    this.changed();\n    this.clearRenderer();\n  }\n\n  /**\n   * Set the weight expression\n   * @param {WeightExpression} weight Weight expression\n   * @api\n   */\n  setWeight(weight) {\n    this.weight_ = weight;\n    this.changed();\n    this.clearRenderer();\n  }\n\n  /**\n   * @override\n   */\n  createRenderer() {\n    const builder = new ShaderBuilder();\n\n    const context = newCompilationContext();\n    const filterCompiled = expressionToGlsl(context, this.filter_, BooleanType);\n    let radiusCompiled = expressionToGlsl(\n      context,\n      this.getRadius(),\n      NumberType,\n    );\n    let blurCompiled = expressionToGlsl(context, this.getBlur(), NumberType);\n\n    /** @type {import('../render/webgl/VectorStyleRenderer.js').UniformDefinitions} */\n    const blurRadiusUniforms = {};\n    if (typeof this.getBlur() === 'number') {\n      blurCompiled = 'a_blur';\n      blurRadiusUniforms['a_blur'] = () => this.getBlur();\n      builder.addUniform('a_blur', 'float');\n    }\n    if (typeof this.getRadius() === 'number') {\n      radiusCompiled = 'a_radius';\n      blurRadiusUniforms['a_radius'] = () => this.getRadius();\n      builder.addUniform('a_radius', 'float');\n    }\n\n    /** @type {import('../render/webgl/VectorStyleRenderer.js').AttributeDefinitions} */\n    const weightAttribute = {};\n    let weightExpression = null;\n    if (\n      typeof this.weight_ === 'string' ||\n      typeof this.weight_ === 'function'\n    ) {\n      const weightFunction =\n        typeof this.weight_ === 'string'\n          ? (feature) => feature.get(this.weight_)\n          : this.weight_;\n      weightAttribute['prop_weight'] = {\n        size: 1,\n        callback: (feature) => {\n          const weightValue = weightFunction(feature);\n          return weightValue !== undefined ? clamp(weightValue, 0, 1) : 1;\n        },\n      };\n      weightExpression = 'a_prop_weight';\n      builder.addAttribute('a_prop_weight', 'float');\n    } else {\n      const clampedWeight = ['clamp', this.weight_, 0, 1];\n      weightExpression = expressionToGlsl(context, clampedWeight, NumberType);\n    }\n\n    builder\n      .addFragmentShaderFunction(\n        `float getBlurSlope() {\n  float blur = max(1., ${blurCompiled});\n  float radius = ${radiusCompiled};\n  return radius / blur;\n}`,\n      )\n      .setSymbolSizeExpression(`vec2(${radiusCompiled} + ${blurCompiled}) * 2.`)\n      .setSymbolColorExpression(\n        `vec4(smoothstep(0., 1., (1. - length(coordsPx * 2. / v_quadSizePx)) * getBlurSlope()) * ${weightExpression})`,\n      )\n      .setStrokeColorExpression(\n        `vec4(smoothstep(0., 1., (1. - length(currentRadiusPx * 2. / v_width)) * getBlurSlope()) * ${weightExpression})`,\n      )\n      .setStrokeWidthExpression(`(${radiusCompiled} + ${blurCompiled}) * 2.`)\n      .setFillColorExpression(`vec4(${weightExpression})`)\n      .setFragmentDiscardExpression(`!${filterCompiled}`);\n\n    applyContextToBuilder(builder, context);\n    const attributes = generateAttributesFromContext(context);\n    const uniforms = generateUniformsFromContext(context, this.styleVariables_);\n\n    return new WebGLVectorLayerRenderer(this, {\n      className: this.getClassName(),\n      variables: this.styleVariables_,\n      style: {\n        builder,\n        attributes: {\n          ...attributes,\n          ...weightAttribute,\n        },\n        uniforms: {\n          ...uniforms,\n          ...blurRadiusUniforms,\n        },\n      },\n      disableHitDetection: false,\n      postProcesses: [\n        {\n          fragmentShader: `\n            precision mediump float;\n\n            uniform sampler2D u_image;\n            uniform sampler2D u_gradientTexture;\n            uniform float u_opacity;\n\n            varying vec2 v_texCoord;\n\n            void main() {\n              vec4 color = texture2D(u_image, v_texCoord);\n              gl_FragColor.a = color.a * u_opacity;\n              gl_FragColor.rgb = texture2D(u_gradientTexture, vec2(0.5, color.a)).rgb;\n              gl_FragColor.rgb *= gl_FragColor.a;\n            }`,\n          uniforms: {\n            u_gradientTexture: () => this.gradient_,\n            u_opacity: () => this.getOpacity(),\n          },\n        },\n      ],\n    });\n  }\n\n  /**\n   * Update any variables used by the layer style and trigger a re-render.\n   * @param {import('../style/flat.js').StyleVariables} variables Variables to update.\n   */\n  updateStyleVariables(variables) {\n    Object.assign(this.styleVariables_, variables);\n    this.changed();\n  }\n\n  /**\n   * @override\n   */\n  renderDeclutter() {}\n}\n\n/**\n * @param {Array<string>} colors A list of colored.\n * @return {HTMLCanvasElement|OffscreenCanvas} canvas with gradient texture.\n */\nfunction createGradient(colors) {\n  const width = 1;\n  const height = 256;\n  const context = createCanvasContext2D(width, height);\n\n  const gradient = context.createLinearGradient(0, 0, width, height);\n  const step = 1 / (colors.length - 1);\n  for (let i = 0, ii = colors.length; i < ii; ++i) {\n    gradient.addColorStop(i * step, colors[i]);\n  }\n\n  context.fillStyle = gradient;\n  context.fillRect(0, 0, width, height);\n\n  return context.canvas;\n}\n\nexport default Heatmap;\n"],"names":["Property","DEFAULT_GRADIENT","Heatmap","BaseVector","options","baseOptions","weight","createGradient","blur","previousValue","colors","radius","filter","builder","ShaderBuilder","context","newCompilationContext","filterCompiled","expressionToGlsl","BooleanType","radiusCompiled","NumberType","blurCompiled","blurRadiusUniforms","weightAttribute","weightExpression","weightFunction","feature","weightValue","clamp","clampedWeight","applyContextToBuilder","attributes","generateAttributesFromContext","uniforms","generateUniformsFromContext","WebGLVectorLayerRenderer","variables","createCanvasContext2D","gradient","step","i","ii"],"mappings":"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","x_google_ignoreList":[0]}