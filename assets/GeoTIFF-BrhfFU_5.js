import{f as q,a as O,b as $,P as L,p as H}from"./geotiff-B5OvkZPi.js";import{l as z,m as U,o as W,p as X,q as Y,t as Z,r as J,u as Q,v as ee,w as te,y as E,z as K,P as V,x as ne,A as re}from"./GeoJSON-BlyzYhKz.js";import{T as oe}from"./TileGrid-D2Qra4XP.js";import se from"./DataTile-Dra_RFvC.js";import"./index-4V-ffF_e.js";import"./utils-BXWzvTjY.js";import"./_commonjsHelpers-CE1G-McA.js";import"./I18N-DlIXJTel.js";import"./__vite-browser-external-B1O5LaIO.js";import"./BFormRadioGroup.vue_vue_type_script_setup_true_lang-DaMHx4U3-CVtNDUBO.js";import"./useStateClass-BGbSLWFN-lMazZNQ7.js";import"./ConditionalWrapper.vue_vue_type_script_lang-IX_NpHH--B1-KiooU.js";import"./TileRange-2Tc-Ry00.js";import"./tilecoord-DYaQ6NdW.js";import"./DataTile-uej8eNh4.js";import"./Tile-lMrQctYw.js";import"./common-0gNrjJbx.js";import"./mat4-CeypvY8Z.js";import"./Tile-8IayXPne.js";import"./TileEventType-CTN_nmJ7.js";function ie(n){return((n.fileDirectory.NewSubfileType||0)&4)===4}function ae(n,e){if(!n)return!1;if(n===!0)return!0;if(e.getSamplesPerPixel()!==3)return!1;const t=e.fileDirectory.PhotometricInterpretation,r=H;return t===r.CMYK||t===r.YCbCr||t===r.CIELab||t===r.ICCLab}const B="STATISTICS_MAXIMUM",D="STATISTICS_MINIMUM",k=256;let R;function le(){return R||(R=new L),R}function ce(n){try{return n.getBoundingBox(!0)}catch{return[0,0,n.getWidth(),n.getHeight()]}}function ue(n){try{return n.getOrigin().slice(0,2)}catch{return[0,n.getHeight()]}}function fe(n,e){try{return n.getResolution(e)}catch{return[e.getWidth()/n.getWidth(),e.getHeight()/n.getHeight()]}}function he(n){const e=n.geoKeys;if(!e)return null;if(e.ProjectedCSTypeGeoKey&&e.ProjectedCSTypeGeoKey!==32767){const t="EPSG:"+e.ProjectedCSTypeGeoKey;let r=E(t);if(!r){const u=K(e.ProjLinearUnitsGeoKey);u&&(r=new V({code:t,units:u}))}return r}if(e.GeographicTypeGeoKey&&e.GeographicTypeGeoKey!==32767){const t="EPSG:"+e.GeographicTypeGeoKey;let r=E(t);if(!r){const u=K(e.GeogAngularUnitsGeoKey);u&&(r=new V({code:t,units:u}))}return r}return null}function de(n){return n.getImageCount().then(function(e){const t=new Array(e);for(let r=0;r<e;++r)t[r]=n.getImage(r);return Promise.all(t)})}function me(n,e){let t;return n.blob?t=q(n.blob):n.overviews?t=O(n.url,n.overviews,e):t=$(n.url,e),t.then(de)}function v(n,e,t,r,u){if(Array.isArray(n)){const i=n.length;if(!Array.isArray(e)||i!=e.length){const s=new Error(r);throw u(s),s}for(let s=0;s<i;++s)v(n[s],e[s],t,r,u);return}if(e=e,Math.abs(n-e)>t*n)throw new Error(r)}function ge(n){return n instanceof Int8Array?-128:n instanceof Int16Array?-32768:n instanceof Int32Array?-2147483648:n instanceof Float32Array?12e-39:0}function pe(n){return n instanceof Int8Array?127:n instanceof Uint8Array||n instanceof Uint8ClampedArray?255:n instanceof Int16Array?32767:n instanceof Uint16Array?65535:n instanceof Int32Array?2147483647:n instanceof Uint32Array?4294967295:n instanceof Float32Array?34e37:255}class ye extends se{constructor(e){super({state:"loading",tileGrid:null,projection:e.projection||null,transition:e.transition,interpolate:e.interpolate!==!1,wrapX:e.wrapX}),this.sourceInfo_=e.sources;const t=this.sourceInfo_.length;this.sourceOptions_=e.sourceOptions,this.sourceImagery_=new Array(t),this.sourceMasks_=new Array(t),this.resolutionFactors_=new Array(t),this.samplesPerPixel_,this.nodataValues_,this.metadata_,this.normalize_=e.normalize!==!1,this.addAlpha_=!1,this.error_=null,this.convertToRGB_=e.convertToRGB||!1,this.setKey(this.sourceInfo_.map(i=>i.url).join(","));const r=this,u=new Array(t);for(let i=0;i<t;++i)u[i]=me(this.sourceInfo_[i],this.sourceOptions_);Promise.all(u).then(function(i){r.configure_(i)}).catch(function(i){z(i),r.error_=i,r.setState("error")})}getError(){return this.error_}determineProjection(e){const t=e[0];for(let r=t.length-1;r>=0;--r){const u=t[r],i=he(u);if(i){this.projection=i;break}}}determineTransformMatrix(e){const t=e[0];for(let r=t.length-1;r>=0;--r){const i=t[r].fileDirectory.ModelTransformation;if(i){const[s,y,b,T,m,c,A,g]=i,w=U(U([1/Math.sqrt(s*s+m*m),0,0,-1/Math.sqrt(y*y+c*c),T,g],[s,m,y,c,0,0]),[1,0,0,1,-T,-g]);this.transformMatrix=w,this.addAlpha_=!0;break}}}configure_(e){let t,r,u,i,s;const y=new Array(e.length),b=new Array(e.length),T=new Array(e.length);let m=0;const c=e.length;for(let o=0;o<c;++o){const a=[],f=[];e[o].forEach(h=>{ie(h)?f.push(h):a.push(h)});const l=a.length;if(f.length>0&&f.length!==l)throw new Error(`Expected one mask per image found ${f.length} masks and ${l} images`);let S,_;const C=new Array(l),d=new Array(l),I=new Array(l);b[o]=new Array(l),T[o]=new Array(l);for(let h=0;h<l;++h){const p=a[h],G=p.getGDALNoData();T[o][h]=p.getGDALMetadata(0),b[o][h]=G;const M=this.sourceInfo_[o].bands;y[o]=M?M.length:p.getSamplesPerPixel();const j=l-(h+1);S||(S=ce(p)),_||(_=ue(p));const F=fe(p,a[0]);I[j]=F[0];const P=[p.getTileWidth(),p.getTileHeight()];P[0]!==P[1]&&P[1]<k&&(P[0]=k,P[1]=k),C[j]=P;const N=F[0]/Math.abs(F[1]);d[j]=[P[0],P[1]/N]}if(t?ee(t,S,t):t=S,!r)r=_;else{const h=`Origin mismatch for source ${o}, got [${_}] but expected [${r}]`;v(r,_,0,h,this.viewRejector)}if(!s)s=I,this.resolutionFactors_[o]=1;else{s.length-m>I.length&&(m=s.length-I.length);const h=s[s.length-1]/I[I.length-1];this.resolutionFactors_[o]=h;const p=I.map(M=>M*=h),G=`Resolution mismatch for source ${o}, got [${p}] but expected [${s}]`;v(s.slice(m,s.length),p,.02,G,this.viewRejector)}u?v(u.slice(m,u.length),d,.01,`Tile size mismatch for source ${o}`,this.viewRejector):u=d,i?v(i.slice(m,i.length),C,0,`Tile size mismatch for source ${o}`,this.viewRejector):i=C,this.sourceImagery_[o]=a.reverse(),this.sourceMasks_[o]=f.reverse()}for(let o=0,a=this.sourceImagery_.length;o<a;++o){const f=this.sourceImagery_[o];for(;f.length<s.length;)f.unshift(void 0)}this.getProjection()||this.determineProjection(e),this.determineTransformMatrix(e),this.samplesPerPixel_=y,this.nodataValues_=b,this.metadata_=T;e:for(let o=0;o<c;++o){if(this.sourceInfo_[o].nodata!==void 0){this.addAlpha_=!0;break}if(this.sourceMasks_[o].length){this.addAlpha_=!0;break}const a=b[o],f=this.sourceInfo_[o].bands;if(f){for(let l=0;l<f.length;++l)if(a[f[l]-1]!==null){this.addAlpha_=!0;break e}continue}for(let l=0;l<a.length;++l)if(a[l]!==null){this.addAlpha_=!0;break e}}let A=this.addAlpha_?1:0;for(let o=0;o<c;++o)A+=y[o];this.bandCount=A;const g=new oe({extent:t,minZoom:m,origin:r,resolutions:s,tileSizes:u});this.tileGrid=g,this.setTileSizes(i),this.setLoader(this.loadTile_.bind(this)),this.setState("ready");const w=1;s.length===2?s=[s[0],s[1],s[1]/2]:s.length===1&&(s=[s[0]*2,s[0],s[0]/2]);let x=t;if(this.transformMatrix){const o=W(X(),this.transformMatrix.slice()),a=ne(f=>re(o,f));x=Y(t,a)}this.viewResolver({showFullExtent:!0,projection:this.projection,resolutions:s,center:J(Q(x),this.projection),extent:Z(x,this.projection),zoom:w})}loadTile_(e,t,r,u){const i=this.getTileSize(e),s=this.sourceImagery_.length,y=new Array(s*2),b=this.nodataValues_,T=this.sourceInfo_,m=le();for(let c=0;c<s;++c){const A=T[c],g=this.resolutionFactors_[c],w=[Math.round(t*(i[0]*g)),Math.round(r*(i[1]*g)),Math.round((t+1)*(i[0]*g)),Math.round((r+1)*(i[1]*g))],x=this.sourceImagery_[c][e];let o;A.bands&&(o=A.bands.map(function(_){return _-1}));let a;"nodata"in A&&A.nodata!==null?a=A.nodata:o?a=o.map(function(_){return b[c][_]}):a=b[c];const f={window:w,width:i[0],height:i[1],samples:o,fillValue:a,pool:m,interleave:!1,signal:u.signal};ae(this.convertToRGB_,x)?y[c]=x.readRGB(f):y[c]=x.readRasters(f);const l=s+c,S=this.sourceMasks_[c][e];if(!S){y[l]=Promise.resolve(null);continue}y[l]=S.readRasters({window:w,width:i[0],height:i[1],samples:[0],pool:m,interleave:!1})}return Promise.all(y).then(this.composeTile_.bind(this,i)).catch(function(c){throw z(c),c})}composeTile_(e,t){const r=this.metadata_,u=this.sourceInfo_,i=this.sourceImagery_.length,s=this.bandCount,y=this.samplesPerPixel_,b=this.nodataValues_,T=this.normalize_,m=this.addAlpha_,c=e[0]*e[1],A=c*s;let g;T?g=new Uint8Array(A):g=new Float32Array(A);let w=0;for(let x=0;x<c;++x){let o=m;for(let a=0;a<i;++a){const f=u[a];let l=f.min,S=f.max,_,C;if(T){const d=r[a][0];l===void 0&&(d&&D in d?l=parseFloat(d[D]):l=ge(t[a][0])),S===void 0&&(d&&B in d?S=parseFloat(d[B]):S=pe(t[a][0])),_=255/(S-l),C=-l*_}for(let d=0;d<y[a];++d){const I=t[a][d][x];let h;if(T?h=te(_*I+C,0,255):h=I,!m)g[w]=h;else{let p=f.nodata;if(p===void 0){let M;f.bands?M=f.bands[d]-1:M=d,p=b[a][M]}const G=isNaN(p);(!G&&I!==p||G&&!isNaN(I))&&(o=!1,g[w]=h)}w++}if(!o){const d=i+a,I=t[d];I&&!I[0][x]&&(o=!0)}}m&&(o||(g[w]=255),w++)}return g}}ye.prototype.getView;export{ye as default};
//# sourceMappingURL=GeoTIFF-BrhfFU_5.js.map
