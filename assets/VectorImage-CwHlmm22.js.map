{"version":3,"file":"VectorImage-CwHlmm22.js","sources":["../../node_modules/ol/renderer/canvas/VectorImageLayer.js","../../node_modules/ol/layer/VectorImage.js"],"sourcesContent":["/**\n * @module ol/renderer/canvas/VectorImageLayer\n */\nimport RBush from 'rbush';\nimport ImageCanvas from '../../ImageCanvas.js';\nimport ImageState from '../../ImageState.js';\nimport ViewHint from '../../ViewHint.js';\nimport EventType from '../../events/EventType.js';\nimport {getHeight, getWidth, isEmpty, scaleFromCenter} from '../../extent.js';\nimport {fromResolutionLike} from '../../resolution.js';\nimport {apply, compose, create} from '../../transform.js';\nimport CanvasImageLayerRenderer from './ImageLayer.js';\nimport CanvasVectorLayerRenderer from './VectorLayer.js';\n\n/**\n * @classdesc\n * Canvas renderer for image layers.\n * @api\n */\nclass CanvasVectorImageLayerRenderer extends CanvasImageLayerRenderer {\n  /**\n   * @param {import(\"../../layer/VectorImage.js\").default} layer Vector image layer.\n   */\n  constructor(layer) {\n    super(layer);\n\n    /**\n     * @private\n     * @type {import(\"./VectorLayer.js\").default}\n     */\n    this.vectorRenderer_ = new CanvasVectorLayerRenderer(layer);\n\n    /**\n     * @private\n     * @type {number}\n     */\n    this.layerImageRatio_ = layer.getImageRatio();\n\n    /**\n     * @private\n     * @type {import(\"../../transform.js\").Transform}\n     */\n    this.coordinateToVectorPixelTransform_ = create();\n\n    /**\n     * @private\n     * @type {import(\"../../transform.js\").Transform}\n     */\n    this.renderedPixelToCoordinateTransform_ = null;\n  }\n\n  /**\n   * Clean up.\n   * @override\n   */\n  disposeInternal() {\n    this.vectorRenderer_.dispose();\n    super.disposeInternal();\n  }\n\n  /**\n   * Asynchronous layer level hit detection.\n   * @param {import(\"../../pixel.js\").Pixel} pixel Pixel.\n   * @return {Promise<Array<import(\"../../Feature\").default>>} Promise that resolves with an array of features.\n   * @override\n   */\n  getFeatures(pixel) {\n    if (!this.vectorRenderer_) {\n      return Promise.resolve([]);\n    }\n    const vectorPixel = apply(\n      this.coordinateToVectorPixelTransform_,\n      apply(this.renderedPixelToCoordinateTransform_, pixel.slice()),\n    );\n    return this.vectorRenderer_.getFeatures(vectorPixel);\n  }\n\n  /**\n   * Perform action necessary to get the layer rendered after new fonts have loaded\n   * @override\n   */\n  handleFontsChanged() {\n    this.vectorRenderer_.handleFontsChanged();\n  }\n\n  /**\n   * Determine whether render should be called.\n   * @param {import(\"../../Map.js\").FrameState} frameState Frame state.\n   * @return {boolean} Layer is ready to be rendered.\n   * @override\n   */\n  prepareFrame(frameState) {\n    const pixelRatio = frameState.pixelRatio;\n    const viewState = frameState.viewState;\n    const viewResolution = viewState.resolution;\n\n    const hints = frameState.viewHints;\n    const vectorRenderer = this.vectorRenderer_;\n    let renderedExtent = frameState.extent;\n    if (this.layerImageRatio_ !== 1) {\n      renderedExtent = renderedExtent.slice(0);\n      scaleFromCenter(renderedExtent, this.layerImageRatio_);\n    }\n    const width = getWidth(renderedExtent) / viewResolution;\n    const height = getHeight(renderedExtent) / viewResolution;\n\n    if (\n      !hints[ViewHint.ANIMATING] &&\n      !hints[ViewHint.INTERACTING] &&\n      !isEmpty(renderedExtent)\n    ) {\n      vectorRenderer.useContainer(null, null);\n      const context = vectorRenderer.context;\n      const layerState = frameState.layerStatesArray[frameState.layerIndex];\n      const imageLayerState = Object.assign({}, layerState, {opacity: 1});\n      const imageFrameState = /** @type {import(\"../../Map.js\").FrameState} */ (\n        Object.assign({}, frameState, {\n          extent: renderedExtent,\n          size: [width, height],\n          viewState: /** @type {import(\"../../View.js\").State} */ (\n            Object.assign({}, frameState.viewState, {\n              rotation: 0,\n            })\n          ),\n          layerStatesArray: [imageLayerState],\n          layerIndex: 0,\n          declutter: null,\n        })\n      );\n      const declutter = this.getLayer().getDeclutter();\n      if (declutter) {\n        imageFrameState.declutter = {\n          [declutter]: new RBush(9),\n        };\n      }\n      const image = new ImageCanvas(\n        renderedExtent,\n        viewResolution,\n        pixelRatio,\n        context.canvas,\n        function (callback) {\n          if (\n            vectorRenderer.prepareFrame(imageFrameState) &&\n            vectorRenderer.replayGroupChanged\n          ) {\n            vectorRenderer.clipping = false;\n            vectorRenderer.renderFrame(imageFrameState, null);\n            vectorRenderer.renderDeclutter(imageFrameState);\n            vectorRenderer.renderDeferred(imageFrameState);\n            callback();\n          }\n        },\n      );\n\n      image.addEventListener(EventType.CHANGE, () => {\n        if (image.getState() !== ImageState.LOADED) {\n          return;\n        }\n        this.image = image;\n        const imagePixelRatio = image.getPixelRatio();\n        const renderedResolution =\n          (fromResolutionLike(image.getResolution()) * pixelRatio) /\n          imagePixelRatio;\n        this.renderedResolution = renderedResolution;\n        this.coordinateToVectorPixelTransform_ = compose(\n          this.coordinateToVectorPixelTransform_,\n          width / 2,\n          height / 2,\n          1 / renderedResolution,\n          -1 / renderedResolution,\n          0,\n          -viewState.center[0],\n          -viewState.center[1],\n        );\n      });\n      image.load();\n    }\n\n    if (this.image) {\n      this.renderedPixelToCoordinateTransform_ =\n        frameState.pixelToCoordinateTransform.slice();\n    }\n\n    return !this.getLayer().getSource()?.loading && !!this.image;\n  }\n\n  /**\n   * @override\n   */\n  preRender() {}\n\n  /**\n   * @override\n   */\n  postRender() {}\n\n  /**\n   */\n  renderDeclutter() {}\n\n  /**\n   * @param {import(\"../../coordinate.js\").Coordinate} coordinate Coordinate.\n   * @param {import(\"../../Map.js\").FrameState} frameState Frame state.\n   * @param {number} hitTolerance Hit tolerance in pixels.\n   * @param {import(\"../vector.js\").FeatureCallback<T>} callback Feature callback.\n   * @param {Array<import(\"../Map.js\").HitMatch<T>>} matches The hit detected matches with tolerance.\n   * @return {T|undefined} Callback result.\n   * @template T\n   * @override\n   */\n  forEachFeatureAtCoordinate(\n    coordinate,\n    frameState,\n    hitTolerance,\n    callback,\n    matches,\n  ) {\n    if (this.vectorRenderer_) {\n      return this.vectorRenderer_.forEachFeatureAtCoordinate(\n        coordinate,\n        frameState,\n        hitTolerance,\n        callback,\n        matches,\n      );\n    }\n    return super.forEachFeatureAtCoordinate(\n      coordinate,\n      frameState,\n      hitTolerance,\n      callback,\n      matches,\n    );\n  }\n}\n\nexport default CanvasVectorImageLayerRenderer;\n","/**\n * @module ol/layer/VectorImage\n */\nimport CanvasVectorImageLayerRenderer from '../renderer/canvas/VectorImageLayer.js';\nimport BaseVectorLayer from './BaseVector.js';\n\n/**\n * @template {import(\"../source/Vector.js\").default<FeatureType>} [VectorSourceType=import(\"../source/Vector.js\").default<*>]\n * @template {import('../Feature.js').FeatureLike} [FeatureType=import(\"./BaseVector.js\").ExtractedFeatureType<VectorSourceType>]\n * @typedef {Object} Options\n * @property {string} [className='ol-layer'] A CSS class name to set to the layer element.\n * @property {number} [opacity=1] Opacity (0, 1).\n * @property {boolean} [visible=true] Visibility.\n * @property {import(\"../extent.js\").Extent} [extent] The bounding extent for layer rendering.  The layer will not be\n * rendered outside of this extent.\n * @property {number} [zIndex] The z-index for layer rendering.  At rendering time, the layers\n * will be ordered, first by Z-index and then by position. When `undefined`, a `zIndex` of 0 is assumed\n * for layers that are added to the map's `layers` collection, or `Infinity` when the layer's `setMap()`\n * method was used.\n * @property {number} [minResolution] The minimum resolution (inclusive) at which this layer will be\n * visible.\n * @property {number} [maxResolution] The maximum resolution (exclusive) below which this layer will\n * be visible.\n * @property {number} [minZoom] The minimum view zoom level (exclusive) above which this layer will be\n * visible.\n * @property {number} [maxZoom] The maximum view zoom level (inclusive) at which this layer will\n * be visible.\n * @property {import(\"../render.js\").OrderFunction} [renderOrder] Render order. Function to be used when sorting\n * features before rendering. By default features are drawn in the order that they are created. Use\n * `null` to avoid the sort, but get an undefined draw order.\n * @property {number} [renderBuffer=100] The buffer in pixels around the viewport extent used by the\n * renderer when getting features from the vector source for the rendering or hit-detection.\n * Recommended value: the size of the largest symbol, line width or label.\n * @property {VectorSourceType} [source] Source.\n * @property {import(\"../Map.js\").default} [map] Sets the layer as overlay on a map. The map will not manage\n * this layer in its layers collection, and the layer will be rendered on top. This is useful for\n * temporary layers. The standard way to add a layer to a map and have it managed by the map is to\n * use [map.addLayer()]{@link import(\"../Map.js\").default#addLayer}.\n * @property {boolean|string|number} [declutter=false] Declutter images and text on this layer. Any truthy value will enable\n * decluttering. The priority is defined by the `zIndex` of the style and the render order of features. Higher z-index means higher\n * priority. Within the same z-index, a feature rendered before another has higher priority. Items will\n * not be decluttered against or together with items on other layers with the same `declutter` value. If\n * that is needed, use {@link import(\"../layer/Vector.js\").default} instead.\n * @property {import(\"../style/Style.js\").StyleLike|import(\"../style/flat.js\").FlatStyleLike|null} [style] Layer style. When set to `null`, only\n * features that have their own style will be rendered. See {@link module:ol/style/Style~Style} for the default style\n * which will be used if this is not set.\n * @property {import(\"./Base.js\").BackgroundColor} [background] Background color for the layer. If not specified, no background\n * will be rendered.\n * @property {number} [imageRatio=1] Ratio by which the rendered extent should be larger than the\n * viewport extent. A larger ratio avoids cut images during panning, but will cause a decrease in performance.\n * @property {Object<string, *>} [properties] Arbitrary observable properties. Can be accessed with `#get()` and `#set()`.\n */\n\n/**\n * @classdesc\n * Vector data is rendered client-side, to an image. This layer type provides great performance\n * during panning and zooming, but point symbols and texts are always rotated with the view and\n * pixels are scaled during zoom animations. For more accurate rendering of vector data, use\n * {@link module:ol/layer/Vector~VectorLayer} instead.\n *\n * Note that any property set in the options is set as a {@link module:ol/Object~BaseObject}\n * property on the layer object; for example, setting `title: 'My Title'` in the\n * options means that `title` is observable, and has get/set accessors.\n *\n * @template {import(\"../source/Vector.js\").default<FeatureType>} [VectorSourceType=import(\"../source/Vector.js\").default<*>]\n * @template {import('../Feature.js').FeatureLike} [FeatureType=import(\"./BaseVector.js\").ExtractedFeatureType<VectorSourceType>]\n * @extends {BaseVectorLayer<FeatureType, VectorSourceType, CanvasVectorImageLayerRenderer>}\n * @api\n */\nclass VectorImageLayer extends BaseVectorLayer {\n  /**\n   * @param {Options<VectorSourceType, FeatureType>} [options] Options.\n   */\n  constructor(options) {\n    options = options ? options : {};\n\n    const baseOptions = Object.assign({}, options);\n    delete baseOptions.imageRatio;\n    super(baseOptions);\n\n    /**\n     * @type {number}\n     * @private\n     */\n    this.imageRatio_ =\n      options.imageRatio !== undefined ? options.imageRatio : 1;\n  }\n\n  /**\n   * @return {number} Ratio between rendered extent size and viewport extent size.\n   */\n  getImageRatio() {\n    return this.imageRatio_;\n  }\n\n  /**\n   * @override\n   */\n  createRenderer() {\n    return new CanvasVectorImageLayerRenderer(this);\n  }\n}\n\nexport default VectorImageLayer;\n"],"names":["CanvasVectorImageLayerRenderer","CanvasImageLayerRenderer","layer","CanvasVectorLayerRenderer","create","pixel","vectorPixel","apply","frameState","pixelRatio","viewState","viewResolution","hints","vectorRenderer","renderedExtent","scaleFromCenter","width","getWidth","height","getHeight","ViewHint","isEmpty","context","layerState","imageLayerState","imageFrameState","declutter","RBush","image","ImageCanvas","callback","EventType","ImageState","imagePixelRatio","renderedResolution","fromResolutionLike","compose","coordinate","hitTolerance","matches","VectorImageLayer","BaseVectorLayer","options","baseOptions"],"mappings":"mlBAmBA,MAAMA,UAAuCC,CAAyB,CAIpE,YAAYC,EAAO,CACjB,MAAMA,CAAK,EAMX,KAAK,gBAAkB,IAAIC,EAA0BD,CAAK,EAM1D,KAAK,iBAAmBA,EAAM,cAAa,EAM3C,KAAK,kCAAoCE,EAAM,EAM/C,KAAK,oCAAsC,IAC7C,CAMA,iBAAkB,CAChB,KAAK,gBAAgB,QAAO,EAC5B,MAAM,gBAAe,CACvB,CAQA,YAAYC,EAAO,CACjB,GAAI,CAAC,KAAK,gBACR,OAAO,QAAQ,QAAQ,EAAE,EAE3B,MAAMC,EAAcC,EAClB,KAAK,kCACLA,EAAM,KAAK,oCAAqCF,EAAM,MAAK,CAAE,CACnE,EACI,OAAO,KAAK,gBAAgB,YAAYC,CAAW,CACrD,CAMA,oBAAqB,CACnB,KAAK,gBAAgB,mBAAkB,CACzC,CAQA,aAAaE,EAAY,CACvB,MAAMC,EAAaD,EAAW,WACxBE,EAAYF,EAAW,UACvBG,EAAiBD,EAAU,WAE3BE,EAAQJ,EAAW,UACnBK,EAAiB,KAAK,gBAC5B,IAAIC,EAAiBN,EAAW,OAC5B,KAAK,mBAAqB,IAC5BM,EAAiBA,EAAe,MAAM,CAAC,EACvCC,EAAgBD,EAAgB,KAAK,gBAAgB,GAEvD,MAAME,EAAQC,EAASH,CAAc,EAAIH,EACnCO,EAASC,EAAUL,CAAc,EAAIH,EAE3C,GACE,CAACC,EAAMQ,EAAS,SAAS,GACzB,CAACR,EAAMQ,EAAS,WAAW,GAC3B,CAACC,EAAQP,CAAc,EACvB,CACAD,EAAe,aAAa,KAAM,IAAI,EACtC,MAAMS,EAAUT,EAAe,QACzBU,EAAaf,EAAW,iBAAiBA,EAAW,UAAU,EAC9DgB,EAAkB,OAAO,OAAO,CAAA,EAAID,EAAY,CAAC,QAAS,CAAC,CAAC,EAC5DE,EACJ,OAAO,OAAO,CAAA,EAAIjB,EAAY,CAC5B,OAAQM,EACR,KAAM,CAACE,EAAOE,CAAM,EACpB,UACE,OAAO,OAAO,GAAIV,EAAW,UAAW,CACtC,SAAU,CACxB,CAAa,EAEH,iBAAkB,CAACgB,CAAe,EAClC,WAAY,EACZ,UAAW,IACrB,CAAS,EAEGE,EAAY,KAAK,SAAQ,EAAG,aAAY,EAC1CA,IACFD,EAAgB,UAAY,CAC1B,CAACC,CAAS,EAAG,IAAIC,EAAM,CAAC,CAClC,GAEM,MAAMC,EAAQ,IAAIC,EAChBf,EACAH,EACAF,EACAa,EAAQ,OACR,SAAUQ,EAAU,CAEhBjB,EAAe,aAAaY,CAAe,GAC3CZ,EAAe,qBAEfA,EAAe,SAAW,GAC1BA,EAAe,YAAYY,EAAiB,IAAI,EAChDZ,EAAe,gBAAgBY,CAAe,EAC9CZ,EAAe,eAAeY,CAAe,EAC7CK,EAAQ,EAEZ,CACR,EAEMF,EAAM,iBAAiBG,EAAU,OAAQ,IAAM,CAC7C,GAAIH,EAAM,aAAeI,EAAW,OAClC,OAEF,KAAK,MAAQJ,EACb,MAAMK,EAAkBL,EAAM,cAAa,EACrCM,EACHC,EAAmBP,EAAM,cAAa,CAAE,EAAInB,EAC7CwB,EACF,KAAK,mBAAqBC,EAC1B,KAAK,kCAAoCE,EACvC,KAAK,kCACLpB,EAAQ,EACRE,EAAS,EACT,EAAIgB,EACJ,GAAKA,EACL,EACA,CAACxB,EAAU,OAAO,CAAC,EACnB,CAACA,EAAU,OAAO,CAAC,CAC7B,CACM,CAAC,EACDkB,EAAM,KAAI,CACZ,CAEA,OAAI,KAAK,QACP,KAAK,oCACHpB,EAAW,2BAA2B,MAAK,GAGxC,CAAC,KAAK,WAAW,UAAS,GAAI,SAAW,CAAC,CAAC,KAAK,KACzD,CAKA,WAAY,CAAC,CAKb,YAAa,CAAC,CAId,iBAAkB,CAAC,CAYnB,2BACE6B,EACA7B,EACA8B,EACAR,EACAS,EACA,CACA,OAAI,KAAK,gBACA,KAAK,gBAAgB,2BAC1BF,EACA7B,EACA8B,EACAR,EACAS,CACR,EAEW,MAAM,2BACXF,EACA7B,EACA8B,EACAR,EACAS,CACN,CACE,CACF,CCrKA,MAAMC,UAAyBC,CAAgB,CAI7C,YAAYC,EAAS,CACnBA,EAAUA,GAAoB,CAAA,EAE9B,MAAMC,EAAc,OAAO,OAAO,CAAA,EAAID,CAAO,EAC7C,OAAOC,EAAY,WACnB,MAAMA,CAAW,EAMjB,KAAK,YACHD,EAAQ,aAAe,OAAYA,EAAQ,WAAa,CAC5D,CAKA,eAAgB,CACd,OAAO,KAAK,WACd,CAKA,gBAAiB,CACf,OAAO,IAAI1C,EAA+B,IAAI,CAChD,CACF","x_google_ignoreList":[0,1]}