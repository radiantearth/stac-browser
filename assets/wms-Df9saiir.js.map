{"version":3,"file":"wms-Df9saiir.js","sources":["../../node_modules/ol/source/wms.js"],"sourcesContent":["/**\n * @module ol/source/wms\n */\n\nimport {decode} from '../Image.js';\nimport {getForViewAndSize, getHeight, getWidth} from '../extent.js';\nimport {floor, round} from '../math.js';\nimport {get as getProjection} from '../proj.js';\nimport {compareVersions} from '../string.js';\nimport {appendParams} from '../uri.js';\nimport {getRequestExtent} from './Image.js';\nimport {DECIMALS} from './common.js';\n\n/**\n * Default WMS version.\n * @type {string}\n */\nexport const DEFAULT_VERSION = '1.3.0';\n\n/**\n * @const\n * @type {import(\"../size.js\").Size}\n */\nconst GETFEATUREINFO_IMAGE_SIZE = [101, 101];\n\n/**\n * @api\n * @typedef {'carmentaserver' | 'geoserver' | 'mapserver' | 'qgis'} ServerType\n * Set the server type to use implementation-specific parameters beyond the WMS specification.\n *  - `'carmentaserver'`: HiDPI support for [Carmenta Server](https://www.carmenta.com/en/products/carmenta-server)\n *  - `'geoserver'`: HiDPI support for [GeoServer](https://geoserver.org/)\n *  - `'mapserver'`: HiDPI support for [MapServer](https://mapserver.org/)\n *  - `'qgis'`: HiDPI support for [QGIS](https://qgis.org/)\n */\n\n/**\n * @param {string} baseUrl Base URL.\n * @param {import(\"../extent.js\").Extent} extent Extent.\n * @param {import(\"../size.js\").Size} size Size.\n * @param {import(\"../proj/Projection.js\").default} projection Projection.\n * @param {Object} params WMS params. Will be modified in place.\n * @return {string} Request URL.\n */\nexport function getRequestUrl(baseUrl, extent, size, projection, params) {\n  params['WIDTH'] = size[0];\n  params['HEIGHT'] = size[1];\n\n  const axisOrientation = projection.getAxisOrientation();\n  const v13 = compareVersions(params['VERSION'], '1.3') >= 0;\n  params[v13 ? 'CRS' : 'SRS'] = projection.getCode();\n  const bbox =\n    v13 && axisOrientation.startsWith('ne')\n      ? [extent[1], extent[0], extent[3], extent[2]]\n      : extent;\n  params['BBOX'] = bbox.join(',');\n\n  return appendParams(baseUrl, params);\n}\n\n/**\n * @param {import(\"../extent\").Extent} extent Extent.\n * @param {number} resolution Resolution.\n * @param {number} pixelRatio pixel ratio.\n * @param {import(\"../proj.js\").Projection} projection Projection.\n * @param {string} url WMS service url.\n * @param {Object} params WMS params.\n * @param {import(\"./wms.js\").ServerType} serverType The type of the remote WMS server.\n * @return {string} Image src.\n */\nexport function getImageSrc(\n  extent,\n  resolution,\n  pixelRatio,\n  projection,\n  url,\n  params,\n  serverType,\n) {\n  params = Object.assign({REQUEST: 'GetMap'}, params);\n\n  const imageResolution = resolution / pixelRatio;\n\n  const imageSize = [\n    round(getWidth(extent) / imageResolution, DECIMALS),\n    round(getHeight(extent) / imageResolution, DECIMALS),\n  ];\n\n  if (pixelRatio != 1) {\n    switch (serverType) {\n      case 'geoserver':\n        const dpi = (90 * pixelRatio + 0.5) | 0;\n        if ('FORMAT_OPTIONS' in params) {\n          params['FORMAT_OPTIONS'] += ';dpi:' + dpi;\n        } else {\n          params['FORMAT_OPTIONS'] = 'dpi:' + dpi;\n        }\n        break;\n      case 'mapserver':\n        params['MAP_RESOLUTION'] = 90 * pixelRatio;\n        break;\n      case 'carmentaserver':\n      case 'qgis':\n        params['DPI'] = 90 * pixelRatio;\n        break;\n      default:\n        throw new Error('Unknown `serverType` configured');\n    }\n  }\n\n  const src = getRequestUrl(url, extent, imageSize, projection, params);\n  return src;\n}\n\n/**\n * @param {Object} params WMS params.\n * @param {string} request WMS `REQUEST`.\n * @return {Object} WMS params with required properties set.\n */\nexport function getRequestParams(params, request) {\n  return Object.assign(\n    {\n      'REQUEST': request,\n      'SERVICE': 'WMS',\n      'VERSION': DEFAULT_VERSION,\n      'FORMAT': 'image/png',\n      'STYLES': '',\n      'TRANSPARENT': 'TRUE',\n    },\n    params,\n  );\n}\n\n/**\n * @typedef {Object} LoaderOptions\n * @property {null|string} [crossOrigin] The `crossOrigin` attribute for loaded images.  Note that\n * you must provide a `crossOrigin` value if you want to access pixel data with the Canvas renderer.\n * See https://developer.mozilla.org/en-US/docs/Web/HTML/CORS_enabled_image for more detail.\n * @property {boolean} [hidpi=true] Use the `ol/Map#pixelRatio` value when requesting\n * the image from the remote server.\n * @property {Object<string,*>} [params] WMS request parameters.\n * At least a `LAYERS` param is required. `STYLES` is\n * `''` by default. `VERSION` is `1.3.0` by default. `WIDTH`, `HEIGHT` and `BBOX` will be set\n * dynamically. `CRS` (`SRS` for WMS version < 1.3.0) will is derived from the `proection` config.\n * @property {import(\"../proj.js\").ProjectionLike} [projection] Projection. Default is 'EPSG:3857'.\n * @property {number} [ratio=1.5] Ratio. `1` means image requests are the size of the map viewport, `2` means\n * twice the width and height of the map viewport, and so on. Must be `1` or higher.\n * @property {import(\"./wms.js\").ServerType} [serverType] The type of\n * the remote WMS server: `mapserver`, `geoserver`, `carmentaserver`, or `qgis`.\n * Only needed if `hidpi` is `true`.\n * @property {string} url WMS service URL.\n * @property {function(HTMLImageElement, string): Promise<import('../DataTile.js').ImageLike>} [load] Function\n * to perform loading of the image. Receives the created `HTMLImageElement` and the desired `src` as argument and\n * returns a promise resolving to the loaded or decoded image. Default is {@link module:ol/Image.decode}.\n */\n\n/**\n * Creates a loader for WMS images.\n * @param {LoaderOptions} options Loader options.\n * @return {import(\"../Image.js\").ImageObjectPromiseLoader} Loader.\n * @api\n */\nexport function createLoader(options) {\n  const hidpi = options.hidpi === undefined ? true : options.hidpi;\n  const projection = getProjection(options.projection || 'EPSG:3857');\n  const ratio = options.ratio || 1.5;\n  const load = options.load || decode;\n  const crossOrigin = options.crossOrigin ?? null;\n\n  return (extent, resolution, pixelRatio) => {\n    extent = getRequestExtent(extent, resolution, pixelRatio, ratio);\n    if (pixelRatio != 1 && (!hidpi || options.serverType === undefined)) {\n      pixelRatio = 1;\n    }\n    const src = getImageSrc(\n      extent,\n      resolution,\n      pixelRatio,\n      projection,\n      options.url,\n      getRequestParams(options.params, 'GetMap'),\n      options.serverType,\n    );\n    const image = new Image();\n    image.crossOrigin = crossOrigin;\n    return load(image, src).then((image) => ({image, extent, pixelRatio}));\n  };\n}\n\n/**\n * Get the GetFeatureInfo URL for the passed coordinate and resolution. Returns `undefined` if the\n * GetFeatureInfo URL cannot be constructed.\n * @param {LoaderOptions} options Options passed the `createWMSLoader()` function. In addition to\n * the params required by the loader, `INFO_FORMAT` should be specified, it defaults to\n * `application/json`. If `QUERY_LAYERS` is not provided, then the layers specified in the `LAYERS`\n * parameter will be used.\n * @param {import(\"../coordinate.js\").Coordinate} coordinate Coordinate.\n * @param {number} resolution Resolution.\n * @return {string|undefined} GetFeatureInfo URL.\n * @api\n */\nexport function getFeatureInfoUrl(options, coordinate, resolution) {\n  if (options.url === undefined) {\n    return undefined;\n  }\n\n  const projectionObj = getProjection(options.projection || 'EPSG:3857');\n\n  const extent = getForViewAndSize(\n    coordinate,\n    resolution,\n    0,\n    GETFEATUREINFO_IMAGE_SIZE,\n  );\n\n  const baseParams = {\n    'QUERY_LAYERS': options.params['LAYERS'],\n    'INFO_FORMAT': 'application/json',\n  };\n  Object.assign(\n    baseParams,\n    getRequestParams(options.params, 'GetFeatureInfo'),\n    options.params,\n  );\n\n  const x = floor((coordinate[0] - extent[0]) / resolution, DECIMALS);\n  const y = floor((extent[3] - coordinate[1]) / resolution, DECIMALS);\n  const v13 = compareVersions(baseParams['VERSION'], '1.3') >= 0;\n  baseParams[v13 ? 'I' : 'X'] = x;\n  baseParams[v13 ? 'J' : 'Y'] = y;\n\n  return getRequestUrl(\n    options.url,\n    extent,\n    GETFEATUREINFO_IMAGE_SIZE,\n    projectionObj,\n    baseParams,\n  );\n}\n\n/**\n * Get the GetLegendGraphic URL, optionally optimized for the passed resolution and possibly\n * including any passed specific parameters. Returns `undefined` if the GetLegendGraphic URL\n * cannot be constructed.\n *\n * @param {LoaderOptions} options Options passed the `createWMSLoader()` function.\n * @param {number} [resolution] Resolution. If not provided, `SCALE` will not be calculated and\n * included in URL.\n * @return {string|undefined} GetLegendGraphic URL.\n * @api\n */\nexport function getLegendUrl(options, resolution) {\n  if (options.url === undefined) {\n    return undefined;\n  }\n\n  const baseParams = {\n    'SERVICE': 'WMS',\n    'VERSION': DEFAULT_VERSION,\n    'REQUEST': 'GetLegendGraphic',\n    'FORMAT': 'image/png',\n  };\n\n  if (resolution !== undefined) {\n    const mpu =\n      getProjection(options.projection || 'EPSG:3857').getMetersPerUnit() || 1;\n    const pixelSize = 0.00028;\n    baseParams['SCALE'] = (resolution * mpu) / pixelSize;\n  }\n\n  Object.assign(baseParams, options.params);\n\n  if (options.params !== undefined && baseParams['LAYER'] === undefined) {\n    const layers = baseParams['LAYERS'];\n    const isSingleLayer = !Array.isArray(layers) || layers.length !== 1;\n    if (!isSingleLayer) {\n      return undefined;\n    }\n    baseParams['LAYER'] = layers;\n  }\n\n  return appendParams(options.url, baseParams);\n}\n"],"names":["DEFAULT_VERSION","GETFEATUREINFO_IMAGE_SIZE","getRequestUrl","baseUrl","extent","size","projection","params","axisOrientation","v13","compareVersions","bbox","appendParams","getImageSrc","resolution","pixelRatio","url","serverType","imageResolution","imageSize","round","getWidth","DECIMALS","getHeight","dpi","getRequestParams","request","createLoader","options","hidpi","getProjection","ratio","load","decode","crossOrigin","getRequestExtent","src","image","getFeatureInfoUrl","coordinate","projectionObj","getForViewAndSize","baseParams","x","floor","y","getLegendUrl","mpu","pixelSize","layers"],"mappings":"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","x_google_ignoreList":[0]}