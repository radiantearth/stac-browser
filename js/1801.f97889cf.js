"use strict";(self["webpackChunk_radiantearth_stac_browser"]=self["webpackChunk_radiantearth_stac_browser"]||[]).push([[1801],{31801:function(e,t,r){var s=r(62703),i=r(90588),n=r(9438),a=r(70915),h=r(8055),o=r(38599),u=r(835),f=r(32627),c=r(88280),d=r(9703),l=r(4087),_=r(20259),p=r(63722),g=r(89940),m=r(90130),T=r(35339),b=r(60492),C=r(49189);class v extends b.A{constructor(e,t){const r=t.uniforms||{},s=(0,d.vt)();r[p.M8.PROJECTION_MATRIX]=s,super(e,{uniforms:r,postProcesses:t.postProcesses}),this.sourceRevision_=-1,this.verticesBuffer_=new _.Ay(m.H7,m.Be),this.indicesBuffer_=new _.Ay(m.IP,m.Be),this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.program_,this.hitDetectionEnabled_=t.hitDetectionEnabled??!0;const i=t.attributes?t.attributes.map(function(e){return{name:"a_"+e.name,size:1,type:p.jQ.FLOAT}}):[];this.attributes=[{name:"a_position",size:2,type:p.jQ.FLOAT},{name:"a_index",size:1,type:p.jQ.FLOAT}],this.hitDetectionEnabled_&&(this.attributes.push({name:"a_hitColor",size:4,type:p.jQ.FLOAT}),this.attributes.push({name:"a_featureUid",size:1,type:p.jQ.FLOAT})),this.attributes.push(...i),this.customAttributes=t.attributes?t.attributes:[],this.previousExtent_=(0,a.S5)(),this.currentTransform_=s,this.renderTransform_=(0,d.vt)(),this.invertRenderTransform_=(0,d.vt)(),this.renderInstructions_=new Float32Array(0),this.hitRenderTarget_,this.lastSentId=0,this.worker_=(0,T.v)(),this.worker_.addEventListener("message",e=>{const t=e.data;if(t.type===u.x.GENERATE_POINT_BUFFERS){const r=t.projectionTransform;this.verticesBuffer_.fromArrayBuffer(t.vertexBuffer),this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.fromArrayBuffer(t.indexBuffer),this.helper.flushBufferData(this.indicesBuffer_),this.renderTransform_=r,(0,d.T9)(this.invertRenderTransform_,this.renderTransform_),this.renderInstructions_=new Float32Array(e.data.renderInstructions),t.id===this.lastSentId&&(this.ready=!0),this.getLayer().changed()}}),this.featureCache_={},this.featureCount_=0;const h=this.getLayer().getSource();this.sourceListenKeys_=[(0,n.KT)(h,c["default"].ADDFEATURE,this.handleSourceFeatureAdded_,this),(0,n.KT)(h,c["default"].CHANGEFEATURE,this.handleSourceFeatureChanged_,this),(0,n.KT)(h,c["default"].REMOVEFEATURE,this.handleSourceFeatureDelete_,this),(0,n.KT)(h,c["default"].CLEAR,this.handleSourceFeatureClear_,this)],h.forEachFeature(e=>{const t=e.getGeometry();t&&"Point"===t.getType()&&(this.featureCache_[(0,l.v6)(e)]={feature:e,properties:e.getProperties(),flatCoordinates:t.getFlatCoordinates()},this.featureCount_++)})}afterHelperCreated(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new g.A(this.helper)),this.verticesBuffer_.getArray()&&this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.getArray()&&this.helper.flushBufferData(this.indicesBuffer_)}handleSourceFeatureAdded_(e){const t=e.feature,r=t.getGeometry();r&&"Point"===r.getType()&&(this.featureCache_[(0,l.v6)(t)]={feature:t,properties:t.getProperties(),flatCoordinates:r.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureChanged_(e){const t=e.feature,r=(0,l.v6)(t),s=this.featureCache_[r],i=t.getGeometry();s?i&&"Point"===i.getType()?(s.properties=t.getProperties(),s.flatCoordinates=i.getFlatCoordinates()):(delete this.featureCache_[r],this.featureCount_--):i&&"Point"===i.getType()&&(this.featureCache_[r]={feature:t,properties:t.getProperties(),flatCoordinates:i.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureDelete_(e){const t=e.feature,r=(0,l.v6)(t);r in this.featureCache_&&(delete this.featureCache_[r],this.featureCount_--)}handleSourceFeatureClear_(){this.featureCache_={},this.featureCount_=0}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[r,s,i]=(0,C.v)(e,this.getLayer());this.renderWorlds(e,!1,r,s,i),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent),this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,r,s,i),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e);const n=this.helper.getCanvas();return n}prepareFrameInternal(e){const t=this.getLayer(),r=t.getSource(),i=e.viewState,n=!e.viewHints[s.A.ANIMATING]&&!e.viewHints[s.A.INTERACTING],o=!(0,a.aI)(this.previousExtent_,e.extent),u=this.sourceRevision_<r.getRevision();if(u&&(this.sourceRevision_=r.getRevision()),n&&(o||u)){const s=i.projection,n=i.resolution,o=t instanceof h["default"]?t.getRenderBuffer():0,u=(0,a.r)(e.extent,o*n);r.loadFeatures(u,n,s),this.rebuildBuffers_(e),this.previousExtent_=e.extent.slice()}return this.helper.useProgram(this.program_,e),this.helper.prepareDraw(e),this.helper.bindBuffer(this.verticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),this.helper.enableAttributes(this.attributes),!0}rebuildBuffers_(e){const t=(0,d.vt)();this.helper.makeProjectionTransform(e,t);const r=(0,o.Tf)(),s=this.hitDetectionEnabled_?7:2,i=s+this.customAttributes.length,n=i*this.featureCount_,a=this.renderInstructions_&&this.renderInstructions_.length===n?this.renderInstructions_:new Float32Array(n);this.renderInstructions_=null;let h=[];const c=[];let l=-1;const _=e.viewState.projection;for(const u in this.featureCache_){const e=this.featureCache_[u];if(r?h=(0,o.Ad)(e.flatCoordinates,_):(h[0]=e.flatCoordinates[0],h[1]=e.flatCoordinates[1]),(0,d.Bb)(t,h),a[++l]=h[0],a[++l]=h[1],this.hitDetectionEnabled_){const e=(0,f.bA)(l+5,c);a[++l]=e[0],a[++l]=e[1],a[++l]=e[2],a[++l]=e[3],a[++l]=Number(u)}for(let t=0;t<this.customAttributes.length;t++){const r=this.customAttributes[t].callback(e.feature,e.properties);a[++l]=r}}const p={id:++this.lastSentId,type:u.x.GENERATE_POINT_BUFFERS,renderInstructions:a.buffer,customAttributesSize:i-2};p["projectionTransform"]=t,this.ready=!1,this.worker_.postMessage(p,[a.buffer])}forEachFeatureAtCoordinate(e,t,r,s,n){if((0,i.v)(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.renderInstructions_||!this.hitDetectionEnabled_)return;const a=(0,d.Bb)(t.coordinateToPixelTransform,e.slice()),h=this.hitRenderTarget_.readPixel(a[0]/2,a[1]/2),o=[h[0]/255,h[1]/255,h[2]/255,h[3]/255],u=(0,f.LW)(o),c=this.renderInstructions_[u],l=Math.floor(c).toString(),_=this.getLayer().getSource(),p=_.getFeatureByUid(l);return p?s(p,this.getLayer(),null):void 0}renderWorlds(e,t,r,s,i){let n=r;this.helper.useProgram(this.program_,e),t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0)),this.helper.bindBuffer(this.verticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),this.helper.enableAttributes(this.attributes);do{this.helper.makeProjectionTransform(e,this.currentTransform_),(0,d.Tl)(this.currentTransform_,n*i,0),(0,d.lw)(this.currentTransform_,this.invertRenderTransform_),this.helper.applyUniforms(e),this.helper.applyHitDetectionUniform(t);const r=this.indicesBuffer_.getSize();this.helper.drawElements(0,r)}while(++n<s)}disposeInternal(){this.worker_.terminate(),this.sourceListenKeys_.forEach(function(e){(0,n.JH)(e)}),this.sourceListenKeys_=null,super.disposeInternal()}renderDeclutter(){}}t.A=v},49189:function(e,t,r){r.d(t,{v:function(){return i}});var s=r(70915);function i(e,t){const r=e.viewState.projection,i=t.getSource(),n=i.getWrapX()&&r.canWrapX(),a=r.getExtent(),h=e.extent,o=n?(0,s.RG)(a):null,u=n?Math.ceil((h[2]-a[2])/o)+1:1,f=n?Math.floor((h[0]-a[0])/o):0;return[f,u,o]}}}]);
//# sourceMappingURL=1801.f97889cf.js.map